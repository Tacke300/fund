<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bot Arbitrage UI - Dark Theme</title>
    <style>
        /* Global Styles */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #1a1a2e; /* Very dark blue-purple for background */
            color: #e0e0e0; /* Light grey for main text */
            margin: 0;
            padding: 20px;
            line-height: 1.6;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
        }

        .container {
            max-width: 900px; /* Gi·∫£m max-width ƒë·ªÉ tr√¥ng g·ªçn h∆°n theo chi·ªÅu d·ªçc */
            width: 100%;
            margin: 20px auto;
            background-color: #2e304b; /* Slightly lighter dark blue-purple for main container */
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.5);
            padding: 30px 40px;
            box-sizing: border-box;
        }

        h1, h2 {
            color: #9a67ea; /* Primary purple for headings */
            text-align: center;
            margin-bottom: 30px;
            font-weight: 600;
            font-size: 2.2em; /* K√≠ch th∆∞·ªõc ch·ªØ h1 */
        }
        h2 {
            font-size: 1.8em; /* K√≠ch th∆∞·ªõc ch·ªØ h2 */
        }
        h3 {
            font-size: 1.5em; /* K√≠ch th∆∞·ªõc ch·ªØ h3 (ti√™u ƒë·ªÅ card) */
            color: #9a67ea;
            margin-top: 0;
            border-bottom: 1px solid rgba(154, 103, 234, 0.2);
            padding-bottom: 12px;
            margin-bottom: 20px;
            font-weight: 500;
        }


        /* Control Buttons and Input */
        .controls {
            text-align: center;
            margin-bottom: 40px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            gap: 20px; /* Space between items */
        }

        .controls label {
            font-size: 1.1em; /* K√≠ch th∆∞·ªõc ch·ªØ label */
            color: #e0e0e0;
            margin-right: 10px;
            text-align: left;
            width: 100%;
            margin-bottom: 5px;
        }

        .controls input[type="number"], .controls select {
            padding: 10px 15px;
            font-size: 1em; /* K√≠ch th∆∞·ªõc ch·ªØ input/select */
            border: 1px solid #5a5d7e;
            border-radius: 8px;
            background-color: #3e405e;
            color: #e0e0e0;
            text-align: center;
            -moz-appearance: textfield;
            appearance: none;
            cursor: pointer;
        }
        .controls input[type="number"] {
            width: 80px;
        }

        .controls select {
            width: 120px;
            text-align-last: center;
            text-align: center;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            width: 100%;
            justify-content: center;
        }

        .controls button {
            padding: 14px 30px;
            font-size: 1.1em; /* K√≠ch th∆∞·ªõc ch·ªØ button */
            font-weight: bold;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            color: #fff;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        #startBotBtn {
            background-color: #9a67ea; /* Purple for Start */
            box-shadow: 0 4px 10px rgba(154, 103, 234, 0.4);
        }
        #startBotBtn:hover {
            background-color: #7d4fd9;
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(154, 103, 234, 0.6);
        }

        #stopBotBtn {
            background-color: #ef5350; /* Red for Stop */
            box-shadow: 0 4px 10px rgba(239, 83, 80, 0.4);
        }
        #stopBotBtn:hover {
            background-color: #d32f2f;
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(239, 83, 80, 0.6);
        }

        /* Style for Test Order Button */
        #testOrderBtn {
            background-color: #50bfa4; /* A teal/green color */
            box-shadow: 0 4px 10px rgba(80, 191, 164, 0.4);
            flex-grow: 1;
        }
        #testOrderBtn:hover {
            background-color: #3aa08a;
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(80, 191, 164, 0.6);
        }

        /* Style for Stop Test Trade Button */
        #stopTestTradeBtn {
            background-color: #f1c40f; /* Yellow/Orange for Stop Test */
            color: #333; /* Dark text for contrast */
            box-shadow: 0 4px 10px rgba(241, 196, 15, 0.4);
            flex-grow: 1;
        }
        #stopTestTradeBtn:hover {
            background-color: #e6b100;
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(241, 196, 15, 0.6);
        }


        /* Status Cards Layout */
        .status-cards {
            display: flex;
            flex-direction: column;
            gap: 25px;
            margin-bottom: 40px;
        }

        .card {
            background-color: #3e405e;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(154, 103, 234, 0.3);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .card p {
            margin: 10px 0;
            color: #abb2bf;
            font-size: 1em;
        }

        .opportunity-details p {
            margin: 5px 0;
            font-size: 0.95em;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px dashed rgba(154, 103, 234, 0.1);
            padding-bottom: 5px;
        }
        .opportunity-details p:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }

        .opportunity-details strong {
            flex: 0 0 160px;
            margin-right: 10px;
            color: #e0e0e0;
            text-align: left;
        }
        .opportunity-details span {
            flex: 1;
            color: #abb2bf;
            text-align: right;
        }


        /* Trade History Table */
        .trade-history table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 20px;
            background-color: #3e405e;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .trade-history th, .trade-history td {
            padding: 15px 20px;
            text-align: left;
            border-bottom: 1px solid rgba(154, 103, 234, 0.2);
            color: #abb2bf;
        }

        .trade-history th {
            background-color: #4a4c6a;
            color: #e0e0e0;
            font-weight: bold;
            text-transform: uppercase;
            font-size: 0.9em;
            letter-spacing: 0.5px;
        }
        .trade-history td {
            font-size: 0.9em;
        }

        /* Utility Classes for Text Colors */
        .text-green { color: #50fa7b; }
        .text-red { color: #ff5555; }
        .text-yellow { color: #f1fa8c; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üìà Bot Arbitrage Trading</h1>
        </header>

        <main>
            <section class="controls">
                <div class="control-group">
                    <label for="percentageToUse">Ph·∫ßn trƒÉm v·ªën m·ªü l·ªánh (%):</label>
                    <input type="number" id="percentageToUse" value="50" min="1" max="100">
                </div>

                <div class="control-group">
                    <label for="shortExchangeSelect">S√†n SHORT Test:</label>
                    <select id="shortExchangeSelect"></select>
                </div>

                <div class="control-group">
                    <label for="longExchangeSelect">S√†n LONG Test:</label>
                    <select id="longExchangeSelect"></select>
                </div>

                <div style="width: 100%;">
                    <button id="startBotBtn">‚ñ∂Ô∏è Start Bot</button>
                    <button id="stopBotBtn">‚è∏Ô∏è Stop Bot</button>
                </div>
                
                <div class="button-group">
                    <button id="testOrderBtn">‚ö° Test M·ªü L·ªánh</button>
                    <button id="stopTestTradeBtn">üõë D·ª´ng L·ªánh Test</button>
                </div>
            </section>

            <section class="status-cards">
                <!-- Bot State Card -->
                <div class="card" id="botStateCard">
                    <h3>Tr·∫°ng th√°i Bot</h3>
                    <p>Hi·ªán t·∫°i: <strong id="botStateDisplay">ƒêang t·∫£i...</strong></p>
                </div>

                <!-- Balances Card -->
                <div class="card">
                    <h3>S·ªë d∆∞ T√†i kho·∫£n</h3>
                    <div id="balancesDisplay">
                        <p>ƒêang t·∫£i s·ªë d∆∞...</p>
                    </div>
                </div>

                <!-- Cumulative PnL Card -->
                <div class="card">
                    <h3>PnL T·ªïng h·ª£p</h3>
                    <p>T·ªïng PnL t·ª´ khi ch·∫°y: <strong id="cumulativePnlDisplay" class="text-yellow">ƒêang t·∫£i...</strong></p>
                </div>

                <!-- Current Selected Opportunity Card (for display) -->
                <div class="card">
                    <h3>C∆° h·ªôi Arbitrage T·ªët nh·∫•t (D·ª± ki·∫øn)</h3>
                    <div id="bestPotentialOpportunityDisplay" class="opportunity-details">
                        <p>Kh√¥ng c√≥ c∆° h·ªôi n√†o kh·∫£ d·ª•ng.</p>
                    </div>
                </div>

            </section>

            <section class="trade-history">
                <h2>L·ªãch s·ª≠ Giao d·ªãch</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Th·ªùi gian</th>
                            <th>Coin</th>
                            <th>S√†n giao d·ªãch</th>
                            <th>Funding Diff</th>
                            <th>PnL ∆∞·ªõc t√≠nh</th>
                            <th>PnL th·ª±c t·∫ø</th>
                        </tr>
                    </thead>
                    <tbody id="tradeHistoryBody">
                        <tr>
                            <td colspan="6" style="text-align: center; font-style: italic;">ƒêang t·∫£i l·ªãch s·ª≠ giao d·ªãch...</td>
                        </tr>
                    </tbody>
                </table>
            </section>
        </main>
    </div>

    <script>
        const EXCHANGE_DISPLAY_NAMES = {
            'binanceusdm': 'Binance',
            'bingx': 'BingX',
            'okx': 'OKX',
            'bitget': 'Bitget',
            'kucoin': 'KuCoin'
        };

        // H√†m ƒë·ªÉ l·∫•y v√† c·∫≠p nh·∫≠t tr·∫°ng th√°i bot t·ª´ server
        async function updateBotStatus() {
            try {
                const response = await fetch('/bot-api/status');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();

                // C·∫≠p nh·∫≠t tr·∫°ng th√°i Bot
                const botStateDisplay = document.getElementById('botStateDisplay');
                botStateDisplay.textContent = data.botState;
                botStateDisplay.className = '';
                if (data.botState === 'RUNNING') {
                    botStateDisplay.classList.add('text-green');
                } else if (data.botState === 'STOPPED') {
                    botStateDisplay.classList.add('text-red');
                } else {
                    botStateDisplay.classList.add('text-yellow');
                }

                // C·∫≠p nh·∫≠t Dropdowns (Ch·ªâ ch·∫°y l·∫ßn ƒë·∫ßu ho·∫∑c khi c·∫ßn)
                if (document.getElementById('shortExchangeSelect').options.length === 0) {
                    populateExchangeDropdowns(data.activeExchangeIds);
                }

                // C·∫≠p nh·∫≠t s·ªë d∆∞ t√†i kho·∫£n
                let balancesHtml = '';
                if (data.balances) {
                    for (const exchangeId in data.balances) {
                        const bal = data.balances[exchangeId];
                        const availableBalanceColorClass = bal.available < 0 ? 'text-red' : 'text-green'; 
                        
                        balancesHtml += `<p><strong>${(EXCHANGE_DISPLAY_NAMES[exchangeId] || exchangeId).toUpperCase()}:</strong> Kh·∫£ d·ª•ng <span class="${availableBalanceColorClass}">${bal.available.toFixed(2)} USDT</span></p>`;
                    }
                }
                document.getElementById('balancesDisplay').innerHTML = balancesHtml;

                // C·∫≠p nh·∫≠t PnL t·ªïng h·ª£p (L∆∞u √Ω: bot.js hi·ªán kh√¥ng t√≠nh PnL)
                const cumulativePnlElement = document.getElementById('cumulativePnlDisplay');
                cumulativePnlElement.textContent = 'N/A USDT (Logic PnL ƒëang ƒë∆∞·ª£c tri·ªÉn khai)'; 

                // C·∫≠p nh·∫≠t c∆° h·ªôi arbitrage t·ªët nh·∫•t (d·ª± ki·∫øn)
                const bestPotentialOpportunityDisplayDiv = document.getElementById('bestPotentialOpportunityDisplay');
                if (data.bestPotentialOpportunityForDisplay) {
                    const op = data.bestPotentialOpportunityForDisplay;
                    const nextFundingDate = new Date(op.nextFundingTime);
                    const fundingTimeFormatted = nextFundingDate.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit', hour12: false });
                    const fundingDateFormatted = nextFundingDate.toLocaleDateString('vi-VN');

                    // L·∫•y Short/Long Exchange d·ª±a tr√™n t√™n ƒë√£ chu·∫©n h√≥a
                    let shortExchangeName = EXCHANGE_DISPLAY_NAMES[op.details.shortExchange] || op.details.shortExchange;
                    let longExchangeName = EXCHANGE_DISPLAY_NAMES[op.details.longExchange] || op.details.longExchange;

                    bestPotentialOpportunityDisplayDiv.innerHTML = `
                        <p><strong>Coin:</strong> <span>${op.coin}</span></p>
                        <p><strong>S√†n:</strong> <span>${op.exchanges}</span></p>
                        <p><strong>PnL ∆∞·ªõc t√≠nh:</strong> <span>${op.estimatedPnl?.toFixed(2) || 'N/A'}%</span></p>
                        <p><strong>T·ªõi gi·ªù funding:</strong> <span>${fundingTimeFormatted} ng√†y ${fundingDateFormatted}</span></p>
                        <p><strong>Max Lev chung:</strong> <span>${op.commonLeverage || 'N/A'}x</span></p>
                        <p><strong>S√†n Short:</strong> <span>${shortExchangeName} </span></p>
                        <p><strong>S√†n Long:</strong> <span>${longExchangeName} </span></p>
                    `;
                } else {
                    bestPotentialOpportunityDisplayDiv.textContent = 'Kh√¥ng c√≥ c∆° h·ªôi n√†o kh·∫£ d·ª•ng.';
                }

                // C·∫≠p nh·∫≠t l·ªãch s·ª≠ giao d·ªãch (ƒê√£ lo·∫°i b·ªè logic PNL c≈©)
                const tradeHistoryBody = document.getElementById('tradeHistoryBody');
                tradeHistoryBody.innerHTML = '<tr><td colspan="6" style="text-align: center; font-style: italic;">Ch∆∞a c√≥ l·ªãch s·ª≠ giao d·ªãch (ƒêang ch·ªù t√≠nh to√°n PnL m·ªõi).</td></tr>';

            } catch (error) {
                console.error('L·ªói khi l·∫•y tr·∫°ng th√°i bot:', error);
                document.getElementById('botStateDisplay').textContent = 'L·ªñI K·∫æT N·ªêI';
                document.getElementById('botStateDisplay').classList.add('text-red');
            }
        }

        function populateExchangeDropdowns(activeIds) {
            const shortSelect = document.getElementById('shortExchangeSelect');
            const longSelect = document.getElementById('longExchangeSelect');

            const ids = activeIds || [];
            
            // Clear existing options
            shortSelect.innerHTML = '';
            longSelect.innerHTML = '';

            ids.forEach(id => {
                const displayName = EXCHANGE_DISPLAY_NAMES[id] || id.toUpperCase();

                const shortOption = document.createElement('option');
                shortOption.value = id;
                shortOption.textContent = displayName;
                shortSelect.appendChild(shortOption);

                const longOption = document.createElement('option');
                longOption.value = id;
                longOption.textContent = displayName;
                longSelect.appendChild(longOption);
            });
        }


        // Event Listeners
        document.getElementById('startBotBtn').addEventListener('click', async () => {
            const percentageToUse = document.getElementById('percentageToUse').value;
            try {
                const response = await fetch('/bot-api/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ percentageToUse: parseFloat(percentageToUse) }) 
                });
                const data = await response.json();
                alert(data.message || 'Thao t√°c th√†nh c√¥ng.');
                if (data.success) updateBotStatus();
            } catch (error) {
                alert('L·ªói khi kh·ªüi ƒë·ªông bot.');
            }
        });

        document.getElementById('stopBotBtn').addEventListener('click', async () => {
            try {
                const response = await fetch('/bot-api/stop', { method: 'POST' });
                const data = await response.json();
                alert(data.message || 'Thao t√°c th√†nh c√¥ng.');
                if (data.success) updateBotStatus();
            } catch (error) {
                alert('L·ªói khi d·ª´ng bot.');
            }
        });

        document.getElementById('testOrderBtn').addEventListener('click', async () => {
            const percentageToUse = document.getElementById('percentageToUse').value;
            const shortExchange = document.getElementById('shortExchangeSelect').value;
            const longExchange = document.getElementById('longExchangeSelect').value;

            if (!shortExchange || !longExchange) {
                alert('Vui l√≤ng ch·ªçn c·∫£ S√†n SHORT v√† S√†n LONG ƒë·ªÉ Test.');
                return;
            }
            if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën m·ªü l·ªánh TEST ngay l·∫≠p t·ª©c kh√¥ng?')) return;

            try {
                const response = await fetch('/bot-api/test-trade', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        percentageToUse: parseFloat(percentageToUse),
                        shortExchange: shortExchange,
                        longExchange: longExchange
                    })
                });
                const data = await response.json();
                alert(data.message);
                if (data.success) updateBotStatus();
            } catch (error) {
                alert('L·ªói khi th·ª±c hi·ªán l·ªánh test.');
            }
        });

        document.getElementById('stopTestTradeBtn').addEventListener('click', async () => {
            if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ƒë√≥ng L·ªÜNH ƒêANG M·ªû (bao g·ªìm c·∫£ l·ªánh test) kh√¥ng?')) return;
            try {
                const response = await fetch('/bot-api/stop-test-trade', { method: 'POST' });
                const data = await response.json();
                alert(data.message);
                if (data.success) updateBotStatus();
            } catch (error) {
                alert('L·ªói khi d·ª´ng l·ªánh.');
            }
        });

        // T·∫£i tr·∫°ng th√°i ban ƒë·∫ßu khi trang ƒë∆∞·ª£c load
        document.addEventListener('DOMContentLoaded', () => {
            updateBotStatus();
            setInterval(updateBotStatus, 5000); 
        });
    </script>
</body>
</html>
