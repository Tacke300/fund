<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bot Arbitrage UI - Dark Theme</title>
    <style>
        /* Global Styles */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #1a1a2e; /* Very dark blue-purple for background */
            color: #e0e0e0; /* Light grey for main text */
            margin: 0;
            padding: 20px;
            line-height: 1.6;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            width: 100%;
            margin: 20px auto;
            background-color: #2e304b; /* Slightly lighter dark blue-purple for main container */
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.5);
            padding: 30px 40px;
            box-sizing: border-box;
        }

        h1, h2 {
            color: #9a67ea; /* Primary purple for headings */
            text-align: center;
            margin-bottom: 30px;
            font-weight: 600;
        }

        /* Control Buttons and Input */
        .controls {
            text-align: center;
            margin-bottom: 40px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            gap: 20px; /* Space between items */
        }

        .controls label {
            font-size: 1.1em;
            color: #e0e0e0;
            margin-right: 10px;
        }

        .controls input[type="number"] {
            padding: 10px 15px;
            font-size: 1em;
            border: 1px solid #5a5d7e;
            border-radius: 8px;
            background-color: #3e405e;
            color: #e0e0e0;
            width: 80px;
            text-align: center;
            -moz-appearance: textfield; /* Hide arrows for Firefox */
        }
        .controls input[type="number"]::-webkit-outer-spin-button,
        .controls input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .controls button {
            padding: 14px 30px;
            font-size: 1.2em;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            margin: 0 5px; /* Adjust margin for buttons */
            color: #fff;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        #startBotBtn {
            background-color: #9a67ea; /* Purple for Start */
            box-shadow: 0 4px 10px rgba(154, 103, 234, 0.4);
        }
        #startBotBtn:hover {
            background-color: #7d4fd9;
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(154, 103, 234, 0.6);
        }

        #stopBotBtn {
            background-color: #ef5350; /* Red for Stop */
            box-shadow: 0 4px 10px rgba(239, 83, 80, 0.4);
        }
        #stopBotBtn:hover {
            background-color: #d32f2f;
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(239, 83, 80, 0.6);
        }

        /* Status Cards Grid */
        .status-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .card {
            background-color: #3e405e; /* Lighter dark blue-purple for cards */
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(154, 103, 234, 0.3); /* Purple tinted border */
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.4);
        }

        .card h3 {
            color: #9a67ea; /* Purple for card titles */
            margin-top: 0;
            border-bottom: 1px solid rgba(154, 103, 234, 0.2);
            padding-bottom: 12px;
            margin-bottom: 20px;
            font-size: 1.4em;
            font-weight: 500;
        }

        .card p {
            margin: 10px 0;
            color: #abb2bf; /* Grey text for card content */
        }

        .card strong {
            color: #e0e0e0; /* Brighter grey for strong text */
        }

        .card pre {
            background-color: #282c34; /* Darker background for code/JSON blocks */
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            font-size: 0.9em;
            color: #c0c5d2;
            word-wrap: break-word; /* Ensure long lines wrap */
            white-space: pre-wrap; /* Ensure preformatted text wraps */
        }

        /* Styling for the new "Best Potential Opportunity" display */
        .opportunity-details p {
            margin: 5px 0;
            font-size: 0.95em;
            display: flex; /* For horizontal layout */
            justify-content: space-between; /* Space out label and value */
            align-items: center;
            border-bottom: 1px dashed rgba(154, 103, 234, 0.1); /* Subtle separator */
            padding-bottom: 5px;
        }
        .opportunity-details p:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }

        .opportunity-details strong {
            flex: 0 0 160px; /* Fixed width for labels */
            margin-right: 10px;
            color: #e0e0e0;
            text-align: left;
        }
        .opportunity-details span {
            flex: 1; /* Take remaining space */
            color: #abb2bf;
            text-align: right;
        }


        /* Trade History Table */
        .trade-history h2 {
            margin-bottom: 20px;
        }

        .trade-history table {
            width: 100%;
            border-collapse: separate; /* Use separate for rounded corners on rows */
            border-spacing: 0;
            margin-top: 20px;
            background-color: #3e405e; /* Same as card background */
            border-radius: 10px;
            overflow: hidden; /* Ensures rounded corners are visible */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .trade-history th, .trade-history td {
            padding: 15px 20px;
            text-align: left;
            border-bottom: 1px solid rgba(154, 103, 234, 0.2);
            color: #abb2bf;
        }

        .trade-history th {
            background-color: #4a4c6a; /* Darker grey-purple for table headers */
            color: #e0e0e0;
            font-weight: bold;
            text-transform: uppercase;
            font-size: 0.95em;
            letter-spacing: 0.5px;
        }

        .trade-history tbody tr:last-child td {
            border-bottom: none; /* No border for the last row */
        }

        .trade-history tbody tr:hover {
            background-color: #4a4c6a; /* Hover effect for table rows */
            cursor: pointer;
        }

        /* Utility Classes for Text Colors */
        .text-green { color: #50fa7b; } /* Bright green for positive values/running status */
        .text-red { color: #ff5555; } /* Red for negative values/stopped status */
        .text-yellow { color: #f1fa8c; } /* Yellow for warnings/pending status */
        .text-purple { color: #bd93f9; } /* Lighter purple for specific highlights */

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            .controls {
                flex-direction: column;
                gap: 15px;
            }
            .controls button {
                margin: 0; /* Remove horizontal margin */
                width: 100%; /* Full width buttons */
            }
            .controls input[type="number"] {
                width: 100%;
            }
            .status-cards {
                grid-template-columns: 1fr; /* Single column on small screens */
            }
            .opportunity-details strong {
                flex: 0 0 120px;
            }
            .trade-history th, .trade-history td {
                padding: 10px 15px;
                font-size: 0.9em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üìà Bot Arbitrage Trading</h1>
        </header>

        <main>
            <section class="controls">
                <div>
                    <label for="percentageToUse">Ph·∫ßn trƒÉm v·ªën m·ªü l·ªánh (%):</label>
                    <input type="number" id="percentageToUse" value="50" min="1" max="100">
                </div>
                <button id="startBotBtn">‚ñ∂Ô∏è Start Bot</button>
                <button id="stopBotBtn">‚è∏Ô∏è Stop Bot</button>
            </section>

            <section class="status-cards">
                <!-- Bot State Card -->
                <div class="card" id="botStateCard">
                    <h3>Tr·∫°ng th√°i Bot</h3>
                    <p>Hi·ªán t·∫°i: <strong id="botStateDisplay">ƒêang t·∫£i...</strong></p>
                </div>

                <!-- Balances Card -->
                <div class="card">
                    <h3>S·ªë d∆∞ T√†i kho·∫£n</h3>
                    <div id="balancesDisplay">
                        <p>ƒêang t·∫£i s·ªë d∆∞...</p>
                    </div>
                </div>

                <!-- Cumulative PnL Card -->
                <div class="card">
                    <h3>PnL T·ªïng h·ª£p</h3>
                    <p>T·ªïng PnL t·ª´ khi ch·∫°y: <strong id="cumulativePnlDisplay" class="text-yellow">ƒêang t·∫£i...</strong></p>
                </div>

                <!-- Current Selected Opportunity Card (for display) -->
                <div class="card">
                    <h3>C∆° h·ªôi Arbitrage T·ªët nh·∫•t (D·ª± ki·∫øn)</h3>
                    <div id="bestPotentialOpportunityDisplay" class="opportunity-details">
                        <p>Kh√¥ng c√≥ c∆° h·ªôi n√†o kh·∫£ d·ª•ng.</p>
                    </div>
                </div>

                <!-- NOTE: "Giao d·ªãch ƒêang m·ªü" ƒë√£ ƒë∆∞·ª£c g·ª° b·ªè theo y√™u c·∫ßu c·ªßa b·∫°n -->
            </section>

            <section class="trade-history">
                <h2>L·ªãch s·ª≠ Giao d·ªãch</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Th·ªùi gian</th>
                            <th>Coin</th>
                            <th>S√†n giao d·ªãch</th>
                            <th>Funding Diff</th>
                            <th>PnL ∆∞·ªõc t√≠nh</th>
                            <th>PnL th·ª±c t·∫ø</th>
                        </tr>
                    </thead>
                    <tbody id="tradeHistoryBody">
                        <tr>
                            <td colspan="6" style="text-align: center; font-style: italic;">ƒêang t·∫£i l·ªãch s·ª≠ giao d·ªãch...</td>
                        </tr>
                    </tbody>
                </table>
            </section>
        </main>
    </div>

    <script>
        // H√†m ƒë·ªÉ l·∫•y v√† c·∫≠p nh·∫≠t tr·∫°ng th√°i bot t·ª´ server
        async function updateBotStatus() {
            try {
                const response = await fetch('/bot-api/status');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                // console.log('Bot status data received:', data); // Gi·ªØ l·∫°i ƒë·ªÉ debug n·∫øu c·∫ßn

                // C·∫≠p nh·∫≠t tr·∫°ng th√°i Bot
                const botStateDisplay = document.getElementById('botStateDisplay');
                botStateDisplay.textContent = data.botState;
                botStateDisplay.className = ''; // Reset classes
                if (data.botState === 'RUNNING') {
                    botStateDisplay.classList.add('text-green');
                } else if (data.botState === 'STOPPED') {
                    botStateDisplay.classList.add('text-red');
                } else {
                    botStateDisplay.classList.add('text-yellow');
                }

                // C·∫≠p nh·∫≠t s·ªë d∆∞ t√†i kho·∫£n
                let balancesHtml = '';
                if (data.balances) {
                    for (const exchangeId in data.balances) {
                        if (exchangeId === 'totalOverall') continue; 
                        const bal = data.balances[exchangeId];
                        // M√†u ƒë·ªè n·∫øu t·ªïng balance √¢m
                        const totalBalanceColorClass = bal.total < 0 ? 'text-red' : ''; 
                        // available c≈©ng c√≥ th·ªÉ √¢m n·∫øu PnL ch∆∞a th·ª±c hi·ªán b·ªã l·ªó
                        const availableBalanceColorClass = bal.available < 0 ? 'text-red' : ''; 

                        balancesHtml += `<p><strong>${exchangeId.toUpperCase()}:</strong> T·ªïng <span class="${totalBalanceColorClass}">${bal.total.toFixed(2)} USDT</span>, Kh·∫£ d·ª•ng <span class="${availableBalanceColorClass}">${bal.available.toFixed(2)} USDT</span></p>`;
                    }
                    const totalOverallColorClass = data.balances.totalOverall < 0 ? 'text-red' : '';
                    balancesHtml += `<p><strong>T·ªïng s·ªë d∆∞ kh·∫£ d·ª•ng (T·∫•t c·∫£ s√†n, bao g·ªìm c·∫£ √¢m):</strong> <span class="${totalOverallColorClass}">${data.balances.totalOverall.toFixed(2)} USDT</span></p>`;
                } else {
                    balancesHtml += '<p>Kh√¥ng c√≥ d·ªØ li·ªáu s·ªë d∆∞.</p>';
                }
                balancesHtml += `<p><strong>S·ªë d∆∞ ban ƒë·∫ßu c·ªßa phi√™n:</strong> ${data.initialTotalBalance.toFixed(2)} USDT</p>`;
                document.getElementById('balancesDisplay').innerHTML = balancesHtml;

                // C·∫≠p nh·∫≠t PnL t·ªïng h·ª£p
                const cumulativePnlElement = document.getElementById('cumulativePnlDisplay');
                cumulativePnlElement.textContent = data.cumulativePnl.toFixed(2) + ' USDT';
                cumulativePnlElement.className = ''; // Reset classes
                if (data.cumulativePnl >= 0) {
                    cumulativePnlElement.classList.add('text-green');
                } else {
                    cumulativePnlElement.classList.add('text-red');
                }

                // C·∫≠p nh·∫≠t c∆° h·ªôi arbitrage t·ªët nh·∫•t (d·ª± ki·∫øn)
                const bestPotentialOpportunityDisplayDiv = document.getElementById('bestPotentialOpportunityDisplay');
                if (data.currentSelectedOpportunity) { // ƒê√¢y l√† bestPotentialOpportunityForDisplay t·ª´ bot.js
                    // Chuy·ªÉn ƒë·ªïi timestamp sang gi·ªù ƒë·ªãa ph∆∞∆°ng
                    const nextFundingDate = new Date(data.currentSelectedOpportunity.nextFundingTime);
                    const fundingTimeFormatted = nextFundingDate.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit', hour12: false });
                    const fundingDateFormatted = nextFundingDate.toLocaleDateString('vi-VN');

                    bestPotentialOpportunityDisplayDiv.innerHTML = `
                        <p><strong>Coin:</strong> <span>${data.currentSelectedOpportunity.coin}</span></p>
                        <p><strong>S√†n:</strong> <span>${data.currentSelectedOpportunity.exchanges}</span></p>
                        <p><strong>PnL ∆∞·ªõc t√≠nh:</strong> <span>${data.currentSelectedOpportunity.estimatedPnl?.toFixed(2) || 'N/A'}%</span></p>
                        <p><strong>T·ªõi gi·ªù funding:</strong> <span>${fundingTimeFormatted} ng√†y ${fundingDateFormatted}</span></p>
                        <p><strong>Volume ∆∞·ªõc t√≠nh:</strong> <span>${data.currentSelectedOpportunity.details.volume?.toFixed(2) || 'N/A'} USDT</span></p>
                        <p><strong>Max Lev s·∫Ω m·ªü:</strong> <span>${data.currentSelectedOpportunity.commonLeverage || 'N/A'}x</span></p>
                        <p><strong>Short Funding Rate:</strong> <span>${data.currentSelectedOpportunity.details.shortFundingRate?.toFixed(4) || 'N/A'}%</span></p>
                        <p><strong>Long Funding Rate:</strong> <span>${data.currentSelectedOpportunity.details.longFundingRate?.toFixed(4) || 'N/A'}%</span></p>
                        <p><strong>Ch√™nh l·ªách Funding:</strong> <span>${data.currentSelectedOpportunity.fundingDiff?.toFixed(4) || 'N/A'}%</span></p>
                    `;
                } else {
                    bestPotentialOpportunityDisplayDiv.textContent = 'Kh√¥ng c√≥ c∆° h·ªôi n√†o kh·∫£ d·ª•ng.';
                }

                // C·∫≠p nh·∫≠t l·ªãch s·ª≠ giao d·ªãch
                const tradeHistoryBody = document.getElementById('tradeHistoryBody');
                tradeHistoryBody.innerHTML = ''; 
                if (data.tradeHistory && data.tradeHistory.length > 0) {
                    data.tradeHistory.forEach(trade => {
                        const row = tradeHistoryBody.insertRow();
                        row.insertCell().textContent = new Date(trade.timestamp).toLocaleString('vi-VN'); 
                        row.insertCell().textContent = trade.coin;
                        row.insertCell().textContent = trade.exchanges;
                        row.insertCell().textContent = trade.fundingDiff ? trade.fundingDiff.toFixed(2) + '%' : 'N/A';
                        row.insertCell().textContent = trade.estimatedPnl ? trade.estimatedPnl.toFixed(2) + '%' : 'N/A';
                        const actualPnlCell = row.insertCell();
                        actualPnlCell.textContent = trade.actualPnl ? trade.actualPnl.toFixed(2) + ' USDT' : 'N/A';
                        if (trade.actualPnl !== undefined && trade.actualPnl !== null) {
                            actualPnlCell.classList.add(trade.actualPnl >= 0 ? 'text-green' : 'text-red');
                        }
                    });
                } else {
                    const row = tradeHistoryBody.insertRow();
                    const cell = row.insertCell();
                    cell.colSpan = 6;
                    cell.textContent = 'Ch∆∞a c√≥ l·ªãch s·ª≠ giao d·ªãch n√†o.';
                    cell.style.textAlign = 'center';
                    cell.style.fontStyle = 'italic';
                    cell.style.padding = '20px';
                }

            } catch (error) {
                console.error('L·ªói khi l·∫•y tr·∫°ng th√°i bot:', error);
                document.getElementById('botStateDisplay').textContent = 'L·ªñI K·∫æT N·ªêI';
                document.getElementById('botStateDisplay').classList.add('text-red');
            }
        }

        // Event Listeners cho n√∫t Start v√† Stop
        document.getElementById('startBotBtn').addEventListener('click', async () => {
            const percentageToUse = document.getElementById('percentageToUse').value;
            if (percentageToUse < 1 || percentageToUse > 100) {
                alert('Ph·∫ßn trƒÉm v·ªën m·ªü l·ªánh ph·∫£i t·ª´ 1 ƒë·∫øn 100.');
                return;
            }
            try {
                const response = await fetch('/bot-api/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ percentageToUse: parseFloat(percentageToUse) }) 
                });
                const data = await response.json();
                console.log('Ph·∫£n h·ªìi Start Bot:', data);
                alert(data.message);
                if (data.success) {
                    updateBotStatus(); 
                }
            } catch (error) {
                console.error('L·ªói khi kh·ªüi ƒë·ªông bot:', error);
                alert('L·ªói khi kh·ªüi ƒë·ªông bot: ' + error.message);
            }
        });

        document.getElementById('stopBotBtn').addEventListener('click', async () => {
            try {
                const response = await fetch('/bot-api/stop', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({}) 
                });
                const data = await response.json();
                console.log('Ph·∫£n h·ªìi Stop Bot:', data);
                alert(data.message);
                if (data.success) {
                    updateBotStatus(); 
                }
            } catch (error) {
                console.error('L·ªói khi d·ª´ng bot:', error);
                alert('L·ªói khi d·ª´ng bot: ' + error.message);
            }
        });

        // T·∫£i tr·∫°ng th√°i ban ƒë·∫ßu khi trang ƒë∆∞·ª£c load
        document.addEventListener('DOMContentLoaded', () => {
            updateBotStatus();
            // Thi·∫øt l·∫≠p interval ƒë·ªÉ t·ª± ƒë·ªông c·∫≠p nh·∫≠t tr·∫°ng th√°i m·ªói 5 gi√¢y
            setInterval(updateBotStatus, 5000); 
        });
    </script>
</body>
</html>
