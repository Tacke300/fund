<!-- index.html -->
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Bot UI</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f4; color: #333; }
        .container { max-width: 1200px; margin: auto; background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        h1, h2 { color: #0056b3; }
        .section { margin-bottom: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 5px; background-color: #f9f9f9; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input[type="number"] { width: 150px; padding: 8px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; }
        button { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; transition: background-color 0.3s ease; }
        button.start { background-color: #28a745; color: white; }
        button.start:hover { background-color: #218838; }
        button.stop { background-color: #dc3545; color: white; margin-left: 10px; }
        button.stop:hover { background-color: #c82333; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #e2e2e2; }
        .status-indicator { font-weight: bold; }
        .status-stopped { color: #dc3545; }
        .status-running { color: #28a745; }
        .status-other { color: #ffc107; }
        .alert { padding: 10px; background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; border-radius: 4px; margin-bottom: 10px; display: none; }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        #currentTradeDisplay { display: none; padding: 15px; background-color: #e7f3ff; border: 1px solid #a3ccf1; border-radius: 5px; margin-top: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Trading Bot Control Panel</h1>

        <div class="section">
            <h2>Cài đặt Bot</h2>
            <div>
                <label for="percentageToUse">Số lượng % USDT chạy trên mỗi sàn (ví dụ: 10 cho 10%):</label>
                <input type="number" id="percentageToUse" value="10" min="1" max="100">
            </div>
            <button class="start" id="startButton">Start Bot</button>
            <button class="stop" id="stopButton">Stop Bot</button>
            <div id="messageAlert" class="alert"></div>
        </div>

        <div class="section">
            <h2>Trạng thái Bot</h2>
            <p>Trạng thái hiện tại: <span id="botStatus" class="status-indicator status-stopped">STOPPED</span></p>
        </div>

        <div class="section">
            <h2>Số dư Tài khoản Futures</h2>
            <table>
                <thead>
                    <tr>
                        <th>Sàn</th>
                        <th>Tổng số dư (USDT)</th>
                        <th>Số dư khả dụng (USDT)</th>
                    </tr>
                </thead>
                <tbody id="balancesTableBody">
                    <!-- Data will be loaded here by JavaScript -->
                </tbody>
                <tfoot>
                    <tr>
                        <th>Tổng cộng</th>
                        <th id="totalOverallBalance" colspan="2">0.00 USDT</th>
                    </tr>
                </tfoot>
            </table>
        </div>

        <div class="section">
            <h2>Thống kê từ lúc Bot chạy</h2>
            <p>Tổng số dư ban đầu: <span id="initialTotalBalance">0.00 USDT</span></p>
            <p>PnL tích lũy: <span id="cumulativePnl">0.00 USDT</span></p>
        </div>

        <div id="currentTradeDisplay" class="section">
            <h2>Giao dịch hiện tại</h2>
            <p><strong>Coin:</strong> <span id="tradeCoin">N/A</span></p>
            <p><strong>Cặp Sàn:</strong> <span id="tradeExchanges">N/A</span></p>
            <p><strong>Lệnh SHORT trên:</strong> <span id="tradeShortEx">N/A</span> (Entry: <span id="tradeShortEntry">N/A</span>)</p>
            <p><strong>Lệnh LONG trên:</strong> <span id="tradeLongEx">N/A</span> (Entry: <span id="tradeLongEntry">N/A</span>)</p>
            <p><strong>Trạng thái lệnh:</strong> <span id="tradeOrderStatus">N/A</span></p>
        </div>

        <div class="section">
            <h2>Lịch sử các chu kỳ giao dịch</h2>
            <table>
                <thead>
                    <tr>
                        <th>ID Chu kỳ</th>
                        <th>Coin</th>
                        <th>Cặp Sàn</th>
                        <th>Funding Diff (%)</th>
                        <th>PnL Ước tính (%)</th>
                        <th>PnL Thực tế (USDT)</th>
                        <th>Thời gian</th>
                    </tr>
                </thead>
                <tbody id="historyTableBody">
                    <!-- History will be loaded here by JavaScript -->
                    <tr><td colspan="7">Chưa có lịch sử giao dịch.</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        const BOT_UI_API_URL = 'http://localhost:5006/bot-api'; // Địa chỉ API của Bot UI

        const botStatusSpan = document.getElementById('botStatus');
        const percentageToUseInput = document.getElementById('percentageToUse');
        const startButton = document.getElementById('startButton');
        const stopButton = document.getElementById('stopButton');
        const messageAlert = document.getElementById('messageAlert');

        const balancesTableBody = document.getElementById('balancesTableBody');
        const totalOverallBalanceSpan = document.getElementById('totalOverallBalance');
        const initialTotalBalanceSpan = document.getElementById('initialTotalBalance');
        const cumulativePnlSpan = document.getElementById('cumulativePnl');
        const historyTableBody = document.getElementById('historyTableBody');

        const currentTradeDisplay = document.getElementById('currentTradeDisplay');
        const tradeCoin = document.getElementById('tradeCoin');
        const tradeExchanges = document.getElementById('tradeExchanges');
        const tradeShortEx = document.getElementById('tradeShortEx');
        const tradeShortEntry = document.getElementById('tradeShortEntry');
        const tradeLongEx = document.getElementById('tradeLongEx');
        const tradeLongEntry = document.getElementById('tradeLongEntry');
        const tradeOrderStatus = document.getElementById('tradeOrderStatus');


        async function fetchBotStatus() {
            try {
                const response = await fetch(`${BOT_UI_API_URL}/status`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                updateUI(data);
            } catch (error) {
                console.error('Lỗi khi lấy trạng thái bot:', error);
                showMessage('Không thể kết nối tới bot. Đảm bảo bot đang chạy.', 'error');
            }
        }

        function updateUI(data) {
            // Update bot status
            botStatusSpan.textContent = data.botState;
            botStatusSpan.className = 'status-indicator ' + (
                data.botState === 'RUNNING' ? 'status-running' :
                data.botState === 'STOPPED' ? 'status-stopped' : 'status-other'
            );

            // Update balances table
            balancesTableBody.innerHTML = '';
            let currentTotal = 0;
            for (const exchangeId in data.balances) {
                if (exchangeId === 'totalOverall') continue;
                const balance = data.balances[exchangeId];
                const row = balancesTableBody.insertRow();
                row.insertCell().textContent = exchangeId.toUpperCase().replace('USDM', ''); // Clean for display
                row.insertCell().textContent = balance.total.toFixed(2) + ' USDT';
                row.insertCell().textContent = balance.available.toFixed(2) + ' USDT';
                currentTotal += balance.available; // Sum available balances for verification
            }
            totalOverallBalanceSpan.textContent = data.balances.totalOverall.toFixed(2) + ' USDT';

            // Update overall statistics
            initialTotalBalanceSpan.textContent = data.initialTotalBalance.toFixed(2) + ' USDT';
            cumulativePnlSpan.textContent = data.cumulativePnl.toFixed(2) + ' USDT';
            cumulativePnlSpan.style.color = data.cumulativePnl >= 0 ? 'green' : 'red';

            // Update trade history
            historyTableBody.innerHTML = '';
            if (data.tradeHistory && data.tradeHistory.length > 0) {
                data.tradeHistory.forEach(trade => {
                    const row = historyTableBody.insertRow();
                    row.insertCell().textContent = trade.id;
                    row.insertCell().textContent = trade.coin;
                    row.insertCell().textContent = trade.exchanges;
                    row.insertCell().textContent = trade.fundingDiff.toFixed(6);
                    row.insertCell().textContent = trade.estimatedPnl.toFixed(2) + '%';
                    const actualPnlCell = row.insertCell();
                    actualPnlCell.textContent = trade.actualPnl.toFixed(2) + ' USDT';
                    actualPnlCell.style.color = trade.actualPnl >= 0 ? 'green' : 'red';
                    row.insertCell().textContent = new Date(trade.timestamp).toLocaleString();
                });
            } else {
                const row = historyTableBody.insertRow();
                const cell = row.insertCell();
                cell.colSpan = 7;
                cell.textContent = 'Chưa có lịch sử giao dịch.';
            }

            // Update current trade display
            if (data.currentTradeDetails && data.currentTradeDetails.status === 'OPEN') {
                currentTradeDisplay.style.display = 'block';
                tradeCoin.textContent = data.currentTradeDetails.coin;
                tradeExchanges.textContent = `${data.currentTradeDetails.shortExchange.replace('usdm', '')} / ${data.currentTradeDetails.longExchange.replace('usdm', '')}`;
                tradeShortEx.textContent = data.currentTradeDetails.shortExchange.replace('usdm', '');
                tradeShortEntry.textContent = data.currentTradeDetails.shortEntryPrice.toFixed(4);
                tradeLongEx.textContent = data.currentTradeDetails.longExchange.replace('usdm', '');
                tradeLongEntry.textContent = data.currentTradeDetails.longEntryPrice.toFixed(4);
                tradeOrderStatus.textContent = data.currentTradeDetails.status;
                tradeOrderStatus.style.color = 'orange'; // Indicate open status
            } else {
                currentTradeDisplay.style.display = 'none';
            }
        }

        function showMessage(message, type = 'info') {
            messageAlert.textContent = message;
            messageAlert.className = `alert ${type}`;
            messageAlert.style.display = 'block';
            setTimeout(() => {
                messageAlert.style.display = 'none';
            }, 5000);
        }

        startButton.addEventListener('click', async () => {
            const percentage = parseFloat(percentageToUseInput.value);
            if (isNaN(percentage) || percentage <= 0 || percentage > 100) {
                showMessage('Vui lòng nhập phần trăm hợp lệ (1-100).', 'error');
                return;
            }
            try {
                const response = await fetch(`${BOT_UI_API_URL}/start`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ percentageToUse: percentage })
                });
                const result = await response.json();
                if (result.success) {
                    showMessage(result.message, 'success');
                } else {
                    showMessage(result.message, 'error');
                }
            } catch (error) {
                console.error('Lỗi khi gửi lệnh START:', error);
                showMessage('Lỗi kết nối hoặc bot không phản hồi khi Start.', 'error');
            }
        });

        stopButton.addEventListener('click', async () => {
            try {
                const response = await fetch(`${BOT_UI_API_URL}/stop`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const result = await response.json();
                if (result.success) {
                    showMessage(result.message, 'success');
                } else {
                    showMessage(result.message, 'error');
                }
            } catch (error) {
                console.error('Lỗi khi gửi lệnh STOP:', error);
                showMessage('Lỗi kết nối hoặc bot không phản hồi khi Stop.', 'error');
            }
        });

        // Fetch status every 5 seconds
        setInterval(fetchBotStatus, 5000);
        fetchBotStatus(); // Initial fetch
    </script>
</body>
</html>
