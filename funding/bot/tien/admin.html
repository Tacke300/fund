<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Qu·∫£n L√Ω</title>
    <style>
        :root { --bg: #121212; --card: #1e1e1e; --text: #e0e0e0; --accent: #007bff; --border: #333; --danger: #ff4444; --success: #00c851; }
        body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; margin: 0; padding: 20px; }
        
        h1, h2 { margin-top: 0; color: var(--accent); }
        
        /* TABLE */
        table { width: 100%; border-collapse: collapse; background: var(--card); }
        th, td { padding: 12px; border: 1px solid var(--border); text-align: left; font-size: 0.9rem; }
        th { background: #252525; text-transform: uppercase; color: #aaa; }
        tr:hover { background: #2a2a2a; }
        .user-link { color: var(--accent); cursor: pointer; text-decoration: underline; font-weight: bold; }

        /* PANEL */
        .panel { background: var(--card); padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid var(--border); box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        .controls { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; align-items: end; }
        
        input, select { padding: 10px; background: #2b2b2b; border: 1px solid #444; color: #fff; border-radius: 4px; width: 100%; box-sizing: border-box; }
        button { padding: 10px; background: var(--accent); border: none; color: white; font-weight: bold; cursor: pointer; border-radius: 4px; width: 100%; }
        button:hover { opacity: 0.9; }
        
        .checkbox-wrapper { display: flex; align-items: center; gap: 10px; height: 40px; background: #252525; padding: 0 10px; border-radius: 4px; border: 1px solid #444; }
        input[type="checkbox"] { width: 20px; height: 20px; accent-color: var(--danger); }

        /* ACCORDION (CHI TI·∫æT) */
        .acc-item { border: 1px solid var(--border); margin-bottom: 5px; border-radius: 4px; overflow: hidden; }
        .acc-header { background: #2a2a2a; padding: 15px; cursor: pointer; display: flex; justify-content: space-between; font-weight: bold; }
        .acc-header:hover { background: #333; }
        .acc-content { display: none; padding: 0; background: #1a1a1a; }
        .acc-content table { margin: 0; border: none; }
        .acc-content td { border-bottom: 1px solid #333; border-top: none; color: #bbb; }
        .show { display: block; }
        .total-highlight { color: var(--success); }

        /* MODAL */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: var(--card); padding: 20px; width: 700px; max-height: 90vh; overflow-y: auto; border-radius: 8px; border: 1px solid var(--accent); }
        .close { float: right; cursor: pointer; font-size: 1.5rem; color: #aaa; }

        /* LOG */
        #actionLog { background: #000; padding: 10px; height: 200px; overflow-y: scroll; font-family: monospace; border: 1px solid #444; margin-top: 10px; color: #0f0; font-size: 0.85rem; }
    </style>
</head>
<body>

    <h1>QU·∫¢N TR·ªä BOT</h1>

    <!-- USER LIST -->
    <div class="panel">
        <h2>üë• Danh s√°ch t√†i kho·∫£n</h2>
        <table>
            <thead>
                <tr>
                    <th>#</th>
                    <th>Username</th>
                    <th>Email</th>
                    <th>Binance Fut ($)</th>
                    <th>KuCoin Fut ($)</th>
                    <th>T·∫°m t√≠nh ($)</th> <!-- Note: Ch·ªâ t√≠nh Future ƒë·ªÉ load nhanh -->
                </tr>
            </thead>
            <tbody id="userTableBody">
                <tr><td colspan="6">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>
            </tbody>
        </table>
    </div>

    <!-- TRANSFER -->
    <div class="panel">
        <h2 style="color: var(--danger);">üí∏ Chuy·ªÉn ti·ªÅn / Thanh l√Ω</h2>
        <div class="controls">
            <div>
                <label>H∆∞·ªõng chuy·ªÉn:</label>
                <select id="direction">
                    <option value="binance_to_kucoin">Binance ‚ûî KuCoin</option>
                    <option value="kucoin_to_binance">KuCoin ‚ûî Binance</option>
                    <option value="both_ways" style="font-weight:bold; color:#ffff00;">‚áÑ C·∫¢ 2 CHI·ªÄU (R√∫t ch√©o)</option>
                </select>
            </div>
            <div>
                <label>Ngu·ªìn ti·ªÅn:</label>
                <select id="sourceWallet">
                    <option value="both">Gom c·∫£ Future & Spot</option>
                    <option value="future">Ch·ªâ t·ª´ Future</option>
                    <option value="spot">Ch·ªâ t·ª´ Spot</option>
                </select>
            </div>
            <div>
                <label>T√†i kho·∫£n:</label>
                <select id="targetUser">
                    <option value="ALL">--- T·∫§T C·∫¢ USER ---</option>
                </select>
            </div>
            <div>
                <label>Coin:</label>
                <input type="text" id="coinName" value="USDT">
            </div>
            <div>
                <label>S·ªë l∆∞·ª£ng:</label>
                <input type="number" id="amount" placeholder="Nh·∫≠p s·ªë USDT">
            </div>
            <div class="checkbox-wrapper">
                <input type="checkbox" id="getAllCheck">
                <label for="getAllCheck" style="color: var(--danger); font-weight: bold;">GET ALL (R√∫t H·∫øt)</label>
            </div>
            <button onclick="executeAction()">TH·ª∞C HI·ªÜN</button>
        </div>
        <div id="actionLog">Logs...</div>
    </div>

    <!-- DETAIL MODAL (ACCORDION) -->
    <div id="detailModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="document.getElementById('detailModal').style.display='none'">&times;</span>
            <h2 id="modalTitle">Chi ti·∫øt t√†i s·∫£n</h2>
            <div id="accordionContainer">ƒêang qu√©t d·ªØ li·ªáu... (M·∫•t v√†i gi√¢y)</div>
        </div>
    </div>

    <script>
        let usersData = [];

        // --- 1. LOAD USERS ---
        async function loadUsers() {
            const res = await fetch('/api/users');
            usersData = await res.json();
            const tbody = document.getElementById('userTableBody');
            const select = document.getElementById('targetUser');
            
            tbody.innerHTML = '';
            select.innerHTML = '<option value="ALL">--- T·∫§T C·∫¢ USER ---</option>';

            usersData.forEach(u => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${u.id}</td>
                    <td class="user-link" onclick="showDetails('${u.filename}', '${u.username}')">${u.username}</td>
                    <td>${u.email}</td>
                    <td style="color:#F0B90B">${u.binanceFuture.toFixed(2)}</td>
                    <td style="color:#24AE8F">${u.kucoinFuture.toFixed(2)}</td>
                    <td>${u.tempTotal.toFixed(2)} (Fut)</td>
                `;
                tbody.appendChild(tr);

                const opt = document.createElement('option');
                opt.value = u.filename.replace('_config.json', '');
                opt.innerText = u.username;
                select.appendChild(opt);
            });
        }

        // --- 2. SHOW DETAILS (ACCORDION) ---
        async function showDetails(filename, username) {
            const modal = document.getElementById('detailModal');
            const container = document.getElementById('accordionContainer');
            const title = document.getElementById('modalTitle');
            
            title.innerText = `Chi ti·∫øt: ${username}`;
            container.innerHTML = '<div style="text-align:center; padding:20px; color:#aaa;">ƒêang qu√©t to√†n b·ªô v√≠ (Spot, Earn, Margin...)...<br>Vui l√≤ng ch·ªù...</div>';
            modal.style.display = 'flex';

            const res = await fetch(`/api/details/${filename}`);
            const data = await res.json();
            
            // Render Accordion
            let html = `<div style="margin-bottom:15px; font-size:1.2rem; color:#fff;">T·ªîNG T√ÄI S·∫¢N (Quy ƒë·ªïi): <span style="color:#00c851; font-weight:bold;">${data.totalUsdt.toFixed(2)} USDT</span></div>`;

            // Helper render section
            const renderSection = (title, items, total, color) => {
                if (total < 1) return ''; // ·∫®n n·∫øu < 1$
                let rows = items.map(i => `<tr>
                    <td>${i.coin}</td>
                    <td>${i.amount.toFixed(4)}</td>
                    <td>${i.price.toFixed(2)}$</td>
                    <td style="font-weight:bold; color:${color}">${i.value.toFixed(2)}$</td>
                </tr>`).join('');

                return `
                <div class="acc-item">
                    <div class="acc-header" onclick="this.nextElementSibling.classList.toggle('show')">
                        <span>${title}</span>
                        <span style="color:${color}">${total.toFixed(2)} USDT ‚ñº</span>
                    </div>
                    <div class="acc-content">
                        <table>
                            <thead><tr><th>Coin</th><th>S·ªë l∆∞·ª£ng</th><th>Gi√°</th><th>Gi√° tr·ªã</th></tr></thead>
                            <tbody>${rows}</tbody>
                        </table>
                    </div>
                </div>`;
            };

            html += renderSection('BINANCE SPOT', data.binance.spot, data.binance.total, '#F0B90B');
            html += renderSection('BINANCE FUTURE', data.binance.future, data.binance.future.reduce((a,b)=>a+b.value,0), '#F0B90B');
            html += renderSection('BINANCE MARGIN/EARN', data.binance.margin, data.binance.margin.reduce((a,b)=>a+b.value,0), '#d6a100');
            
            html += renderSection('KUCOIN SPOT', data.kucoin.spot, data.kucoin.total, '#24AE8F');
            html += renderSection('KUCOIN FUTURE', data.kucoin.future, data.kucoin.future.reduce((a,b)=>a+b.value,0), '#24AE8F');
            html += renderSection('KUCOIN MARGIN', data.kucoin.margin, data.kucoin.margin.reduce((a,b)=>a+b.value,0), '#1d8c73');

            container.innerHTML = html;
        }

        // --- 3. EXECUTE ACTION ---
        const getAllCheck = document.getElementById('getAllCheck');
        getAllCheck.addEventListener('change', function() {
            const inputs = [document.getElementById('amount'), document.getElementById('coinName')];
            inputs.forEach(i => i.disabled = this.checked);
            if(this.checked) {
                document.getElementById('amount').placeholder = "T·ª± ƒë·ªông t·ªëi ƒëa";
                document.getElementById('coinName').value = "USDT";
            } else {
                document.getElementById('amount').placeholder = "Nh·∫≠p s·ªë ti·ªÅn";
            }
        });

        async function executeAction() {
            const direction = document.getElementById('direction').value;
            let fromEx, toEx;
            
            if (direction === 'both_ways') {
                fromEx = 'both_ways';
                toEx = 'both_ways';
            } else {
                fromEx = direction.split('_')[0];
                toEx = direction.split('_')[2];
            }

            const payload = {
                fromExchange: fromEx,
                toExchange: toEx,
                sourceWallet: document.getElementById('sourceWallet').value,
                username: document.getElementById('targetUser').value,
                coin: document.getElementById('coinName').value, 
                amount: document.getElementById('amount').value,
                isGetAll: document.getElementById('getAllCheck').checked
            };

            if (!payload.isGetAll && !payload.amount) return alert("Nh·∫≠p s·ªë ti·ªÅn!");
            if (payload.isGetAll && !confirm("‚ö†Ô∏è C·∫¢NH B√ÅO: B·∫°n ƒëang ch·ªçn R√öT H·∫æT (GET ALL).\nBot s·∫Ω ƒë√≥ng l·ªánh Futures, b√°n coin Spot v√† r√∫t s·∫°ch ti·ªÅn.\nTi·∫øp t·ª•c?")) return;

            const logDiv = document.getElementById('actionLog');
            logDiv.innerHTML += `<div>> Sending command...</div>`;

            const res = await fetch('/api/transfer', {
                method: 'POST',
                body: JSON.stringify(payload)
            });
            const data = await res.json();
            
            data.logs.forEach(userLogs => {
                userLogs.forEach(line => {
                    let color = line.includes('‚ùå') || line.includes('L·ªói') ? '#ff4444' : '#00c851';
                    if(line.includes('User:')) color = '#ffff00';
                    logDiv.innerHTML += `<div style="color:${color}">${line}</div>`;
                });
                logDiv.innerHTML += `<div>-------------------</div>`;
            });
            logDiv.scrollTop = logDiv.scrollHeight;
            loadUsers(); 
        }

        loadUsers();
        setInterval(loadUsers, 30000);
    </script>
</body>
</html>
