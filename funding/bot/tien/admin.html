<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super Admin Bot</title>
    <!-- TH√äM CHART JS -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --bg: #121212; --card: #1e1e1e; --text: #e0e0e0; --accent: #007bff; --border: #333; --danger: #ff4444; --success: #00c851; --warning: #ffbb33; --vip: #ffd700; }
        body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; margin: 0; padding: 20px; }
        h2 { margin-top: 0; color: var(--accent); border-bottom: 1px solid #333; padding-bottom: 10px; }

        /* TABLE */
        table { width: 100%; border-collapse: collapse; background: var(--card); font-size: 0.9rem; margin-bottom: 20px; }
        th, td { padding: 12px; border: 1px solid var(--border); text-align: left; }
        th { background: #252525; text-transform: uppercase; color: #aaa; position: sticky; top: 0; }
        tr:hover { background: #2a2a2a; }
        .user-link { color: var(--accent); cursor: pointer; text-decoration: underline; font-weight: bold; }
        
        .pnl-pos { color: var(--success); font-weight: bold; }
        .pnl-neg { color: var(--danger); font-weight: bold; }
        .vip-tag { background: var(--vip); color: #000; padding: 2px 6px; border-radius: 4px; font-weight:bold; font-size:0.8em; }

        .panel { background: var(--card); padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid var(--border); }
        .controls { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; align-items: end; }
        input, select, button { padding: 10px; width: 100%; box-sizing: border-box; }
        button { background: var(--accent); border: none; color: white; font-weight: bold; cursor: pointer; }

        /* MODAL */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: var(--card); padding: 20px; width: 95%; max-width: 1400px; max-height: 90vh; overflow-y: auto; border-radius: 8px; border: 1px solid var(--accent); }
        .close { float: right; cursor: pointer; font-size: 1.5rem; color: #aaa; }
        
        /* Chart */
        .chart-container { position: relative; height: 300px; width: 100%; margin-bottom: 20px; background: #151515; }
        
        .tab-title { color: var(--warning); border-bottom: 1px solid #444; padding-bottom: 5px; margin-top: 30px; text-transform: uppercase; }
        .order-tag { font-size: 0.7em; padding: 2px 4px; background: #333; margin-right: 4px; border: 1px solid #555; }
    </style>
</head>
<body>

    <!-- 1. B·∫¢NG CHUY·ªÇN TI·ªÄN -->
    <div class="panel">
        <h2 style="color: var(--danger);">üí∏ Chuy·ªÉn Ti·ªÅn Admin</h2>
        <div class="controls">
            <!-- Gi·ªØ nguy√™n c√°c controls c≈© -->
            <button onclick="executeAction()">TH·ª∞C HI·ªÜN</button>
        </div>
        <div id="actionLog">Logs...</div>
    </div>

    <!-- 3. DANH S√ÅCH USER -->
    <div class="panel">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2>üë• Danh S√°ch T√†i Kho·∫£n</h2>
            <button onclick="loadUsers()" style="width:auto; background:#333;">üîÑ Refresh</button>
        </div>
        
        <table>
            <thead>
                <tr>
                    <th>#</th>
                    <th>Username</th>
                    <th>Email</th>
                    <th>Status</th>
                    <th>Last Login</th>
                    <th>Binance Fut</th>
                    <th>KuCoin Fut</th>
                    <th>T·ªîNG T√ÄI S·∫¢N</th>
                    <th>T·ªïng PNL</th>
                </tr>
            </thead>
            <tbody id="userTableBody"><tr><td colspan="9">ƒêang t·∫£i...</td></tr></tbody>
        </table>
    </div>

    <!-- MODAL CHI TI·∫æT -->
    <div id="detailModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="document.getElementById('detailModal').style.display='none'">&times;</span>
            <h2 id="modalTitle">Chi ti·∫øt</h2>
            <div id="accordionContainer">Loading...</div>
        </div>
    </div>

    <script>
        let usersData = [];
        let chartInstance = null;

        async function loadUsers() {
            try {
                const res = await fetch('/api/users');
                usersData = await res.json();
                usersData.sort((a, b) => b.totalAll - a.totalAll);
                const tbody = document.getElementById('userTableBody');
                tbody.innerHTML = '';
                usersData.forEach((u, idx) => {
                    const pnlClass = u.totalPnl >= 0 ? 'pnl-pos' : 'pnl-neg';
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${idx+1}</td>
                        <td class="user-link" onclick="showDetails('${u.username}')">${u.username}</td>
                        <td>${u.email||'-'}</td>
                        <td>${u.vipStatus}</td>
                        <td>${u.lastLogin ? new Date(u.lastLogin).toLocaleString() : '-'}</td>
                        <td style="color:#F0B90B">$${u.binanceFuture.toFixed(1)}</td>
                        <td style="color:#24AE8F">$${u.kucoinFuture.toFixed(1)}</td>
                        <td style="font-weight:bold">$${u.totalAll.toFixed(1)}</td>
                        <td class="${pnlClass}">$${u.totalPnl.toFixed(1)}</td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch(e) {}
        }

        async function showDetails(username) {
            const modal = document.getElementById('detailModal');
            const container = document.getElementById('accordionContainer');
            document.getElementById('modalTitle').innerText = `Chi ti·∫øt: ${username}`;
            container.innerHTML = '<div style="text-align:center; padding:40px"><h3>üîÑ ƒêang t·∫£i 5 b·∫£ng l·ªãch s·ª≠...</h3></div>';
            modal.style.display = 'flex';

            try {
                const res = await fetch(`/api/details/${username}`);
                const d = await res.json();
                
                if (d.error) { container.innerHTML = `<h3 style="color:red">L·ªói: ${d.error}</h3>`; return; }

                // --- V·∫º BI·ªÇU ƒê·ªí ---
                setTimeout(() => {
                    const ctx = document.getElementById('balanceChart');
                    if(ctx && d.balanceHistory) {
                        if(chartInstance) chartInstance.destroy();
                        chartInstance = new Chart(ctx.getContext('2d'), {
                            type: 'line',
                            data: {
                                labels: d.balanceHistory.map(i=>new Date(i.time).toLocaleTimeString()),
                                datasets: [{ label: 'Total Equity', data: d.balanceHistory.map(i=>i.total), borderColor: '#007bff', tension: 0.1 }]
                            },
                            options: { responsive:true, maintainAspectRatio:false, scales:{x:{display:false}, y:{grid:{color:'#333'}}} }
                        });
                    }
                }, 100);

                // --- HELPER RENDER TABLE ---
                const renderTable = (headers, rows) => `<table style="margin-bottom:20px;"><tr>${headers.map(h=>`<th>${h}</th>`).join('')}</tr>${rows}</table>`;

                // 1. LIVE POSITIONS
                const posRows = [...(d.binance.positions||[]).map(p=>({...p,ex:'Binance'})), ...(d.kucoin.positions||[]).map(p=>({...p,ex:'Kucoin'}))].map(p => {
                    let tpsl = '';
                    if(p.openOrders && p.openOrders.length) {
                        p.openOrders.forEach(o => {
                            const type = o.type.includes('take') ? 'TP' : 'SL';
                            const color = type==='TP'?'#00e676':'#ff5252';
                            tpsl += `<span class="order-tag" style="color:${color}">${type}: ${parseFloat(o.stopPrice||o.price).toFixed(4)}</span>`;
                        });
                    }
                    return `<tr><td>${p.ex}</td><td><b>${p.symbol}</b><br>${tpsl}</td><td>${p.side.toUpperCase()}</td><td>x${p.leverage}</td><td>$${p.unrealizedPnl.toFixed(2)}</td></tr>`;
                }).join('') || '<tr><td colspan="5" style="text-align:center">Tr·ªëng</td></tr>';

                // 2. AGGREGATED TRADES (G·ªôp)
                const aggRows = [...(d.binance.aggTrades||[]).map(t=>({...t,ex:'Binance'})), ...(d.kucoin.aggTrades||[]).map(t=>({...t,ex:'Kucoin'}))]
                    .sort((a,b)=>b.timestamp-a.timestamp).map(t => {
                        return `<tr><td>${new Date(t.timestamp).toLocaleString()}</td><td>${t.ex}</td><td>${t.symbol}</td><td>${t.side}</td><td>$${t.realizedPnl.toFixed(2)}</td></tr>`;
                    }).join('');

                // 3. RAW TRADES (Th√¥)
                const rawRows = [...(d.binance.rawTrades||[]).map(t=>({...t,ex:'Binance'})), ...(d.kucoin.rawTrades||[]).map(t=>({...t,ex:'Kucoin'}))]
                    .sort((a,b)=>b.timestamp-a.timestamp).map(t => {
                        return `<tr><td>${new Date(t.timestamp).toLocaleString()}</td><td>${t.ex}</td><td>${t.symbol}</td><td>${t.side}</td><td>${parseFloat(t.price).toFixed(4)}</td></tr>`;
                    }).join('');

                // 4. CLOSED ORDERS (API Closed)
                const closedRows = [...(d.binance.closedOrders||[]).map(t=>({...t,ex:'Binance'})), ...(d.kucoin.closedOrders||[]).map(t=>({...t,ex:'Kucoin'}))]
                    .sort((a,b)=>b.timestamp-a.timestamp).map(t => {
                        return `<tr><td>${new Date(t.timestamp).toLocaleString()}</td><td>${t.ex}</td><td>${t.symbol}</td><td>${t.status}</td></tr>`;
                    }).join('');

                // 5. BOT HISTORY (File)
                const botRows = (d.botHistory||[]).map(t => {
                    return `<tr><td>${new Date(t.entryTime).toLocaleString()}</td><td>${t.coin}</td><td>${t.estimatedPnlFromOpportunity}%</td><td>$${parseFloat(t.actualPnl||0).toFixed(2)}</td></tr>`;
                }).join('');

                // HTML BUILDER
                let html = `
                    <div style="display:flex;gap:10px;margin-bottom:20px;">
                        <div style="flex:1;background:#222;padding:10px;text-align:center;border:1px solid #444"><small>Total</small><h3>$${d.totalUsdt.toFixed(2)}</h3></div>
                    </div>
                    <div class="chart-container"><canvas id="balanceChart"></canvas></div>

                    <h3 class="tab-title">1. V·ªã th·∫ø ƒëang m·ªü (Live - C√≥ TP/SL)</h3>
                    ${renderTable(['S√†n','Symbol','Side','Lev','PnL'], posRows)}

                    <h3 class="tab-title">2. L·ªãch s·ª≠ G·ªôp (Aggregated - C√≥ PnL)</h3>
                    ${renderTable(['Time','S√†n','Symbol','Side','Realized PnL'], aggRows)}

                    <h3 class="tab-title">3. L·ªãch s·ª≠ Kh·ªõp l·ªánh Th√¥ (MyTrades - Raw Fills)</h3>
                    ${renderTable(['Time','S√†n','Symbol','Side','Price'], rawRows)}

                    <h3 class="tab-title">4. L·ªãch s·ª≠ ƒê√≥ng l·ªánh API (ClosedOrders)</h3>
                    ${renderTable(['Time','S√†n','Symbol','Status'], closedRows)}

                    <h3 class="tab-title">5. L·ªãch s·ª≠ BOT (File JSON)</h3>
                    ${renderTable(['Time','Coin','Est PnL','Net PnL'], botRows)}
                `;

                container.innerHTML = html;

            } catch(e) { console.error(e); }
        }

        // Functions c≈©
        function executeAction() { alert('Demo Action'); }
        function toggleCheckAll() {}
        async function executeVipUpdate() {}

        loadUsers();
        setInterval(loadUsers, 60000); 
    </script>
</body>
</html>
