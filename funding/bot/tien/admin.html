<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Qu·∫£n L√Ω Bot</title>
    <style>
        :root { --bg: #121212; --card: #1e1e1e; --text: #e0e0e0; --accent: #007bff; --border: #333; }
        body { background: var(--bg); color: var(--text); font-family: sans-serif; margin: 0; padding: 20px; }
        h1, h2 { color: var(--accent); }
        
        /* Table */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; background: var(--card); }
        th, td { padding: 12px; border: 1px solid var(--border); text-align: left; }
        th { background: #252525; }
        tr:hover { background: #2a2a2a; cursor: pointer; }
        .user-link { color: #4db8ff; text-decoration: underline; }

        /* Card/Panel */
        .panel { background: var(--card); padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid var(--border); }
        .controls { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; align-items: end; }
        
        input, select, button { padding: 10px; background: #2b2b2b; border: 1px solid #444; color: #fff; border-radius: 4px; width: 100%; box-sizing: border-box; }
        button { background: var(--accent); border: none; font-weight: bold; cursor: pointer; }
        button:hover { opacity: 0.9; }
        
        .checkbox-wrapper { display: flex; align-items: center; gap: 10px; height: 40px; }
        input[type="checkbox"] { width: 20px; height: 20px; }

        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: var(--card); padding: 20px; width: 600px; max-height: 80vh; overflow-y: auto; border-radius: 8px; }
        .close { float: right; cursor: pointer; font-size: 1.5rem; }
        
        /* Log */
        #actionLog { background: #000; padding: 10px; height: 200px; overflow-y: scroll; font-family: monospace; border: 1px solid #444; margin-top: 10px; color: #0f0; }
    </style>
</head>
<body>

    <h1>ADMIN DASHBOARD</h1>

    <!-- TRANSFER PANEL -->
    <div class="panel">
        <h2>üí∞ Chuy·ªÉn Ti·ªÅn & Thanh L√Ω</h2>
        <div class="controls">
            <div>
                <label>Chi·ªÅu Chuy·ªÉn:</label>
                <select id="direction">
                    <option value="binance_to_kucoin">Binance ‚ûî KuCoin</option>
                    <option value="kucoin_to_binance">KuCoin ‚ûî Binance</option>
                </select>
            </div>
            <div>
                <label>Ngu·ªìn Ti·ªÅn:</label>
                <select id="sourceWallet">
                    <option value="both">C·∫£ Futures & Spot</option>
                    <option value="future">Ch·ªâ Futures</option>
                    <option value="spot">Ch·ªâ Spot</option>
                </select>
            </div>
            <div>
                <label>ƒê·ªëi T∆∞·ª£ng:</label>
                <select id="targetUser">
                    <option value="ALL">--- T·∫§T C·∫¢ USER ---</option>
                    <!-- User list will be populated here -->
                </select>
            </div>
            <div>
                <label>Coin:</label>
                <input type="text" id="coinName" value="USDT">
            </div>
            <div>
                <label>S·ªë L∆∞·ª£ng:</label>
                <input type="number" id="amount" placeholder="Nh·∫≠p s·ªë ti·ªÅn">
            </div>
            <div class="checkbox-wrapper">
                <input type="checkbox" id="getAllCheck">
                <label for="getAllCheck" style="color: #ff4d4d; font-weight: bold;">GET ALL (Thanh L√Ω H·∫øt)</label>
            </div>
            <button onclick="executeAction()">TH·ª∞C HI·ªÜN</button>
        </div>
        <div id="actionLog">Logs s·∫Ω hi·ªán ·ªü ƒë√¢y...</div>
    </div>

    <!-- USER TABLE -->
    <div class="panel">
        <h2>üë• Danh S√°ch Ng∆∞·ªùi D√πng</h2>
        <table>
            <thead>
                <tr>
                    <th>#</th>
                    <th>Username</th>
                    <th>Email</th>
                    <th>Binance Fut ($)</th>
                    <th>KuCoin Fut ($)</th>
                    <th>T·ªïng ($)</th>
                </tr>
            </thead>
            <tbody id="userTableBody">
                <tr><td colspan="6">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>
            </tbody>
        </table>
    </div>

    <!-- DETAIL MODAL -->
    <div id="detailModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="document.getElementById('detailModal').style.display='none'">&times;</span>
            <h2 id="modalTitle">Chi ti·∫øt t√†i s·∫£n</h2>
            <table id="detailTable">
                <thead><tr><th>Lo·∫°i V√≠</th><th>Coin</th><th>S·ªë l∆∞·ª£ng</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <script>
        let usersData = [];

        // Load Users
        async function loadUsers() {
            const res = await fetch('/api/users');
            usersData = await res.json();
            const tbody = document.getElementById('userTableBody');
            const select = document.getElementById('targetUser');
            
            tbody.innerHTML = '';
            // Reset select but keep ALL
            select.innerHTML = '<option value="ALL">--- T·∫§T C·∫¢ USER ---</option>';

            usersData.forEach(u => {
                // Add to Table
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${u.id}</td>
                    <td class="user-link" onclick="showDetails('${u.filename}', '${u.username}')">${u.username}</td>
                    <td>${u.email}</td>
                    <td>${u.binanceFuture.toFixed(2)}</td>
                    <td>${u.kucoinFuture.toFixed(2)}</td>
                    <td style="font-weight:bold">${u.total.toFixed(2)}</td>
                `;
                tbody.appendChild(tr);

                // Add to Dropdown
                const opt = document.createElement('option');
                opt.value = u.filename; // Use filename as ID
                opt.innerText = u.username;
                select.appendChild(opt);
            });
        }

        // Show Details
        async function showDetails(filename, username) {
            const modal = document.getElementById('detailModal');
            const title = document.getElementById('modalTitle');
            const tbody = document.querySelector('#detailTable tbody');
            
            title.innerText = `Chi ti·∫øt: ${username}`;
            tbody.innerHTML = '<tr><td colspan="3">ƒêang qu√©t...</td></tr>';
            modal.style.display = 'flex';

            const res = await fetch(`/api/details/${filename}`);
            const details = await res.json();
            
            tbody.innerHTML = '';
            if(details.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3">Kh√¥ng c√≥ t√†i s·∫£n > 1$</td></tr>';
            } else {
                details.forEach(d => {
                    tbody.innerHTML += `<tr><td>${d.type}</td><td>${d.coin}</td><td>${d.amount.toFixed(4)}</td></tr>`;
                });
            }
        }

        // Execute Action
        async function executeAction() {
            const direction = document.getElementById('direction').value;
            const fromExchange = direction.split('_')[0]; // binance or kucoin
            const toExchange = direction.split('_')[2];
            
            const payload = {
                fromExchange: fromExchange,
                toExchange: toExchange,
                sourceWallet: document.getElementById('sourceWallet').value,
                username: document.getElementById('targetUser').value,
                coin: document.getElementById('coinName').value,
                amount: document.getElementById('amount').value,
                isGetAll: document.getElementById('getAllCheck').checked
            };

            if (!payload.isGetAll && !payload.amount) return alert("Vui l√≤ng nh·∫≠p s·ªë ti·ªÅn!");
            if (payload.isGetAll && !confirm("C·∫¢NH B√ÅO: B·∫°n ƒëang ch·ªçn GET ALL.\nH√†nh ƒë·ªông n√†y s·∫Ω ƒê√ìNG TO√ÄN B·ªò V·ªä TH·∫æ, b√°n coin ra USDT v√† chuy·ªÉn h·∫øt ƒëi.\nB·∫°n ch·∫Øc ch·∫Øn ch·ª©?")) return;

            const logDiv = document.getElementById('actionLog');
            logDiv.innerHTML += `<div>> B·∫Øt ƒë·∫ßu l·ªánh...</div>`;

            const res = await fetch('/api/transfer', {
                method: 'POST',
                body: JSON.stringify(payload)
            });
            const data = await res.json();
            
            data.logs.forEach(userLogs => {
                userLogs.forEach(line => {
                    logDiv.innerHTML += `<div>${line}</div>`;
                });
                logDiv.innerHTML += `<div>-------------------</div>`;
            });
            logDiv.scrollTop = logDiv.scrollHeight;
            loadUsers(); // Refresh balances
        }

        // Init
        loadUsers();
        setInterval(loadUsers, 30000); // Auto refresh table every 30s
    </script>
</body>
</html>
