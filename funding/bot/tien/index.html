<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Arbitrage Bot V2</title>
    <style>
        :root { --bg-color: #000; --card-bg: #111; --binance-yellow: #F0B90B; --kucoin-green: #00D095; --text-color: #EAECEF; --danger: #F6465D; }
        body { font-family: sans-serif; background: var(--bg-color); color: var(--text-color); margin: 0; padding: 15px; }
        
        .auth-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 2000; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        .auth-box { background: #1a1a1a; padding: 30px; border: 1px solid var(--binance-yellow); text-align: center; width: 300px; border-radius: 10px; }
        .auth-box input { width: 100%; padding: 10px; margin: 8px 0; background: #000; border: 1px solid #444; color: #fff; box-sizing: border-box; }
        .btn-auth { width: 100%; padding: 10px; background: var(--binance-yellow); border: none; font-weight: bold; cursor: pointer; margin-top: 10px; }

        .header-container { background: #0a0a0a; padding: 10px; margin-bottom: 20px; display: flex; flex-direction: column; align-items: center; gap: 10px; border-bottom: 1px solid #222; }
        .logos-row { display: flex; gap: 20px; align-items: center; }
        .logo { height: 30px; }
        .logo-kucoin { height: 30px; filter: grayscale(100%) brightness(80%) sepia(100%) hue-rotate(100deg) saturate(500%); }
        .user-row { background: #1a1a1a; padding: 5px 15px; border-radius: 15px; font-size: 0.9rem; border: 1px solid #333; }
        .logout { color: var(--danger); cursor: pointer; margin-left: 10px; font-weight: bold; }

        .container { max-width: 1200px; margin: 0 auto; }
        .controls-bar { display: flex; flex-wrap: wrap; gap: 10px; background: var(--card-bg); padding: 15px; border-radius: 8px; border: 1px solid #222; align-items: center; }
        .input-group { display: flex; align-items: center; gap: 5px; background: #000; padding: 5px 10px; border: 1px solid #444; border-radius: 4px; }
        .input-group input[type="number"] { width: 50px; background: #222; border: none; color: var(--binance-yellow); font-weight: bold; text-align: center; }
        
        .btn { padding: 8px 15px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; }
        .btn-config { background: #333; color: #fff; }
        .btn-start { background: var(--binance-yellow); color: #000; }
        .btn-stop { background: var(--danger); color: #fff; }
        
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; margin-top: 20px; }
        .card { background: var(--card-bg); border: 1px solid #222; border-radius: 10px; padding: 15px; }
        .card h3 { margin: 0 0 10px 0; color: var(--binance-yellow); font-size: 1rem; border-bottom: 1px solid #333; padding-bottom: 5px; }

        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        th, td { text-align: left; padding: 8px 5px; border-bottom: 1px solid #222; color: #aaa; }
        .text-pos { color: var(--kucoin-green); } .text-neg { color: var(--danger); }
        
        .hide-on-run.active { display: none !important; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: #111; padding: 20px; border: 1px solid #444; width: 90%; max-width: 450px; }
        .modal-content input { width: 100%; padding: 8px; background: #222; border: 1px solid #444; color: #fff; margin-bottom: 10px; box-sizing: border-box; }

        .vip-status { color: gold; font-weight: bold; margin-left: 10px; }
        .vip-btn { background: gold; color: black; font-size: 0.8rem; padding: 2px 5px; border-radius: 3px; cursor: pointer; border: none; margin-left: 5px; }
    </style>
</head>
<body>
    <!-- AUTH -->
    <div id="loginSection" class="auth-overlay">
        <div class="auth-box">
            <h2>LOGIN</h2>
            <input type="text" id="lUser" placeholder="User"><input type="password" id="lPass" placeholder="Pass">
            <button class="btn-auth" onclick="auth('login')">LOGIN</button>
            <div style="margin-top:10px; color:#888; cursor:pointer;" onclick="toggleAuth()">Create Account</div>
        </div>
    </div>
    <div id="registerSection" class="auth-overlay" style="display:none;">
        <div class="auth-box">
            <h2 style="color:var(--kucoin-green)">REGISTER</h2>
            <input type="text" id="rEmail" placeholder="Email"><input type="text" id="rUser" placeholder="User"><input type="password" id="rPass" placeholder="Pass">
            <button class="btn-auth" style="background:var(--kucoin-green)" onclick="auth('register')">REGISTER</button>
            <div style="margin-top:10px; color:#888; cursor:pointer;" onclick="toggleAuth()">Back to Login</div>
        </div>
    </div>

    <!-- MAIN -->
    <div id="mainSection" style="display:none;">
        <div class="header-container">
            <div class="logos-row">
                <img src="https://upload.wikimedia.org/wikipedia/commons/e/e8/Binance_Logo.svg" class="logo">
                <span style="color:#555">‚úñ</span>
                <img src="https://cryptologos.cc/logos/kucoin-token-kcs-logo.png?v=025" class="logo-kucoin">
            </div>
            <div class="user-row">
                <span id="uName">User</span>
                <span id="vipTag" class="vip-status"></span>
                <button id="vipBtn" class="vip-btn" onclick="upgradeVip()" style="display:none">UPGRADE VIP</button>
                <span class="logout" onclick="logout()">LOGOUT</span>
            </div>
        </div>

        <div class="container">
            <div class="controls-bar">
                <div class="input-group hide-on-run">
                    <label><input type="radio" name="cap" value="percent" checked> %</label>
                    <label><input type="radio" name="cap" value="fixed"> $</label>
                </div>
                <div class="input-group hide-on-run">
                    <span>Val:</span><input type="number" id="capVal" value="50">
                </div>
                <div class="hide-on-run" style="display:flex; align-items:center; gap:5px; margin-left:10px;">
                    <input type="checkbox" id="autoBal"> <span style="font-size:0.9rem; color:#ccc;">Auto-Bal</span>
                    <span style="font-size:0.7rem; color:#f0b90b;">(Fee: 10$/day)</span>
                </div>
                
                <div style="flex-grow:1"></div>

                <button class="btn btn-config hide-on-run" onclick="document.getElementById('manualModal').style.display='flex'">üí∏ Transfer</button>
                <button class="btn btn-config hide-on-run" onclick="document.getElementById('cfgModal').style.display='flex'">‚öôÔ∏è Set Bot</button>
                <div class="hide-on-run" style="font-size:0.8rem; color:#888; display:flex; align-items:center;">
                    <input type="checkbox" id="terms" onchange="checkTerms()"> Agree Terms
                </div>
                
                <button id="startBtn" class="btn btn-start" onclick="toggleBot(true)" disabled>START</button>
                <button id="stopBtn" class="btn btn-stop" onclick="toggleBot(false)" style="display:none">STOP</button>
                <span id="status" style="font-weight:bold; color:#777; margin-left:10px;">STOPPED</span>
            </div>

            <div class="grid">
                <div class="card">
                    <h3>Balances</h3>
                    <div id="balContent"></div>
                </div>
                <div class="card">
                    <h3>Opportunity</h3>
                    <div id="oppContent" style="text-align:center; padding:10px;">Searching...</div>
                </div>
            </div>

            <div class="card" style="margin-top:15px">
                <h3>History</h3>
                <table>
                    <thead><tr><th>Time</th><th>Coin</th><th>Lev</th><th>Est%</th><th>Real$</th></tr></thead>
                    <tbody id="histBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- MODALS -->
    <div id="cfgModal" class="modal">
        <div class="modal-content">
            <h3 style="margin-top:0; color:#fff">CONFIG</h3>
            <label style="color:#888; font-size:0.8rem">Binance API Key</label><input id="bk">
            <label style="color:#888; font-size:0.8rem">Binance Secret</label><input id="bs">
            <label style="color:#888; font-size:0.8rem">Binance Wallet (APT)</label><input id="bw">
            <hr style="border-color:#333">
            <label style="color:#888; font-size:0.8rem">Kucoin API Key</label><input id="kk">
            <label style="color:#888; font-size:0.8rem">Kucoin Secret</label><input id="ks">
            <label style="color:#888; font-size:0.8rem">Kucoin Pass</label><input id="kp">
            <label style="color:#888; font-size:0.8rem">Kucoin Wallet (BEP20)</label><input id="kw">
            <button class="btn" style="width:100%; background:var(--kucoin-green)" onclick="saveCfg()">SAVE</button>
            <button class="btn" style="width:100%; background:#333; color:#fff; margin-top:5px" onclick="document.getElementById('cfgModal').style.display='none'">CLOSE</button>
        </div>
    </div>

    <!-- MANUAL TRANSFER MODAL -->
    <div id="manualModal" class="modal">
        <div class="modal-content" style="border-color: #444;">
            <h3 style="margin-top:0; color:#fff">MANUAL TRANSFER</h3>
            <p style="color:#888; font-size:0.8rem; margin-bottom:15px;">Move funds between your configured wallets.</p>
            
            <label style="color:#aaa; font-size:0.8rem">From Exchange</label>
            <select id="tFrom" style="width:100%; padding:8px; background:#222; color:#fff; border:1px solid #555; margin-bottom:10px;">
                <option value="binanceusdm">Binance Future</option>
                <option value="kucoinfutures">Kucoin Future</option>
            </select>

            <label style="color:#aaa; font-size:0.8rem">To Exchange</label>
            <select id="tTo" style="width:100%; padding:8px; background:#222; color:#fff; border:1px solid #555; margin-bottom:10px;">
                <option value="kucoinfutures">Kucoin Future</option>
                <option value="binanceusdm">Binance Future</option>
            </select>

            <label style="color:#aaa; font-size:0.8rem">Amount (USDT)</label>
            <input type="number" id="tAmt" placeholder="e.g. 50">

            <button class="btn" style="width:100%; background:var(--binance-yellow); color:#000" onclick="manualTransfer()">TRANSFER NOW</button>
            <button class="btn" style="width:100%; background:#333; color:#fff; margin-top:5px" onclick="document.getElementById('manualModal').style.display='none'">CLOSE</button>
        </div>
    </div>

    <script>
        let user = localStorage.getItem('bot_user');
        if(user) init(); else document.getElementById('loginSection').style.display='flex';

        function toggleAuth() {
            const l = document.getElementById('loginSection'), r = document.getElementById('registerSection');
            if(l.style.display==='none') { l.style.display='flex'; r.style.display='none'; }
            else { l.style.display='none'; r.style.display='flex'; }
        }

        async function auth(type) {
            const ep = type==='login'?'/bot-api/login':'/bot-api/register';
            const body = type==='login' 
                ? { username: document.getElementById('lUser').value, password: document.getElementById('lPass').value }
                : { username: document.getElementById('rUser').value, password: document.getElementById('rPass').value, email: document.getElementById('rEmail').value };
            
            const res = await fetch(ep, { method:'POST', body:JSON.stringify(body) });
            const d = await res.json();
            if(d.success) { 
                if(type==='login') { user=body.username; localStorage.setItem('bot_user', user); init(); }
                else { alert('Registered'); toggleAuth(); }
            } else alert(d.message || 'Error');
        }

        function logout() { localStorage.removeItem('bot_user'); location.reload(); }

        function init() {
            document.querySelectorAll('.auth-overlay').forEach(e=>e.style.display='none');
            document.getElementById('mainSection').style.display='block';
            document.getElementById('uName').innerText = user;
            loadCfg();
            setInterval(update, 1000);
        }

        async function req(ep, method='GET', body) {
            try {
                const res = await fetch(ep, { method, headers:{'x-username':user}, body:body?JSON.stringify(body):undefined });
                if(res.status===401) logout();
                return await res.json();
            } catch(e) { return null; }
        }

        async function loadCfg() {
            const c = await req('/bot-api/config');
            if(c) {
                document.getElementById('autoBal').checked = c.autoBalance;
                document.getElementById('vipTag').innerText = c.vipStatus === 'vip' ? 'VIP' : (c.vipStatus==='vip_pro'?'VIP PRO':'Standard');
                if(c.vipStatus === 'none') document.getElementById('vipBtn').style.display = 'inline-block';
            }
        }

        async function saveCfg() {
            const body = {
                binanceApiKey: document.getElementById('bk').value, binanceApiSecret: document.getElementById('bs').value, binanceDepositAddress: document.getElementById('bw').value,
                kucoinApiKey: document.getElementById('kk').value, kucoinApiSecret: document.getElementById('ks').value, kucoinPassword: document.getElementById('kp').value, kucoinDepositAddress: document.getElementById('kw').value
            };
            await req('/bot-api/save-config','POST',body);
            document.getElementById('cfgModal').style.display='none';
            alert('Saved');
        }

        function checkTerms() {
            const t = document.getElementById('terms').checked;
            const r = document.getElementById('status').innerText === 'RUNNING';
            document.getElementById('startBtn').disabled = r || !t;
        }

        async function toggleBot(start) {
            if(start) {
                const cfg = {
                    tradeConfig: { mode: document.querySelector('input[name=cap]:checked').value, value: document.getElementById('capVal').value },
                    autoBalance: document.getElementById('autoBal').checked
                };
                await req('/bot-api/start','POST',cfg);
            } else await req('/bot-api/stop','POST');
        }

        async function upgradeVip() {
            if(confirm("Upgrade VIP for 200$?")) {
                const r = await req('/bot-api/upgrade-vip','POST');
                if(r.success) { alert("Upgraded!"); location.reload(); } else alert("Failed (Insufficient funds)");
            }
        }

        async function manualTransfer() {
            const amt = document.getElementById('tAmt').value;
            const from = document.getElementById('tFrom').value;
            const to = document.getElementById('tTo').value;
            if(!amt || from === to) return alert("Invalid inputs");
            if(confirm(`Transfer ${amt}$ from ${from} to ${to}?`)) {
                const r = await req('/bot-api/transfer-funds','POST', { fromExchangeId: from, toExchangeId: to, amount: amt });
                if(r.success) { alert("Transfer Started!"); document.getElementById('manualModal').style.display='none'; } 
                else alert("Failed");
            }
        }

        async function update() {
            const d = await req('/bot-api/status');
            if(!d) return;

            const run = d.botState === 'RUNNING';
            document.getElementById('startBtn').style.display = run ? 'none':'inline-block';
            document.getElementById('stopBtn').style.display = run ? 'inline-block':'none';
            document.getElementById('status').innerText = d.botState;
            document.getElementById('status').style.color = run ? '#00D095':'#777';
            if(run) document.querySelectorAll('.hide-on-run').forEach(e=>e.classList.add('active'));
            else { document.querySelectorAll('.hide-on-run').forEach(e=>e.classList.remove('active')); checkTerms(); }

            let bH = '';
            for(let k in d.balances) bH += `<div style="display:flex;justify-content:space-between;border-bottom:1px solid #333;padding:5px"><span>${k}</span><span>${d.balances[k].available.toFixed(2)}$</span></div>`;
            document.getElementById('balContent').innerHTML = bH;

            if(d.bestPotentialOpportunityForDisplay) {
                const o = d.bestPotentialOpportunityForDisplay;
                document.getElementById('oppContent').innerHTML = `<h2 style="margin:0">${o.coin}</h2><div style="color:var(--kucoin-green)">PNL: ${o.estimatedPnl}%</div>`;
            }

            let hH = '';
            (d.tradeHistory||[]).slice(0,5).forEach(t => {
                const p = t.actualPnl||0;
                hH += `<tr><td>${new Date(t.entryTime).toLocaleTimeString()}</td><td>${t.coin}</td><td>x${t.leverage}</td><td>${t.estimatedPnlFromOpportunity}%</td><td class="${p>=0?'text-pos':'text-neg'}">${p.toFixed(2)}</td></tr>`;
            });
            document.getElementById('histBody').innerHTML = hH;
        }
    </script>
</body>
</html>
