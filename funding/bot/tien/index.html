<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bot Arbitrage UI</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #121212; color: #e0e0e0; margin: 0; padding: 1rem; }
        .container { max-width: 1400px; margin: auto; }
        h1, h2 { color: #bb86fc; text-align: center; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem; }
        .card { background-color: #1e1e1e; border: 1px solid #333; border-radius: 8px; padding: 1rem; margin-top: 1rem; }
        .card h3 { margin-top: 0; color: #03dac6; }
        button { background-color: #6200ee; color: white; border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer; transition: background-color 0.2s; font-size: 14px; }
        button:hover { background-color: #3700b3; }
        button:disabled { background-color: #333; cursor: not-allowed; }
        button.stop { background-color: #cf6679; }
        button.stop:hover { background-color: #b00020; }
        .controls, .manual-controls { display: flex; justify-content: center; align-items: center; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap; }
        input, select { padding: 8px; background-color: #333; color: #e0e0e0; border: 1px solid #555; border-radius: 4px; }
        table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        th, td { padding: 0.75rem; text-align: left; border-bottom: 1px solid #333; }
        th { background-color: #2c2c2c; }
        .text-green { color: #4caf50; }
        .text-red { color: #f44336; }
        .text-yellow { color: #f1c40f; }
        .status-display { margin-top: 1rem; padding: 1rem; background-color: #2c2c2c; border-radius: 4px; min-height: 20px; text-align: center; word-break: break-word; }
    </style>
</head>
<body>
<div class="container">
    <h1>üìà Bot Arbitrage Trading</h1>

    <div class="controls">
        <label for="percentageToUse">V·ªën m·ªói l·ªánh (%):</label>
        <input type="number" id="percentageToUse" value="50" min="1" max="100">
        <button id="startBotBtn">‚ñ∂Ô∏è Start Bot</button>
        <button id="stopBotBtn" class="stop">‚è∏Ô∏è Stop Bot</button>
        <button id="closeTradeBtn" class="stop">üõë ƒê√≥ng l·ªánh ngay</button>
    </div>

    <div class="grid">
        <div class="card">
            <h3>Tr·∫°ng th√°i Bot</h3>
            <p id="botStateDisplay">ƒêang t·∫£i...</p>
        </div>
        <div class="card">
            <h3>S·ªë d∆∞ Futures</h3>
            <div id="balancesDisplay"><p>ƒêang t·∫£i...</p></div>
        </div>
        <div class="card">
            <h3>C∆° h·ªôi T·ªët nh·∫•t</h3>
            <div id="bestOpportunityDisplay"><p>ƒêang t√¨m...</p></div>
        </div>
        <div class="card">
            <h3>Giao d·ªãch Hi·ªán t·∫°i</h3>
            <div id="currentTradeDisplay"><p>Kh√¥ng c√≥.</p></div>
        </div>
    </div>
    
    <div class="grid">
        <div class="card">
            <h2>Chuy·ªÉn ti·ªÅn Ngo·∫°i s√†n</h2>
            <p style="color: #f48fb1;"><strong>C·∫¢NH B√ÅO:</strong> R·ªßi ro cao. Sai ƒë·ªãa ch·ªâ/m·∫°ng c√≥ th·ªÉ M·∫§T TI·ªÄN. API Key ph·∫£i c√≥ quy·ªÅn R√∫t ti·ªÅn.</p>
            <div class="manual-controls">
                <label>T·ª´:</label> <select id="fromExchangeSelect"></select>
                <label>T·ªõi:</label> <select id="toExchangeSelect"></select>
                <label>S·ªë l∆∞·ª£ng USDT:</label> <input type="number" id="transferAmount" value="10" min="1">
                <button id="manualTransferBtn">Chuy·ªÉn ngay</button>
            </div>
            <div id="transferStatusDisplay" class="status-display"></div>
        </div>
        
        <div class="card">
            <h2>Chuy·ªÉn ti·ªÅn N·ªôi b·ªô (Gi·ªØa c√°c v√≠)</h2>
            <p style="color: #80cbc4;">S·ª≠ d·ª•ng khi ti·ªÅn b·ªã k·∫πt ·ªü v√≠ Spot/Main sau khi chuy·ªÉn ngo·∫°i s√†n th·∫•t b·∫°i.</p>
            <div class="manual-controls">
                <label>S√†n:</label> <select id="internalExchangeSelect"></select>
                <label>T·ª´ v√≠:</label>
                <select id="internalFromAccount">
                    <option value="spot">Spot/Main</option>
                    <option value="future">Future</option>
                </select>
                <label>T·ªõi v√≠:</label>
                 <select id="internalToAccount">
                    <option value="future">Future</option>
                    <option value="spot">Spot/Main</option>
                </select>
                <label>S·ªë l∆∞·ª£ng USDT:</label> <input type="number" id="internalAmount" value="10" min="0.1">
                <button id="internalTransferBtn">Chuy·ªÉn N·ªôi b·ªô</button>
            </div>
            <div id="internalTransferStatusDisplay" class="status-display"></div>
        </div>
    </div>

    <div class="card">
        <h2>L·ªãch s·ª≠ Giao d·ªãch</h2>
        <table>
            <thead>
                <tr>
                    <th>Th·ªùi gian</th>
                    <th>Coin</th>
                    <th>S√†n (Short/Long)</th>
                    <!-- START: MODIFIED_CODE_BLOCK_1 -->
                    <th>PNL ∆Ø·ªõc t√≠nh (%)</th>
                    <th>V·ªën s·ª≠ d·ª•ng (USDT)</th>
                    <th>PNL Th·ª±c t·∫ø (USDT)</th>
                    <!-- END: MODIFIED_CODE_BLOCK_1 -->
                </tr>
            </thead>
            <tbody id="tradeHistoryBody"></tbody>
        </table>
    </div>
</div>

<script>
    const fromSelect = document.getElementById('fromExchangeSelect');
    const toSelect = document.getElementById('toExchangeSelect');
    const internalExchangeSelect = document.getElementById('internalExchangeSelect');

    async function updateBotStatus() {
        try {
            const response = await fetch('/bot-api/status');
            const data = await response.json();

            const botStateEl = document.getElementById('botStateDisplay');
            botStateEl.textContent = data.botState;
            botStateEl.className = data.botState === 'RUNNING' ? 'text-green' : 'text-red';

            let balancesHtml = '';
            for (const id in data.balances) {
                const health = data.exchangeHealth[id];
                const healthStatus = health.isDisabled ? ` (<span class="text-red">M·∫•t k·∫øt n·ªëi</span>)` : '';
                balancesHtml += `<p><strong>${id.toUpperCase()}:</strong> ${data.balances[id].available.toFixed(2)} USDT ${healthStatus}</p>`;
            }
            document.getElementById('balancesDisplay').innerHTML = balancesHtml;

            const oppEl = document.getElementById('bestOpportunityDisplay');
            if (data.bestPotentialOpportunityForDisplay) {
                const opp = data.bestPotentialOpportunityForDisplay;
                // START: MODIFIED_CODE_BLOCK_2
                let estimatedAmountHtml = '---';
                if (data.estimatedOpenAmount !== null && data.estimatedOpenAmount > 0) {
                    estimatedAmountHtml = data.estimatedOpenAmount.toFixed(4);
                }
                oppEl.innerHTML = `
                    <p><strong>Coin:</strong> ${opp.coin}</p>
                    <p><strong>S√†n:</strong> ${opp.exchanges}</p>
                    <p><strong>PNL ∆∞·ªõc t√≠nh:</strong> ${opp.estimatedPnl.toFixed(3)}%</p>
                    <p><strong>S·ªë ti·ªÅn m·ªü l·ªánh ∆∞·ªõc t√≠nh:</strong> <span class="text-yellow">${estimatedAmountHtml}</span> USDT</p>
                `;
                // END: MODIFIED_CODE_BLOCK_2
            } else {
                oppEl.innerHTML = '<p>Kh√¥ng c√≥ c∆° h·ªôi n√†o kh·∫£ d·ª•ng.</p>';
            }

            const tradeEl = document.getElementById('currentTradeDisplay');
            if (data.currentTradeDetails) {
                const trade = data.currentTradeDetails;
                tradeEl.innerHTML = `<p><strong>Coin:</strong> ${trade.coin}</p><p><strong>Tr·∫°ng th√°i:</strong> ${trade.status}</p><p><strong>Short:</strong> ${trade.shortExchange.toUpperCase()}</p><p><strong>Long:</strong> ${trade.longExchange.toUpperCase()}</p>`;
            } else {
                tradeEl.innerHTML = '<p>Kh√¥ng c√≥ giao d·ªãch n√†o ƒëang m·ªü.</p>';
            }

            const historyBody = document.getElementById('tradeHistoryBody');
            historyBody.innerHTML = '';
            // START: MODIFIED_CODE_BLOCK_3
            data.tradeHistory.forEach(trade => {
                const row = historyBody.insertRow();
                row.insertCell().textContent = new Date(trade.closeTime || trade.openTime).toLocaleString('vi-VN');
                row.insertCell().textContent = trade.coin;
                row.insertCell().textContent = `${trade.shortExchange.toUpperCase()}/${trade.longExchange.toUpperCase()}`;
                
                // Th√™m c√°c c·ªôt m·ªõi
                row.insertCell().textContent = trade.estimatedPnlFromOpportunity ? trade.estimatedPnlFromOpportunity.toFixed(2) + '%' : 'N/A';
                row.insertCell().textContent = trade.collateralUsed ? trade.collateralUsed.toFixed(4) : 'N/A';

                const pnlCell = row.insertCell();
                pnlCell.textContent = trade.actualPnl ? trade.actualPnl.toFixed(4) + ' USDT' : 'N/A';
                pnlCell.className = trade.actualPnl >= 0 ? 'text-green' : 'text-red';
            });
            // END: MODIFIED_CODE_BLOCK_3
            
            if (fromSelect.options.length === 0 && data.transferExchanges) {
                 populateExternalDropdowns(data.transferExchanges);
            }
            if (internalExchangeSelect.options.length === 0 && data.internalTransferExchanges) {
                 populateInternalDropdowns(data.internalTransferExchanges);
            }

        } catch (error) {
            console.error('L·ªói c·∫≠p nh·∫≠t tr·∫°ng th√°i:', error);
            document.getElementById('botStateDisplay').textContent = 'L·ªñI K·∫æT N·ªêI';
        }
    }

    function populateExternalDropdowns(exchanges) {
        exchanges.forEach(id => {
            fromSelect.add(new Option(id.toUpperCase(), id));
            toSelect.add(new Option(id.toUpperCase(), id));
        });
        if (exchanges.includes('binanceusdm')) fromSelect.value = 'binanceusdm';
        if (exchanges.includes('kucoinfutures')) toSelect.value = 'kucoinfutures';
    }

    function populateInternalDropdowns(exchanges) {
        exchanges.forEach(id => {
            internalExchangeSelect.add(new Option(id.toUpperCase(), id));
        });
    }

    async function postRequest(url, body, statusElementId) {
        const statusEl = document.getElementById(statusElementId);
        if (statusEl) statusEl.innerHTML = `<span class="text-yellow">ƒêang x·ª≠ l√Ω...</span>`;
        
        const button = event.target;
        button.disabled = true;

        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body),
            });
            const data = await response.json();
            const messageColor = data.success ? 'text-green' : 'text-red';
            if (statusEl) statusEl.innerHTML = `<span class="${messageColor}">${data.message}</span>`;
            else alert(data.message);
            
            setTimeout(updateBotStatus, 2000);
        } catch (error) {
            if (statusEl) statusEl.innerHTML = `<span class="text-red">L·ªói: ${error.message}</span>`;
            else alert(`L·ªói: ${error.message}`);
            console.error(`L·ªói request t·ªõi ${url}:`, error);
        } finally {
            button.disabled = false;
        }
    }
    
    document.getElementById('startBotBtn').addEventListener('click', (e) => postRequest('/bot-api/start', { percentageToUse: document.getElementById('percentageToUse').value }, null));
    document.getElementById('stopBotBtn').addEventListener('click', (e) => postRequest('/bot-api/stop', {}, null));
    document.getElementById('closeTradeBtn').addEventListener('click', (e) => postRequest('/bot-api/close-trade-now', {}, null));
    
    document.getElementById('manualTransferBtn').addEventListener('click', (e) => {
        postRequest('/bot-api/transfer-funds', {
            fromExchangeId: fromSelect.value,
            toExchangeId: toSelect.value,
            amountStr: document.getElementById('transferAmount').value
        }, 'transferStatusDisplay');
    });

    document.getElementById('internalTransferBtn').addEventListener('click', (e) => {
        const fromAccount = document.getElementById('internalFromAccount').value;
        const toAccount = document.getElementById('internalToAccount').value;
        
        if (fromAccount === toAccount) {
            document.getElementById('internalTransferStatusDisplay').innerHTML = `<span class="text-red">Kh√¥ng th·ªÉ chuy·ªÉn gi·ªØa c√πng m·ªôt lo·∫°i v√≠.</span>`;
            return;
        }

        postRequest('/bot-api/internal-transfer', {
            exchangeId: internalExchangeSelect.value,
            fromAccount: fromAccount,
            toAccount: toAccount,
            amountStr: document.getElementById('internalAmount').value
        }, 'internalTransferStatusDisplay');
    });

    updateBotStatus();
    setInterval(updateBotStatus, 5000);
</script>
</body>
</html>```
