<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Bot Arbitrage</title>
    <style>
        /* --- C√†i ƒë·∫∑t g·ªëc & Font ch·ªØ --- */
        :root {
            --bg-color: #0d1117;
            --card-color: #161b22;
            --border-color: #30363d;
            --text-color: #c9d1d9;
            --text-secondary-color: #8b949e;
            --primary-color: #58a6ff;
            --primary-hover-color: #79c0ff;
            --green-color: #3fb950;
            --red-color: #f85149;
            --yellow-color: #d29922;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji";
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 1.5rem;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* --- Layout ch√≠nh --- */
        .container {
            max-width: 1600px;
            margin: auto;
        }

        h1, h2 {
            text-align: center;
            font-weight: 600;
        }

        h1 {
            font-size: 2.5rem;
            color: var(--primary-color);
            margin-bottom: 2rem;
            letter-spacing: 1px;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        /* --- Th·∫ª (Card) --- */
        .card {
            background-color: var(--card-color);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(88, 166, 255, 0.1);
        }

        .card h3 {
            margin-top: 0;
            color: var(--primary-hover-color);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.75rem;
            margin-bottom: 1rem;
        }
        
        .card h2 {
             color: var(--primary-color);
        }

        /* --- N√∫t b·∫•m & Form --- */
        button {
            background-color: var(--primary-color);
            color: #ffffff;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            font-size: 14px;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        button:hover {
            background-color: var(--primary-hover-color);
            transform: scale(1.03);
        }
        
        button:active {
            transform: scale(0.98);
        }

        button:disabled {
            background-color: #21262d;
            color: var(--text-secondary-color);
            cursor: not-allowed;
            transform: none;
        }

        button.stop { background-color: var(--red-color); }
        button.stop:hover { background-color: #ff756f; }

        .controls, .manual-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            background-color: var(--card-color);
            padding: 1.5rem;
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }
        
        .manual-controls {
            flex-direction: column;
            gap: 1.2rem;
            align-items: stretch;
            margin-bottom: 0;
        }
        
        .manual-controls > * {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        input, select {
            width: 50%;
            padding: 10px;
            background-color: var(--bg-color);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.3);
        }

        /* --- B·∫£ng d·ªØ li·ªáu --- */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        th, td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            background-color: #10151c;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 1px;
        }
        
        tbody tr {
            transition: background-color 0.15s ease;
        }
        
        tbody tr:hover {
            background-color: #1c222c;
        }

        /* --- Helper Classes --- */
        .text-green { color: var(--green-color); }
        .text-red { color: var(--red-color); }
        .text-yellow { color: var(--yellow-color); }
        .text-blue { color: var(--primary-hover-color); }
        
        .status-display {
            margin-top: 1rem;
            padding: 1rem;
            background-color: var(--bg-color);
            border-radius: 8px;
            min-height: 20px;
            text-align: center;
            word-break: break-word;
            font-weight: 500;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>Dashboard Bot Arbitrage</h1>

    <div class="controls">
        <label for="percentageToUse">V·ªën m·ªói l·ªánh (%):</label>
        <input type="number" id="percentageToUse" value="50" min="1" max="100" style="width: 80px;">
        <button id="startBotBtn">‚ñ∂Ô∏è Start Bot</button>
        <button id="stopBotBtn" class="stop">‚è∏Ô∏è Stop Bot</button>
        <button id="closeTradeBtn" class="stop">üõë ƒê√≥ng l·ªánh & D·ªçn d·∫πp</button>
    </div>

    <div class="grid">
        <div class="card">
            <h3>Tr·∫°ng th√°i Bot</h3>
            <p><strong>Tr·∫°ng th√°i chung:</strong> <span id="botStateDisplay">ƒêang t·∫£i...</span></p>
            <p><strong>H√†nh ƒë·ªông hi·ªán t·∫°i:</strong> <span id="capitalStateDisplay">...</span></p>
        </div>
        <div class="card">
            <h3>S·ªë d∆∞ Futures</h3>
            <div id="balancesDisplay"><p>ƒêang t·∫£i...</p></div>
        </div>
        <div class="card">
            <h3>C∆° h·ªôi T·ªët nh·∫•t</h3>
            <div id="bestOpportunityDisplay"><p>ƒêang t√¨m...</p></div>
        </div>
        <div class="card">
            <h3>Giao d·ªãch Hi·ªán t·∫°i</h3>
            <div id="currentTradeDisplay"><p>Kh√¥ng c√≥.</p></div>
        </div>
    </div>
    
    <div class="grid">
         <div class="card">
            <h2>Test L·ªánh Nhanh</h2>
            <p style="color: var(--text-secondary-color);">D√πng c∆° h·ªôi t·ªët nh·∫•t hi·ªán t·∫°i ƒë·ªÉ v√†o l·ªánh th·ªß c√¥ng v·ªõi c√°c th√¥ng s·ªë t√πy ch·ªânh.</p>
            <div class="manual-controls" id="test-trade-form">
                <div><label>Short tr√™n:</label> <select id="testShortExchange"></select></div>
                <div><label>Long tr√™n:</label> <select id="testLongExchange"></select></div>
                <div><label>ƒê√≤n b·∫©y:</label> <input type="number" id="testLeverage" value="20" min="1"></div>
                <div><label>% V·ªën:</label> <input type="number" id="testPercentage" value="10" min="1" max="100"></div>
                <button id="testTradeBtn">G·ª≠i L·ªánh Test</button>
            </div>
            <div id="testStatusDisplay" class="status-display"></div>
        </div>
        <div class="card">
            <h2>Chuy·ªÉn ti·ªÅn Ngo·∫°i s√†n</h2>
            <p style="color: var(--red-color); font-weight: 500;"><strong>C·∫¢NH B√ÅO:</strong> R·ªßi ro cao. Sai ƒë·ªãa ch·ªâ/m·∫°ng c√≥ th·ªÉ M·∫§T TI·ªÄN. API Key ph·∫£i c√≥ quy·ªÅn R√∫t ti·ªÅn.</p>
            <div class="manual-controls">
                <div><label>T·ª´:</label> <select id="fromExchangeSelect"></select></div>
                <div><label>T·ªõi:</label> <select id="toExchangeSelect"></select></div>
                <div><label>S·ªë l∆∞·ª£ng USDT:</label> <input type="number" id="transferAmount" value="10" min="1"></div>
                <button id="manualTransferBtn">Chuy·ªÉn ngay</button>
            </div>
            <div id="transferStatusDisplay" class="status-display"></div>
        </div>
        
        <div class="card">
            <h2>Chuy·ªÉn ti·ªÅn N·ªôi b·ªô</h2>
            <p style="color: var(--text-secondary-color);">Chuy·ªÉn USDT gi·ªØa c√°c v√≠ Spot v√† Future tr√™n c√πng m·ªôt s√†n.</p>
            <div class="manual-controls">
                <div><label>S√†n:</label> <select id="internalExchangeSelect"></select></div>
                <div><label>T·ª´ v√≠:</label>
                <select id="internalFromAccount">
                    <option value="spot">Spot/Main</option>
                    <option value="future">Future</option>
                </select></div>
                <div><label>T·ªõi v√≠:</label>
                 <select id="internalToAccount">
                    <option value="future">Future</option>
                    <option value="spot">Spot/Main</option>
                </select></div>
                <div><label>S·ªë l∆∞·ª£ng USDT:</label> <input type="number" id="internalAmount" value="10" min="0.1"></div>
                <button id="internalTransferBtn">Chuy·ªÉn N·ªôi b·ªô</button>
            </div>
            <div id="internalTransferStatusDisplay" class="status-display"></div>
        </div>
    </div>

    <div class="card">
        <h2>L·ªãch s·ª≠ Giao d·ªãch</h2>
        <table>
            <thead>
                <tr>
                    <th>Th·ªùi gian</th>
                    <th>Coin</th>
                    <th>S√†n (Short/Long)</th>
                    <th>PNL ∆Ø·ªõc t√≠nh (%)</th>
                    <th>V·ªën (USDT)</th>
                    <th>PNL Th·ª±c t·∫ø (USDT)</th>
                    <th>T·ªîNG PNL (C·ªông d·ªìn)</th>
                </tr>
            </thead>
            <tbody id="tradeHistoryBody"></tbody>
        </table>
    </div>
</div>

<script>
    const startBotBtn = document.getElementById('startBotBtn');
    const stopBotBtn = document.getElementById('stopBotBtn');
    const testTradeBtn = document.getElementById('testTradeBtn');
    const testShortExchange = document.getElementById('testShortExchange');
    const testLongExchange = document.getElementById('testLongExchange');
    const fromSelect = document.getElementById('fromExchangeSelect');
    const toSelect = document.getElementById('toExchangeSelect');
    const internalExchangeSelect = document.getElementById('internalExchangeSelect');
    const manualTransferBtn = document.getElementById('manualTransferBtn');
    const internalTransferBtn = document.getElementById('internalTransferBtn');
    
    let activeExchangesInitialized = false;

    async function updateBotStatus() {
        try {
            const response = await fetch('/bot-api/status');
            const data = await response.json();

            // C·∫≠p nh·∫≠t Tr·∫°ng th√°i Bot
            const botStateEl = document.getElementById('botStateDisplay');
            botStateEl.textContent = data.botState;
            botStateEl.className = data.botState === 'RUNNING' ? 'text-green' : 'text-red';
            startBotBtn.disabled = data.botState === 'RUNNING';
            stopBotBtn.disabled = data.botState !== 'RUNNING';
            
            const capitalStateEl = document.getElementById('capitalStateDisplay');
            capitalStateEl.textContent = data.capitalManagementState || 'N/A';
            switch(data.capitalManagementState) {
                case 'PREPARING_FUNDS': case 'CLEANING_UP':
                    capitalStateEl.className = 'text-yellow'; break;
                case 'TRADE_OPEN':
                    capitalStateEl.className = 'text-green'; break;
                case 'FUNDS_READY':
                    capitalStateEl.className = 'text-blue'; break;
                default:
                    capitalStateEl.className = '';
            }

            const isBotBusy = data.botState === 'RUNNING' && data.capitalManagementState !== 'IDLE' && data.capitalManagementState !== 'FUNDS_READY';
            manualTransferBtn.disabled = isBotBusy;
            internalTransferBtn.disabled = isBotBusy;
            testTradeBtn.disabled = isBotBusy;

            // C·∫≠p nh·∫≠t S·ªë d∆∞ (ƒê√£ l·ªçc b·ªè Binance Spot v√† Kucoin Spot)
            let balancesHtml = '';
            for (const id in data.balances) {
                if (id === 'binance' || id === 'kucoin') continue; // ·∫®n v√≠ Spot
                
                const health = data.exchangeHealth[id];
                const healthStatus = health.isDisabled ? ` (<span class="text-red">M·∫•t k·∫øt n·ªëi</span>)` : '';
                balancesHtml += `<p><strong>${id.toUpperCase()}:</strong> ${data.balances[id].available.toFixed(2)} USDT ${healthStatus}</p>`;
            }
            document.getElementById('balancesDisplay').innerHTML = balancesHtml;

            // C·∫≠p nh·∫≠t C∆° h·ªôi (Th√™m hi·ªÉn th·ªã Funding Diff)
            const oppEl = document.getElementById('bestOpportunityDisplay');
            if (data.bestPotentialOpportunityForDisplay) {
                const opp = data.bestPotentialOpportunityForDisplay;
                // Gi·∫£ ƒë·ªãnh server g·ª≠i v·ªÅ ch√™nh l·ªách funding, n·∫øu kh√¥ng c√≥ th√¨ t·ª± t√≠nh ho·∫∑c ƒë·ªÉ N/A
                const fundingDiff = opp.fundingDiff !== undefined ? opp.fundingDiff.toFixed(4) + '%' : 'N/A';
                
                oppEl.innerHTML = `
                    <p><strong>Coin:</strong> ${opp.coin}</p>
                    <p><strong>S√†n:</strong> ${opp.exchanges}</p>
                    <p><strong>PNL ∆∞·ªõc t√≠nh:</strong> <span class="text-green">${opp.estimatedPnl.toFixed(3)}%</span></p>
                    <p><strong>Ch√™nh l·ªách Funding:</strong> ${fundingDiff}</p>
                `;
            } else {
                oppEl.innerHTML = '<p>Kh√¥ng c√≥ c∆° h·ªôi n√†o kh·∫£ d·ª•ng.</p>';
            }

            // C·∫≠p nh·∫≠t Giao d·ªãch Hi·ªán t·∫°i
            const tradeEl = document.getElementById('currentTradeDisplay');
            if (data.currentTradeDetails) {
                const trade = data.currentTradeDetails;
                tradeEl.innerHTML = `<p><strong>Coin:</strong> ${trade.coin}</p><p><strong>Tr·∫°ng th√°i:</strong> ${trade.status}</p><p><strong>Short:</strong> ${trade.shortExchange.toUpperCase()}</p><p><strong>Long:</strong> ${trade.longExchange.toUpperCase()}</p>`;
            } else {
                tradeEl.innerHTML = '<p>Kh√¥ng c√≥ giao d·ªãch n√†o ƒëang m·ªü.</p>';
            }

            // C·∫≠p nh·∫≠t L·ªãch s·ª≠ & T√≠nh PNL C·ªông d·ªìn
            const historyBody = document.getElementById('tradeHistoryBody');
            historyBody.innerHTML = '';
            
            let cumulativePnl = 0;
            // ƒê·∫£o ng∆∞·ª£c m·∫£ng ƒë·ªÉ t√≠nh t·ª´ c≈© ƒë·∫øn m·ªõi (n·∫øu server g·ª≠i v·ªÅ m·ªõi nh·∫•t ·ªü index 0)
            const historySorted = [...data.tradeHistory].reverse(); 
            
            // T√≠nh to√°n c·ªông d·ªìn
            const historyWithCumulative = historySorted.map(trade => {
                const pnl = trade.actualPnl || 0;
                cumulativePnl += pnl;
                return { ...trade, cumulativeTotal: cumulativePnl };
            });

            // ƒê·∫£o ng∆∞·ª£c l·∫°i ƒë·ªÉ hi·ªÉn th·ªã m·ªõi nh·∫•t l√™n ƒë·∫ßu
            const finalHistoryToDisplay = historyWithCumulative.reverse();

            finalHistoryToDisplay.forEach(trade => {
                const row = historyBody.insertRow();
                row.insertCell().textContent = new Date(trade.closeTime || trade.openTime).toLocaleString('vi-VN');
                row.insertCell().textContent = trade.coin;
                row.insertCell().textContent = `${trade.shortExchange.toUpperCase()}/${trade.longExchange.toUpperCase()}`;
                row.insertCell().textContent = trade.estimatedPnlFromOpportunity ? trade.estimatedPnlFromOpportunity.toFixed(2) + '%' : 'N/A';
                row.insertCell().textContent = trade.collateralUsed ? trade.collateralUsed.toFixed(2) : 'N/A';
                
                const pnlCell = row.insertCell();
                pnlCell.textContent = trade.actualPnl ? trade.actualPnl.toFixed(4) + ' USDT' : '0.0000';
                pnlCell.className = (trade.actualPnl >= 0) ? 'text-green' : 'text-red';

                // C·ªôt T·ªïng PNL C·ªông d·ªìn
                const totalCell = row.insertCell();
                totalCell.textContent = trade.cumulativeTotal.toFixed(4) + ' USDT';
                totalCell.className = (trade.cumulativeTotal >= 0) ? 'text-green' : 'text-red';
                totalCell.style.fontWeight = 'bold';
            });
            
            if (!activeExchangesInitialized && data.activeExchangeIds) {
                populateDropdowns(data.activeExchangeIds, [testShortExchange, testLongExchange, internalExchangeSelect]);
                populateDropdowns(data.transferExchanges || [], [fromSelect, toSelect]);
                activeExchangesInitialized = true;
            }
        } catch (error) {
            console.error('L·ªói c·∫≠p nh·∫≠t tr·∫°ng th√°i:', error);
            document.getElementById('botStateDisplay').textContent = 'L·ªñI K·∫æT N·ªêI';
        }
    }
    
    function populateDropdowns(exchanges, dropdowns) {
        if (!exchanges || exchanges.length === 0) return;
        dropdowns.forEach(dropdown => {
            if (!dropdown) return;
            dropdown.innerHTML = ''; 
            exchanges.forEach(id => {
                dropdown.add(new Option(id.toUpperCase(), id));
            });
        });
    }

    async function postRequest(url, body) {
        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body),
            });
            return await response.json();
        } catch (error) {
            console.error(`L·ªói request t·ªõi ${url}:`, error);
            return { success: false, message: `L·ªói k·∫øt n·ªëi: ${error.message}` };
        }
    }
    
    startBotBtn.addEventListener('click', async () => {
        const result = await postRequest('/bot-api/start', { percentageToUse: document.getElementById('percentageToUse').value });
        alert(result.message);
        updateBotStatus();
    });

    stopBotBtn.addEventListener('click', async () => {
        const result = await postRequest('/bot-api/stop', {});
        alert(result.message);
        updateBotStatus();
    });

    document.getElementById('closeTradeBtn').addEventListener('click', async () => {
        if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën ƒë√≥ng l·ªánh v√† b·∫Øt ƒë·∫ßu qu√° tr√¨nh d·ªçn d·∫πp kh√¥ng?')) {
            const result = await postRequest('/bot-api/close-trade-now', {});
            alert(result.message);
            updateBotStatus();
        }
    });
    
    testTradeBtn.addEventListener('click', async (e) => {
        const statusEl = document.getElementById('testStatusDisplay');
        statusEl.textContent = 'ƒêang g·ª≠i l·ªánh...';
        statusEl.className = 'text-yellow';
        
        const payload = {
            shortExchange: testShortExchange.value,
            longExchange: testLongExchange.value,
            leverage: document.getElementById('testLeverage').value,
            percentage: document.getElementById('testPercentage').value,
        };
        
        const result = await postRequest('/bot-api/custom-test-trade', payload);
        
        statusEl.textContent = result.message;
        statusEl.className = result.success ? 'text-green' : 'text-red';
        
        setTimeout(() => { statusEl.textContent = ''; }, 5000);
        updateBotStatus();
    });

    manualTransferBtn.addEventListener('click', async (e) => {
        const statusEl = document.getElementById('transferStatusDisplay');
        statusEl.textContent = 'ƒêang g·ª≠i y√™u c·∫ßu...';
        statusEl.className = 'text-yellow';
        const result = await postRequest('/bot-api/transfer-funds', {
            fromExchangeId: fromSelect.value,
            toExchangeId: toSelect.value,
            amountStr: document.getElementById('transferAmount').value
        });
        statusEl.textContent = result.message;
        statusEl.className = result.success ? 'text-green' : 'text-red';
    });

    internalTransferBtn.addEventListener('click', async (e) => {
        const statusEl = document.getElementById('internalTransferStatusDisplay');
        statusEl.textContent = 'ƒêang g·ª≠i y√™u c·∫ßu...';
        statusEl.className = 'text-yellow';
        const result = await postRequest('/bot-api/internal-transfer', {
            exchangeId: internalExchangeSelect.value,
            fromAccount: document.getElementById('internalFromAccount').value,
            toAccount: document.getElementById('internalToAccount').value,
            amountStr: document.getElementById('internalAmount').value
        });
        statusEl.textContent = result.message;
        statusEl.className = result.success ? 'text-green' : 'text-red';
    });

    updateBotStatus();
    setInterval(updateBotStatus, 3000);
</script>
</body>
</html>
