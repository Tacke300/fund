<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bot Arbitrage UI</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #121212; color: #e0e0e0; margin: 0; padding: 1rem; }
        .container { max-width: 1400px; margin: auto; }
        h1, h2 { color: #bb86fc; text-align: center; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem; }
        .card { background-color: #1e1e1e; border: 1px solid #333; border-radius: 8px; padding: 1rem; }
        .card h3 { margin-top: 0; color: #03dac6; }
        button { background-color: #6200ee; color: white; border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer; transition: background-color 0.2s; }
        button:hover { background-color: #3700b3; }
        button.stop { background-color: #cf6679; }
        button.stop:hover { background-color: #b00020; }
        .controls, .manual-controls { display: flex; justify-content: center; align-items: center; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap; }
        input, select { padding: 8px; background-color: #333; color: #e0e0e0; border: 1px solid #555; border-radius: 4px; }
        table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        th, td { padding: 0.75rem; text-align: left; border-bottom: 1px solid #333; }
        th { background-color: #2c2c2c; }
        .text-green { color: #4caf50; }
        .text-red { color: #f44336; }
        #transferStatusDisplay { margin-top: 1rem; padding: 1rem; background-color: #2c2c2c; border-radius: 4px; min-height: 20px; text-align: center; }
    </style>
</head>
<body>
<div class="container">
    <h1>üìà Bot Arbitrage Trading</h1>

    <div class="controls">
        <label for="percentageToUse">V·ªën m·ªói l·ªánh (%):</label>
        <input type="number" id="percentageToUse" value="50" min="1" max="100">
        <button id="startBotBtn">‚ñ∂Ô∏è Start Bot</button>
        <button id="stopBotBtn" class="stop">‚è∏Ô∏è Stop Bot</button>
        <button id="closeTradeBtn" class="stop">üõë ƒê√≥ng l·ªánh ngay</button>
    </div>

    <div class="grid">
        <div class="card">
            <h3>Tr·∫°ng th√°i Bot</h3>
            <p id="botStateDisplay">ƒêang t·∫£i...</p>
        </div>
        <div class="card">
            <h3>S·ªë d∆∞</h3>
            <div id="balancesDisplay"><p>ƒêang t·∫£i...</p></div>
        </div>
        <div class="card">
            <h3>C∆° h·ªôi T·ªët nh·∫•t</h3>
            <div id="bestOpportunityDisplay"><p>ƒêang t√¨m...</p></div>
        </div>
        <div class="card">
            <h3>Giao d·ªãch Hi·ªán t·∫°i</h3>
            <div id="currentTradeDisplay"><p>Kh√¥ng c√≥.</p></div>
        </div>
    </div>
    
    <div class="card" style="margin-top: 1rem;">
        <h2>Chuy·ªÉn ti·ªÅn Th·ªß c√¥ng</h2>
        <p style="color: #f48fb1;"><strong>C·∫¢NH B√ÅO:</strong> R·ªßi ro cao. Sai ƒë·ªãa ch·ªâ ho·∫∑c m·∫°ng l∆∞·ªõi c√≥ th·ªÉ M·∫§T TI·ªÄN. API Key ph·∫£i c√≥ quy·ªÅn R√∫t ti·ªÅn.</p>
        <div class="manual-controls">
            <label>T·ª´:</label> <select id="fromExchangeSelect"></select>
            <label>T·ªõi:</label> <select id="toExchangeSelect"></select>
            <label>S·ªë l∆∞·ª£ng USDT:</label> <input type="number" id="transferAmount" value="10" min="1">
            <button id="manualTransferBtn">Chuy·ªÉn ngay</button>
        </div>
        <div id="transferStatusDisplay"></div>
    </div>

    <div class="card" style="margin-top: 1rem;">
        <h2>L·ªãch s·ª≠ Giao d·ªãch</h2>
        <table>
            <thead>
                <tr>
                    <th>Th·ªùi gian</th>
                    <th>Coin</th>
                    <th>S√†n (Short/Long)</th>
                    <th>PNL Th·ª±c t·∫ø</th>
                </tr>
            </thead>
            <tbody id="tradeHistoryBody"></tbody>
        </table>
    </div>
</div>

<script>
    const fromSelect = document.getElementById('fromExchangeSelect');
    const toSelect = document.getElementById('toExchangeSelect');
    const transferStatusDisplay = document.getElementById('transferStatusDisplay');

    async function updateBotStatus() {
        try {
            const response = await fetch('/bot-api/status');
            const data = await response.json();

            const botStateEl = document.getElementById('botStateDisplay');
            botStateEl.textContent = data.botState;
            botStateEl.className = data.botState === 'RUNNING' ? 'text-green' : 'text-red';

            let balancesHtml = '';
            for (const id in data.balances) {
                const health = data.exchangeHealth[id];
                const healthStatus = health.isDisabled ? ` (<span class="text-red">M·∫•t k·∫øt n·ªëi</span>)` : '';
                balancesHtml += `<p><strong>${id.toUpperCase()}:</strong> ${data.balances[id].available.toFixed(2)} USDT ${healthStatus}</p>`;
            }
            document.getElementById('balancesDisplay').innerHTML = balancesHtml;

            const oppEl = document.getElementById('bestOpportunityDisplay');
            if (data.bestPotentialOpportunityForDisplay) {
                const opp = data.bestPotentialOpportunityForDisplay;
                oppEl.innerHTML = `<p><strong>Coin:</strong> ${opp.coin}</p><p><strong>S√†n:</strong> ${opp.exchanges}</p><p><strong>PNL ∆∞·ªõc t√≠nh:</strong> ${opp.estimatedPnl.toFixed(3)}%</p>`;
            } else {
                oppEl.innerHTML = '<p>Kh√¥ng c√≥ c∆° h·ªôi n√†o kh·∫£ d·ª•ng.</p>';
            }

            const tradeEl = document.getElementById('currentTradeDisplay');
            if (data.currentTradeDetails) {
                const trade = data.currentTradeDetails;
                tradeEl.innerHTML = `<p><strong>Coin:</strong> ${trade.coin}</p><p><strong>Tr·∫°ng th√°i:</strong> ${trade.status}</p><p><strong>Short:</strong> ${trade.shortExchange.toUpperCase()}</p><p><strong>Long:</strong> ${trade.longExchange.toUpperCase()}</p>`;
            } else {
                tradeEl.innerHTML = '<p>Kh√¥ng c√≥ giao d·ªãch n√†o ƒëang m·ªü.</p>';
            }

            const historyBody = document.getElementById('tradeHistoryBody');
            historyBody.innerHTML = '';
            data.tradeHistory.forEach(trade => {
                const row = historyBody.insertRow();
                row.insertCell().textContent = new Date(trade.closeTime || trade.openTime).toLocaleString('vi-VN');
                row.insertCell().textContent = trade.coin;
                row.insertCell().textContent = `${trade.shortExchange.toUpperCase()}/${trade.longExchange.toUpperCase()}`;
                const pnlCell = row.insertCell();
                pnlCell.textContent = trade.actualPnl ? trade.actualPnl.toFixed(4) + ' USDT' : 'N/A';
                pnlCell.className = trade.actualPnl >= 0 ? 'text-green' : 'text-red';
            });
            
            if (fromSelect.options.length === 0 && data.transferExchanges) {
                 populateExchangeDropdowns(data.transferExchanges);
            }

        } catch (error) {
            console.error('L·ªói c·∫≠p nh·∫≠t tr·∫°ng th√°i:', error);
            document.getElementById('botStateDisplay').textContent = 'L·ªñI K·∫æT N·ªêI';
        }
    }

    function populateExchangeDropdowns(exchanges) {
        exchanges.forEach(id => {
            fromSelect.add(new Option(id.toUpperCase(), id));
            toSelect.add(new Option(id.toUpperCase(), id));
        });
        if (exchanges.includes('binanceusdm')) fromSelect.value = 'binanceusdm';
        if (exchanges.includes('kucoinfutures')) toSelect.value = 'kucoinfutures';
    }

    async function postRequest(url, body) {
        transferStatusDisplay.innerHTML = `<span style="color: #f1fa8c;">ƒêang x·ª≠ l√Ω...</span>`;
        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body),
            });
            const data = await response.json();
            const messageColor = data.success ? 'text-green' : 'text-red';
            transferStatusDisplay.innerHTML = `<span class="${messageColor}">${data.message}</span>`;
            updateBotStatus();
        } catch (error) {
            transferStatusDisplay.innerHTML = `<span class="text-red">L·ªói: ${error.message}</span>`;
            console.error(`L·ªói request t·ªõi ${url}:`, error);
        }
    }
    
    document.getElementById('startBotBtn').addEventListener('click', () => postRequest('/bot-api/start', { percentageToUse: document.getElementById('percentageToUse').value }));
    document.getElementById('stopBotBtn').addEventListener('click', () => postRequest('/bot-api/stop', {}));
    document.getElementById('closeTradeBtn').addEventListener('click', () => postRequest('/bot-api/close-trade-now', {}));
    document.getElementById('manualTransferBtn').addEventListener('click', () => {
        postRequest('/bot-api/transfer-funds', {
            fromExchangeId: fromSelect.value,
            toExchangeId: toSelect.value,
            amountStr: document.getElementById('transferAmount').value
        });
    });

    updateBotStatus();
    setInterval(updateBotStatus, 5000);
</script>
</body>
</html>
