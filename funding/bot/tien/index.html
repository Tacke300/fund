<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bot Arbitrage UI</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #121212; color: #e0e0e0; margin: 0; padding: 1rem; }
        .container { max-width: 1400px; margin: auto; }
        h1, h2 { color: #bb86fc; text-align: center; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem; }
        .card { background-color: #1e1e1e; border: 1px solid #333; border-radius: 8px; padding: 1rem; margin-top: 1rem; }
        .card h3 { margin-top: 0; color: #03dac6; }
        button { background-color: #6200ee; color: white; border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer; transition: background-color 0.2s; font-size: 14px; }
        button:hover { background-color: #3700b3; }
        button:disabled { background-color: #333; color: #888; cursor: not-allowed; }
        button.stop { background-color: #cf6679; }
        button.stop:hover { background-color: #b00020; }
        .controls, .manual-controls { display: flex; justify-content: center; align-items: center; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap; }
        input, select { padding: 8px; background-color: #333; color: #e0e0e0; border: 1px solid #555; border-radius: 4px; }
        table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        th, td { padding: 0.75rem; text-align: left; border-bottom: 1px solid #333; }
        th { background-color: #2c2c2c; }
        .text-green { color: #4caf50; }
        .text-red { color: #f44336; }
        .text-yellow { color: #f1c40f; }
        .text-blue { color: #64b5f6; }
        .status-display { margin-top: 1rem; padding: 1rem; background-color: #2c2c2c; border-radius: 4px; min-height: 20px; text-align: center; word-break: break-word; }
    </style>
</head>
<body>
<div class="container">
    <h1>üìà Bot Arbitrage Trading</h1>

    <div class="controls">
        <label for="percentageToUse">V·ªën m·ªói l·ªánh (%):</label>
        <input type="number" id="percentageToUse" value="50" min="1" max="100">
        <button id="startBotBtn">‚ñ∂Ô∏è Start Bot</button>
        <button id="stopBotBtn" class="stop">‚è∏Ô∏è Stop Bot</button>
        <button id="closeTradeBtn" class="stop">üõë ƒê√≥ng l·ªánh & D·ªçn d·∫πp</button>
    </div>

    <div class="grid">
        <div class="card">
            <h3>Tr·∫°ng th√°i Bot</h3>
            <p><strong>Tr·∫°ng th√°i chung:</strong> <span id="botStateDisplay">ƒêang t·∫£i...</span></p>
            <p><strong>H√†nh ƒë·ªông hi·ªán t·∫°i:</strong> <span id="capitalStateDisplay">...</span></p>
        </div>
        <div class="card">
            <h3>S·ªë d∆∞ Futures</h3>
            <div id="balancesDisplay"><p>ƒêang t·∫£i...</p></div>
        </div>
        <div class="card">
            <h3>C∆° h·ªôi T·ªët nh·∫•t</h3>
            <div id="bestOpportunityDisplay"><p>ƒêang t√¨m...</p></div>
        </div>
        <div class="card">
            <h3>Giao d·ªãch Hi·ªán t·∫°i</h3>
            <div id="currentTradeDisplay"><p>Kh√¥ng c√≥.</p></div>
        </div>
    </div>
    
    <div class="grid">
         <div class="card">
            <h2>Test L·ªánh Nhanh</h2>
            <p style="color: #80cbc4;">D√πng c∆° h·ªôi t·ªët nh·∫•t hi·ªán t·∫°i ƒë·ªÉ v√†o l·ªánh th·ªß c√¥ng v·ªõi c√°c th√¥ng s·ªë t√πy ch·ªânh.</p>
            <div class="manual-controls" id="test-trade-form">
                <label>Short tr√™n:</label> <select id="testShortExchange"></select>
                <label>Long tr√™n:</label> <select id="testLongExchange"></select>
                <label>ƒê√≤n b·∫©y:</label> <input type="number" id="testLeverage" value="20" min="1">
                <label>% V·ªën:</label> <input type="number" id="testPercentage" value="10" min="1" max="100">
                <button id="testTradeBtn">G·ª≠i L·ªánh Test</button>
            </div>
            <div id="testStatusDisplay" class="status-display"></div>
        </div>
        <div class="card">
            <h2>Chuy·ªÉn ti·ªÅn Ngo·∫°i s√†n</h2>
            <p style="color: #f48fb1;"><strong>C·∫¢NH B√ÅO:</strong> R·ªßi ro cao. Sai ƒë·ªãa ch·ªâ/m·∫°ng c√≥ th·ªÉ M·∫§T TI·ªÄN. API Key ph·∫£i c√≥ quy·ªÅn R√∫t ti·ªÅn.</p>
            <div class="manual-controls">
                <label>T·ª´:</label> <select id="fromExchangeSelect"></select>
                <label>T·ªõi:</label> <select id="toExchangeSelect"></select>
                <label>S·ªë l∆∞·ª£ng USDT:</label> <input type="number" id="transferAmount" value="10" min="1">
                <button id="manualTransferBtn">Chuy·ªÉn ngay</button>
            </div>
            <div id="transferStatusDisplay" class="status-display"></div>
        </div>
        
        <div class="card">
            <h2>Chuy·ªÉn ti·ªÅn N·ªôi b·ªô</h2>
            <div class="manual-controls">
                <label>S√†n:</label> <select id="internalExchangeSelect"></select>
                <label>T·ª´ v√≠:</label>
                <select id="internalFromAccount">
                    <option value="spot">Spot/Main</option>
                    <option value="future">Future</option>
                </select>
                <label>T·ªõi v√≠:</label>
                 <select id="internalToAccount">
                    <option value="future">Future</option>
                    <option value="spot">Spot/Main</option>
                </select>
                <label>S·ªë l∆∞·ª£ng USDT:</label> <input type="number" id="internalAmount" value="10" min="0.1">
                <button id="internalTransferBtn">Chuy·ªÉn N·ªôi b·ªô</button>
            </div>
            <div id="internalTransferStatusDisplay" class="status-display"></div>
        </div>
    </div>

    <div class="card">
        <h2>L·ªãch s·ª≠ Giao d·ªãch</h2>
        <table>
            <thead>
                <tr>
                    <th>Th·ªùi gian</th>
                    <th>Coin</th>
                    <th>S√†n (Short/Long)</th>
                    <th>PNL ∆Ø·ªõc t√≠nh (%)</th>
                    <th>V·ªën s·ª≠ d·ª•ng (USDT)</th>
                    <th>PNL Th·ª±c t·∫ø (USDT)</th>
                </tr>
            </thead>
            <tbody id="tradeHistoryBody"></tbody>
        </table>
    </div>
</div>

<script>
    // Khai b√°o c√°c element
    const startBotBtn = document.getElementById('startBotBtn');
    const stopBotBtn = document.getElementById('stopBotBtn');
    const testTradeBtn = document.getElementById('testTradeBtn');
    const testShortExchange = document.getElementById('testShortExchange');
    const testLongExchange = document.getElementById('testLongExchange');
    const fromSelect = document.getElementById('fromExchangeSelect');
    const toSelect = document.getElementById('toExchangeSelect');
    const internalExchangeSelect = document.getElementById('internalExchangeSelect');
    const manualTransferBtn = document.getElementById('manualTransferBtn');
    const internalTransferBtn = document.getElementById('internalTransferBtn');
    
    let activeExchangesInitialized = false;

    async function updateBotStatus() {
        try {
            const response = await fetch('/bot-api/status');
            const data = await response.json();

            // C·∫≠p nh·∫≠t Tr·∫°ng th√°i Bot
            const botStateEl = document.getElementById('botStateDisplay');
            botStateEl.textContent = data.botState;
            botStateEl.className = data.botState === 'RUNNING' ? 'text-green' : 'text-red';
            startBotBtn.disabled = data.botState === 'RUNNING';
            stopBotBtn.disabled = data.botState !== 'RUNNING';
            
            const capitalStateEl = document.getElementById('capitalStateDisplay');
            capitalStateEl.textContent = data.capitalManagementState || 'N/A';
            switch(data.capitalManagementState) {
                case 'PREPARING_FUNDS': case 'CLEANING_UP':
                    capitalStateEl.className = 'text-yellow'; break;
                case 'TRADE_OPEN':
                    capitalStateEl.className = 'text-green'; break;
                case 'FUNDS_READY':
                    capitalStateEl.className = 'text-blue'; break;
                default:
                    capitalStateEl.className = '';
            }

            const isBotBusy = data.botState === 'RUNNING' && data.capitalManagementState !== 'IDLE';
            manualTransferBtn.disabled = isBotBusy;
            internalTransferBtn.disabled = isBotBusy;
            testTradeBtn.disabled = isBotBusy;

            // C·∫≠p nh·∫≠t S·ªë d∆∞
            let balancesHtml = '';
            for (const id in data.balances) {
                const health = data.exchangeHealth[id];
                const healthStatus = health.isDisabled ? ` (<span class="text-red">M·∫•t k·∫øt n·ªëi</span>)` : '';
                balancesHtml += `<p><strong>${id.toUpperCase()}:</strong> ${data.balances[id].available.toFixed(2)} USDT ${healthStatus}</p>`;
            }
            document.getElementById('balancesDisplay').innerHTML = balancesHtml;

            // C·∫≠p nh·∫≠t C∆° h·ªôi
            const oppEl = document.getElementById('bestOpportunityDisplay');
            if (data.bestPotentialOpportunityForDisplay) {
                const opp = data.bestPotentialOpportunityForDisplay;
                oppEl.innerHTML = `<p><strong>Coin:</strong> ${opp.coin}</p><p><strong>S√†n:</strong> ${opp.exchanges}</p><p><strong>PNL ∆∞·ªõc t√≠nh:</strong> ${opp.estimatedPnl.toFixed(3)}%</p>`;
            } else {
                oppEl.innerHTML = '<p>Kh√¥ng c√≥ c∆° h·ªôi n√†o kh·∫£ d·ª•ng.</p>';
            }

            // C·∫≠p nh·∫≠t Giao d·ªãch Hi·ªán t·∫°i
            const tradeEl = document.getElementById('currentTradeDisplay');
            if (data.currentTradeDetails) {
                const trade = data.currentTradeDetails;
                tradeEl.innerHTML = `<p><strong>Coin:</strong> ${trade.coin}</p><p><strong>Tr·∫°ng th√°i:</strong> ${trade.status}</p><p><strong>Short:</strong> ${trade.shortExchange.toUpperCase()}</p><p><strong>Long:</strong> ${trade.longExchange.toUpperCase()}</p>`;
            } else {
                tradeEl.innerHTML = '<p>Kh√¥ng c√≥ giao d·ªãch n√†o ƒëang m·ªü.</p>';
            }

            // C·∫≠p nh·∫≠t L·ªãch s·ª≠
            const historyBody = document.getElementById('tradeHistoryBody');
            historyBody.innerHTML = '';
            data.tradeHistory.forEach(trade => {
                const row = historyBody.insertRow();
                row.insertCell().textContent = new Date(trade.closeTime || trade.openTime).toLocaleString('vi-VN');
                row.insertCell().textContent = trade.coin;
                row.insertCell().textContent = `${trade.shortExchange.toUpperCase()}/${trade.longExchange.toUpperCase()}`;
                row.insertCell().textContent = trade.estimatedPnlFromOpportunity ? trade.estimatedPnlFromOpportunity.toFixed(2) + '%' : 'N/A';
                row.insertCell().textContent = trade.collateralUsed ? trade.collateralUsed.toFixed(4) : 'N/A';
                const pnlCell = row.insertCell();
                pnlCell.textContent = trade.actualPnl ? trade.actualPnl.toFixed(4) + ' USDT' : 'N/A';
                pnlCell.className = trade.actualPnl >= 0 ? 'text-green' : 'text-red';
            });
            
            // Kh·ªüi t·∫°o c√°c dropdown n·∫øu ch∆∞a c√≥
            if (!activeExchangesInitialized && data.activeExchangeIds) {
                populateDropdowns(data.activeExchangeIds, [testShortExchange, testLongExchange, internalExchangeSelect]);
                populateDropdowns(data.transferExchanges || [], [fromSelect, toSelect]);
                activeExchangesInitialized = true;
            }
        } catch (error) {
            console.error('L·ªói c·∫≠p nh·∫≠t tr·∫°ng th√°i:', error);
            document.getElementById('botStateDisplay').textContent = 'L·ªñI K·∫æT N·ªêI';
        }
    }
    
    function populateDropdowns(exchanges, dropdowns) {
        if (!exchanges || exchanges.length === 0) return;
        dropdowns.forEach(dropdown => {
            if (!dropdown) return;
            dropdown.innerHTML = ''; // X√≥a c√°c l·ª±a ch·ªçn c≈©
            exchanges.forEach(id => {
                dropdown.add(new Option(id.toUpperCase(), id));
            });
        });
    }

    async function postRequest(url, body) {
        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body),
            });
            return await response.json();
        } catch (error) {
            console.error(`L·ªói request t·ªõi ${url}:`, error);
            return { success: false, message: `L·ªói k·∫øt n·ªëi: ${error.message}` };
        }
    }
    
    startBotBtn.addEventListener('click', async () => {
        const result = await postRequest('/bot-api/start', { percentageToUse: document.getElementById('percentageToUse').value });
        alert(result.message);
        updateBotStatus();
    });

    stopBotBtn.addEventListener('click', async () => {
        const result = await postRequest('/bot-api/stop', {});
        alert(result.message);
        updateBotStatus();
    });

    document.getElementById('closeTradeBtn').addEventListener('click', async () => {
        if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën ƒë√≥ng l·ªánh v√† b·∫Øt ƒë·∫ßu qu√° tr√¨nh d·ªçn d·∫πp kh√¥ng?')) {
            const result = await postRequest('/bot-api/close-trade-now', {});
            alert(result.message);
            updateBotStatus();
        }
    });
    
    testTradeBtn.addEventListener('click', async (e) => {
        const statusEl = document.getElementById('testStatusDisplay');
        statusEl.textContent = 'ƒêang g·ª≠i l·ªánh...';
        statusEl.className = 'text-yellow';
        
        const payload = {
            shortExchange: testShortExchange.value,
            longExchange: testLongExchange.value,
            leverage: document.getElementById('testLeverage').value,
            percentage: document.getElementById('testPercentage').value,
        };
        
        const result = await postRequest('/bot-api/custom-test-trade', payload);
        
        statusEl.textContent = result.message;
        statusEl.className = result.success ? 'text-green' : 'text-red';
        
        setTimeout(() => { statusEl.textContent = ''; }, 5000);
        updateBotStatus();
    });

    manualTransferBtn.addEventListener('click', async (e) => {
        const statusEl = document.getElementById('transferStatusDisplay');
        statusEl.textContent = 'ƒêang g·ª≠i y√™u c·∫ßu...';
        statusEl.className = 'text-yellow';
        const result = await postRequest('/bot-api/transfer-funds', {
            fromExchangeId: fromSelect.value,
            toExchangeId: toSelect.value,
            amountStr: document.getElementById('transferAmount').value
        });
        statusEl.textContent = result.message;
        statusEl.className = result.success ? 'text-green' : 'text-red';
    });

    internalTransferBtn.addEventListener('click', async (e) => {
        const statusEl = document.getElementById('internalTransferStatusDisplay');
        statusEl.textContent = 'ƒêang g·ª≠i y√™u c·∫ßu...';
        statusEl.className = 'text-yellow';
        const result = await postRequest('/bot-api/internal-transfer', {
            exchangeId: internalExchangeSelect.value,
            fromAccount: document.getElementById('internalFromAccount').value,
            toAccount: document.getElementById('internalToAccount').value,
            amountStr: document.getElementById('internalAmount').value
        });
        statusEl.textContent = result.message;
        statusEl.className = result.success ? 'text-green' : 'text-red';
    });


    updateBotStatus();
    setInterval(updateBotStatus, 3000);
</script>
</body>
</html>
