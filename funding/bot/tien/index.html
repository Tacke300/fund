<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bot Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment@1.0.1/dist/chartjs-adapter-moment.min.js"></script>
    <style>
        body { background-color: #121212; color: #e0e0e0; font-family: 'Segoe UI', sans-serif; }
        .card { background-color: #1e1e1e; border: 1px solid #333; margin-bottom: 20px; }
        .card-header { background-color: #252525; border-bottom: 1px solid #333; font-weight: 600; }
        .btn-control { width: 100px; }
        .log-box { height: 300px; overflow-y: scroll; background: #000; padding: 10px; font-family: monospace; font-size: 12px; border: 1px solid #333; color: #0f0; }
        .status-badge { font-size: 0.9em; padding: 5px 10px; border-radius: 4px; }
        .text-pnl-pos { color: #00e676; }
        .text-pnl-neg { color: #ff5252; }
        .chart-container { position: relative; height: 350px; width: 100%; }
        .table-dark { background-color: #1e1e1e; color: #e0e0e0; }
        .table-dark th { border-color: #333; }
        .table-dark td { border-color: #333; }
    </style>
</head>
<body>
    <div class="container-fluid p-4">
        <div class="row mb-3">
            <div class="col-md-6 d-flex align-items-center">
                <h3 class="m-0 me-3">Bot Manager</h3>
                <span id="botStatusBadge" class="badge bg-secondary">Loading...</span>
            </div>
            <div class="col-md-6 text-end">
                <button id="btnStart" class="btn btn-success btn-control" onclick="sendCommand('start')">START</button>
                <button id="btnStop" class="btn btn-danger btn-control d-none" onclick="sendCommand('stop')">STOP</button>
            </div>
        </div>

        <div class="row">
            <div class="col-md-3">
                <div class="card">
                    <div class="card-header">Balance Info</div>
                    <div class="card-body">
                        <h5 class="card-title">Total: <span id="valTotal">0.0</span> USDT</h5>
                        <p class="card-text mb-1">Binance: <span id="valBinance">0.0</span></p>
                        <p class="card-text mb-1">KuCoin: <span id="valKucoin">0.0</span></p>
                        <hr>
                        <p class="card-text">PnL: <span id="valPnl" class="">0.0</span></p>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">Config</div>
                    <div class="card-body">
                        <div class="mb-2">
                            <label>Max Opps</label>
                            <input type="number" id="cfgMaxOpps" class="form-control bg-dark text-white border-secondary" value="3">
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="cfgAutoBal">
                            <label class="form-check-label" for="cfgAutoBal">Auto Balance</label>
                        </div>
                        <button class="btn btn-primary btn-sm w-100 mt-2" onclick="applyConfig()">Apply</button>
                    </div>
                </div>
            </div>

            <div class="col-md-9">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>Performance Chart</span>
                        <div class="btn-group btn-group-sm">
                            <button type="button" class="btn btn-outline-secondary active" onclick="setChartPeriod('7d', this)">7D</button>
                            <button type="button" class="btn btn-outline-secondary" onclick="setChartPeriod('1m', this)">30D</button>
                            <button type="button" class="btn btn-outline-secondary" onclick="setChartPeriod('all', this)">ALL</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="balanceChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">Active Trades</div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-dark table-sm mb-0">
                                <thead>
                                    <tr>
                                        <th>Coin</th>
                                        <th>Side</th>
                                        <th>Entry</th>
                                        <th>Margin</th>
                                        <th>Time</th>
                                    </tr>
                                </thead>
                                <tbody id="activeTradesList"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">Logs</div>
                    <div class="card-body p-0">
                        <div id="logsContainer" class="log-box"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let chartInstance = null;
        let globalBalanceHistory = [];
        let currentPeriod = '7d';
        let lastLogTime = '';

        const ctx = document.getElementById('balanceChart').getContext('2d');
        
        const initChart = () => {
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: 'Total Balance (USDT)',
                        data: [],
                        borderColor: '#00e676',
                        backgroundColor: 'rgba(0, 230, 118, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.1,
                        pointRadius: 0,
                        pointHitRadius: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                title: (context) => {
                                    const d = new Date(context[0].parsed.x);
                                    return d.toLocaleString('vi-VN', { 
                                        day: '2-digit', month: '2-digit', year: 'numeric', 
                                        hour: '2-digit', minute: '2-digit'
                                    });
                                },
                                label: (context) => `Balance: ${context.parsed.y.toFixed(2)} $`
                            }
                        },
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                tooltipFormat: 'DD/MM/YYYY HH:mm',
                                displayFormats: {
                                    hour: 'HH:mm',
                                    day: 'DD/MM'
                                }
                            },
                            grid: { color: '#333' },
                            ticks: { color: '#aaa' }
                        },
                        y: {
                            grid: { color: '#333' },
                            ticks: { color: '#aaa' }
                        }
                    }
                }
            });
        };

        initChart();

        function filterChartData(data, period) {
            if (!data || data.length === 0) return [];
            
            const now = Date.now();
            const processed = [];
            const seenKeys = new Set();
            
            // Sort ascending time
            data.sort((a, b) => a.time - b.time);

            data.forEach(item => {
                const time = item.time;
                // UTC+7 Offset calculation: Local time logic
                // We create a Date object which browser handles in local time (assuming user is in VN)
                // Or we explicitly handle offset. Here we use Date object methods which use browser's timezone.
                // Assuming browser is set to user's timezone (VN).
                
                const d = new Date(time);
                let key = '';
                let include = false;

                if (period === '7d') {
                    // Filter: Last 7 days
                    if (time >= now - 7 * 24 * 60 * 60 * 1000) {
                        // Group by Hour: YYYY-MM-DD-HH
                        key = `${d.getFullYear()}-${d.getMonth()}-${d.getDate()}-${d.getHours()}`;
                        if (!seenKeys.has(key)) include = true;
                    }
                } else if (period === '1m') {
                     // Filter: Last 30 days
                    if (time >= now - 30 * 24 * 60 * 60 * 1000) {
                        // Group by Day (00:00): YYYY-MM-DD
                        key = `${d.getFullYear()}-${d.getMonth()}-${d.getDate()}`;
                        if (!seenKeys.has(key)) include = true; // First point found for that day
                    }
                } else if (period === 'all') {
                    // Group by Day
                    key = `${d.getFullYear()}-${d.getMonth()}-${d.getDate()}`;
                    if (!seenKeys.has(key)) include = true;
                }

                if (include) {
                    seenKeys.add(key);
                    processed.push({ x: time, y: item.total });
                }
            });

            return processed;
        }

        function updateChart() {
            if (!globalBalanceHistory.length) return;
            const filtered = filterChartData(globalBalanceHistory, currentPeriod);
            chartInstance.data.datasets[0].data = filtered;
            chartInstance.update('none'); 
        }

        function setChartPeriod(period, btn) {
            currentPeriod = period;
            document.querySelectorAll('.btn-group button').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            updateChart();
        }

        async function fetchStatus() {
            try {
                // Fetch status.json (mapped to this URL in your server setup)
                // Assuming your server serves static files from user_data or provides an API
                // Adjust URL below to your actual endpoint. Usually it's same domain.
                const username = window.location.pathname.split('/')[2] || 'default'; 
                // For this standalone HTML, we use a relative path or expect an API endpoint
                // Since user didn't provide API code, assuming standard /status endpoint or similar.
                // Reverting to fetch logic compatible with the provided nodejs code structure which writes to user_data
                // We will assume there is an endpoint /api/status that reads the JSON file.
                
                const res = await fetch('/api/status'); // You need to ensure your server has this route
                if (!res.ok) throw new Error('Network response was not ok');
                const data = await res.json();

                // Update Bot State (Immediate F5 fix)
                const badge = document.getElementById('botStatusBadge');
                const btnStart = document.getElementById('btnStart');
                const btnStop = document.getElementById('btnStop');

                if (data.botState === 'RUNNING') {
                    badge.className = 'badge bg-success';
                    badge.innerText = 'RUNNING';
                    btnStart.classList.add('d-none');
                    btnStop.classList.remove('d-none');
                } else {
                    badge.className = 'badge bg-danger';
                    badge.innerText = 'STOPPED';
                    btnStart.classList.remove('d-none');
                    btnStop.classList.add('d-none');
                }

                // Update Balance
                if (data.balances) {
                    const b = data.balances.binanceusdm?.total || 0;
                    const k = data.balances.kucoinfutures?.total || 0;
                    document.getElementById('valBinance').innerText = b.toFixed(2);
                    document.getElementById('valKucoin').innerText = k.toFixed(2);
                    document.getElementById('valTotal').innerText = (b + k).toFixed(2);
                }

                document.getElementById('valPnl').innerText = (data.totalPnl || 0).toFixed(2) + ' $';
                document.getElementById('valPnl').className = (data.totalPnl >= 0) ? 'text-pnl-pos' : 'text-pnl-neg';

                // Update Config Inputs if not focused
                if (document.activeElement !== document.getElementById('cfgMaxOpps')) {
                    document.getElementById('cfgMaxOpps').value = data.config?.maxOpps || 3;
                }
                if (document.activeElement !== document.getElementById('cfgAutoBal')) {
                    document.getElementById('cfgAutoBal').checked = data.config?.autoBalance || false;
                }

                // Update Trades
                const tbody = document.getElementById('activeTradesList');
                tbody.innerHTML = '';
                (data.activeTrades || []).forEach(t => {
                    const row = `<tr>
                        <td>${t.coin}</td>
                        <td><span class="badge bg-secondary">${t.shortExchange.substr(0,1).toUpperCase()}/${t.longExchange.substr(0,1).toUpperCase()}</span></td>
                        <td>${t.entryPriceShort}/${t.entryPriceLong}</td>
                        <td>${t.collateral}$</td>
                        <td>${new Date(t.entryTime).toLocaleTimeString()}</td>
                    </tr>`;
                    tbody.innerHTML += row;
                });

                // Update Logs
                const logDiv = document.getElementById('logsContainer');
                if (data.logs && data.logs.length > 0) {
                    const latest = data.logs[0];
                    if (latest !== lastLogTime) {
                        logDiv.innerHTML = data.logs.map(l => `<div>${l}</div>`).join('');
                        lastLogTime = latest;
                    }
                }

                // Update History (Only if backend sends it)
                if (data.balanceHistory && data.balanceHistory.length > 0) {
                    globalBalanceHistory = data.balanceHistory;
                    updateChart(); // Trigger calculation instantly
                }

            } catch (e) {
                console.error("Fetch error", e);
            }
        }

        async function sendCommand(cmd) {
            const payload = { op: cmd };
            if (cmd === 'start') {
                payload.maxOpps = document.getElementById('cfgMaxOpps').value;
                payload.autoBalance = document.getElementById('cfgAutoBal').checked;
            }
            await fetch('/api/command', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            setTimeout(fetchStatus, 500);
        }

        async function applyConfig() {
            // Only updates config without restarting if running
            const payload = { 
                op: 'update_config',
                maxOpps: document.getElementById('cfgMaxOpps').value,
                autoBalance: document.getElementById('cfgAutoBal').checked
            };
            await fetch('/api/command', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
        }

        window.onload = () => {
            fetchStatus(); // Run immediately on load
            setInterval(fetchStatus, 2000);
        };
    </script>
</body>
</html>
