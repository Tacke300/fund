<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bảng Funding Rate Hợp Nhất</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f4f7f9; 
            color: #333; 
            margin: 0; 
            padding: 20px; 
        }
        h1 { 
            text-align: center; 
            color: #2c3e50; 
        }
        #status { 
            text-align: center; 
            color: #555; 
            font-style: italic; 
            margin-bottom: 20px;
            height: 20px;
        }
        .table-wrapper {
            max-width: 1200px;
            margin: auto;
            overflow-x: auto; /* Cho phép cuộn ngang trên màn hình nhỏ */
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        table { 
            width: 100%; 
            border-collapse: collapse; 
            white-space: nowrap; /* Ngăn text xuống dòng */
        }
        th, td { 
            padding: 14px 16px; 
            text-align: right; 
            border-bottom: 1px solid #e0e0e0; 
        }
        th { 
            background-color: #ecf0f1; 
            font-weight: 600; 
            position: sticky; 
            top: 0;
            z-index: 10;
        }
        td:first-child, th:first-child {
            text-align: left;
            font-weight: bold;
            position: sticky;
            left: 0;
            background-color: #fff; /* Che đi phần table bị cuộn qua */
        }
        th:first-child {
             background-color: #ecf0f1;
        }
        tr:hover td {
            background-color: #f5f5f5;
        }
        tr:hover td:first-child {
            background-color: #f0f0f0; /* Màu đậm hơn cho cột đầu tiên khi hover */
        }

        .rate { 
            font-weight: 500;
            color: #e74c3c; /* Màu đỏ cho funding âm */
        }
        .empty-cell {
            color: #bbb;
        }
    </style>
</head>
<body>

    <h1>Bảng Funding Rate Hợp Nhất</h1>
    <p id="status">Đang tải dữ liệu...</p>

    <div class="table-wrapper">
        <table id="funding-table">
            <thead>
                <tr>
                    <th>Symbol</th>
                    <th>Binance</th>
                    <th>Bybit</th>
                    <th>OKX</th>
                    <th>Bitget</th>
                </tr>
            </thead>
            <tbody id="funding-table-body">
                <!-- Dữ liệu sẽ được chèn vào đây bằng JavaScript -->
            </tbody>
        </table>
    </div>

    <script>
        /**
         * Hàm chính để tải, xử lý và hiển thị dữ liệu
         */
        async function displayData() {
            const tbody = document.getElementById('funding-table-body');
            const statusEl = document.getElementById('status');
            
            try {
                // 1. LẤY DỮ LIỆU TỪ SERVER
                const response = await fetch('/api/rates');
                if (!response.ok) {
                    throw new Error(`Lỗi mạng: ${response.statusText}`);
                }
                const rawData = await response.json();

                // Cập nhật thời gian
                statusEl.textContent = `Dữ liệu được cập nhật lần cuối lúc: ${new Date(rawData.lastUpdated).toLocaleString('vi-VN')}`;

                // 2. BIẾN ĐỔI DỮ LIỆU (BƯỚC QUAN TRỌNG NHẤT)
                // Mục tiêu: Chuyển từ {sàn -> [coin]} thành {coin -> {sàn: rate}}
                const consolidatedData = {};
                const exchanges = ['binance', 'bybit', 'okx', 'bitget'];

                for (const exchange of exchanges) {
                    const coinList = rawData.rates[exchange] || [];
                    for (const coin of coinList) {
                        const symbol = coin.symbol;

                        // Nếu chưa có coin này trong bảng tổng hợp, hãy tạo mới
                        if (!consolidatedData[symbol]) {
                            consolidatedData[symbol] = {
                                symbol: symbol,
                                // minRate dùng để sắp xếp, luôn lấy giá trị âm nhất
                                minRate: coin.fundingRate 
                            };
                        }
                        
                        // Gán funding rate của sàn hiện tại cho coin
                        consolidatedData[symbol][exchange] = coin.fundingRate;

                        // Cập nhật minRate nếu funding của sàn này còn âm hơn
                        consolidatedData[symbol].minRate = Math.min(consolidatedData[symbol].minRate, coin.fundingRate);
                    }
                }

                // 3. SẮP XẾP
                // Chuyển object thành mảng và sắp xếp theo minRate (âm nhất lên đầu)
                const sortedCoins = Object.values(consolidatedData)
                    .sort((a, b) => a.minRate - b.minRate);

                // 4. HIỂN THỊ LÊN BẢNG
                let tableHtml = '';
                for (const coinData of sortedCoins) {
                    tableHtml += `<tr>`;
                    tableHtml += `<td>${coinData.symbol}</td>`;

                    // Lặp qua các sàn theo đúng thứ tự cột để điền dữ liệu
                    for (const exchange of exchanges) {
                        const rate = coinData[exchange];
                        if (rate !== undefined) {
                            const ratePercent = (rate * 100).toFixed(4);
                            tableHtml += `<td class="rate">${ratePercent}%</td>`;
                        } else {
                            // Nếu sàn không có coin này, điền dấu gạch ngang
                            tableHtml += `<td class="empty-cell">-</td>`;
                        }
                    }
                    tableHtml += `</tr>`;
                }
                tbody.innerHTML = tableHtml;

            } catch (error) {
                statusEl.textContent = `Lỗi: ${error.message}`;
                tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;color:red;">Không thể tải dữ liệu. Vui lòng kiểm tra log của server.</td></tr>`;
            }
        }

        // Chạy hàm khi trang tải xong và tự động làm mới sau mỗi 60 giây
        document.addEventListener('DOMContentLoaded', () => {
            displayData();
            setInterval(displayData, 60000); // 60 giây làm mới một lần
        });
    </script>

</body>
</html>
