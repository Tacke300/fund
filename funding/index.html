<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bảng Funding Rate Âm</title>
    <style>
        body { font-family: system-ui, -apple-system, sans-serif; background-color: #f4f7f9; color: #333; margin: 0; padding: 20px; }
        h1 { text-align: center; color: #2c3e50; }
        #status { text-align: center; color: #555; font-style: italic; margin-bottom: 25px; }
        .container { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 20px; max-width: 1500px; margin: auto; }
        .exchange-card { background-color: #fff; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.08); overflow: hidden; }
        .exchange-card h2 { margin: 0; padding: 15px 20px; background-color: #3498db; color: white; font-size: 1.2em; }
        .table-container { max-height: 450px; overflow-y: auto; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px 20px; text-align: left; border-bottom: 1px solid #e0e0e0; }
        th { background-color: #ecf0f1; font-weight: 600; position: sticky; top: 0; }
        tr:last-child td { border-bottom: none; }
        td.rate { font-weight: bold; color: #e74c3c; }
        .no-data { padding: 20px; color: #7f8c8d; text-align: center; }
    </style>
</head>
<body>
    <h1>Funding Rate Âm Từ Các Sàn Giao Dịch</h1>
    <p id="status">Đang tải dữ liệu...</p>

    <div class="container" id="data-container"></div>

    <script>
        function createExchangeTable(container, exchangeName, rates) {
            const card = document.createElement('div');
            card.className = 'exchange-card';
            let content = `<h2>${exchangeName} (${rates.length})</h2>`;
            if (rates.length === 0) {
                content += '<p class="no-data">Không có dữ liệu funding âm.</p>';
            } else {
                content += '<div class="table-container"><table><thead><tr><th>Symbol</th><th>Funding Rate</th></tr></thead><tbody>';
                rates.forEach(rate => {
                    const fundingRatePercent = (rate.fundingRate * 100).toFixed(4);
                    content += `<tr><td>${rate.symbol}</td><td class="rate">${fundingRatePercent}%</td></tr>`;
                });
                content += '</tbody></table></div>';
            }
            card.innerHTML = content;
            container.appendChild(card);
        }

        async function displayData() {
            const container = document.getElementById('data-container');
            const statusEl = document.getElementById('status');
            container.innerHTML = ''; // Xóa dữ liệu cũ
            try {
                // Lấy dữ liệu từ endpoint API của chính server này
                const response = await fetch('/api/rates');
                if (!response.ok) throw new Error(`Lỗi mạng: ${response.statusText}`);
                const data = await response.json();

                // Cập nhật thời gian
                statusEl.textContent = `Dữ liệu được cập nhật lần cuối lúc: ${new Date(data.lastUpdated).toLocaleString('vi-VN')}`;

                // Tạo bảng cho từng sàn
                createExchangeTable(container, 'Binance', data.rates.binance || []);
                createExchangeTable(container, 'Bybit', data.rates.bybit || []);
                createExchangeTable(container, 'OKX', data.rates.okx || []);
                createExchangeTable(container, 'Bitget', data.rates.bitget || []);

            } catch (error) {
                statusEl.textContent = `Lỗi: ${error.message}`;
                container.innerHTML = `<p style="color: red; text-align: center;">Không thể tải dữ liệu. Vui lòng kiểm tra console của server.</p>`;
            }
        }

        // Chạy lần đầu khi trang tải xong
        document.addEventListener('DOMContentLoaded', displayData);
    </script>
</body>
</html>
