// ... trong file bot .js của bạn
app.get('/api/bot_stats', async (req, res) => {
    let killPositionsData = [];
    if(currentBotMode === 'kill'){
        for(const p of [currentLongPosition, currentShortPosition]){
            if(p){
                const d = TARGET_COIN_SYMBOL ? await getSymbolDetails(p.symbol) : null;
                const pp = d ? d.pricePrecision : 2;
                const qp = d ? d.quantityPrecision : 3;
                const pnl = p.unrealizedPnl || 0;
                killPositionsData.push({
                    type: 'kill',
                    side: p.side,
                    entry: p.entryPrice?.toFixed(pp),
                    qty: p.quantity?.toFixed(qp),
                    pnl: pnl.toFixed(2),
                    curPrice: p.currentPrice?.toFixed(pp),
                    initQty: p.initialQuantity?.toFixed(qp),
                    closedLossQty: p.closedLossAmount?.toFixed(qp), // Đảm bảo trường này có tên đúng
                    pairEntry: p.pairEntryPrice?.toFixed(pp),
                    mocIdx: (p.nextPartialCloseLossIndex !== undefined ? p.nextPartialCloseLossIndex : -1), // Sửa để trả về index, client sẽ +1
                    pnlBasePercent: (p.pnlBaseForNextMoc || 0).toFixed(2),
                    tpId: p.currentTPId,
                    slId: p.currentSLId
                });
            }
        }
    }

    let gridPositionsData = [];
    if(sidewaysGrid.isActive && sidewaysGrid.activeGridPositions.length > 0){
        for(const p of sidewaysGrid.activeGridPositions){
            const d = TARGET_COIN_SYMBOL ? await getSymbolDetails(p.symbol) : null;
            const ppG = d ? d.pricePrecision : 4;
            const qpG = d ? d.quantityPrecision : 4;
            let pnlU = 0;
            if(currentMarketPrice && p.entryPrice && p.quantity) {
                pnlU = (currentMarketPrice - p.entryPrice) * p.quantity * (p.side === 'LONG' ? 1 : -1);
            }
            gridPositionsData.push({
                type: 'grid',
                id: p.id,
                side: p.side,
                entry: p.entryPrice?.toFixed(ppG),
                qty: p.quantity?.toFixed(qpG),
                curPrice: currentMarketPrice?.toFixed(ppG),
                pnl: pnlU.toFixed(2),
                originalAnchor: p.originalAnchorPrice?.toFixed(ppG),
                step: p.stepIndex,
                tpId: p.tpOrderId,
                slId: p.slOrderId
            });
        }
    }
    const cDet = TARGET_COIN_SYMBOL ? await getSymbolDetails(TARGET_COIN_SYMBOL) : null;
    const cPP = cDet ? cDet.pricePrecision : 4;
    const currentCoinV1 = getCurrentCoinVPS1Data(TARGET_COIN_SYMBOL);
    const vps1VolDisp = currentCoinV1 ? Math.abs(currentCoinV1.changePercent).toFixed(2) + '%' : 'N/A';

    // Tính toán thời gian chạy bot
    let uptimeString = "N/A";
    if (botRunning && botStartTime) {
        // uptimeString sẽ được tính ở client side từ botStartTime dạng ISO
    }


    res.json({
        success: true,
        data: {
            botRunning: botRunning, // Thêm trạng thái bot đang chạy
            botStartTime: botStartTime ? formatTimeUTC7(botStartTime) : "N/A", // Gửi thời gian bắt đầu dạng string
            currentMode: currentBotMode.toUpperCase(),
            vps1Volatility: vps1VolDisp,
            totalProfit: totalProfit.toFixed(2), // Đổi tên cho nhất quán
            totalLoss: totalLoss.toFixed(2),   // Đổi tên cho nhất quán
            netPNL: netPNL.toFixed(2),       // Đổi tên cho nhất quán
            currentCoin: TARGET_COIN_SYMBOL || "N/A",
            initialInvestment: INITIAL_INVESTMENT_AMOUNT, // Đổi tên cho nhất quán
            killPositions: killPositionsData, // Đổi tên cho nhất quán
            sidewaysGridInfo: {
                isActive: sidewaysGrid.isActive,
                isClearingForKillSwitch: sidewaysGrid.isClearingForKillSwitch,
                anchorPrice: sidewaysGrid.anchorPrice?.toFixed(cPP),
                upperLimit: sidewaysGrid.gridUpperLimit?.toFixed(cPP),
                lowerLimit: sidewaysGrid.gridLowerLimit?.toFixed(cPP),
                stats: {
                    tpMatchedCount: sidewaysGrid.sidewaysStats.tpMatchedCount, // Đổi tên cho nhất quán
                    slMatchedCount: sidewaysGrid.sidewaysStats.slMatchedCount  // Đổi tên cho nhất quán
                },
                activePositions: gridPositionsData
            },
            vps1DataUrl: VPS1_DATA_URL,
            currentMarketPrice: currentMarketPrice?.toFixed(cPP)
            // Bỏ targetOverallTakeProfit và targetOverallStopLoss nếu không dùng nữa
        }
    });
});
