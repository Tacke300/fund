<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Binance Futures Bot Control - {{THIS_BOT_PM2_NAME}}</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f4; color: #333; }
        .container { max-width: 900px; margin: auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba{0,0,0,0.1}; }
        .section { margin-bottom: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 5px; background-color: #f9f9f9; }
        h1, h2 { color: #0056b3; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input[type="text"], input[type="number"], input[type="password"] {
            width: calc(100% - 22px);
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        input[type="checkbox"] {
            margin-right: 8px;
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        #statusMessage {
            margin-top: 15px;
            padding: 10px;
            border-radius: 4px;
            font-weight: bold;
        }
        #statusMessage.success { background-color: #d4edda; color: #155724; border-color: #c3e6cb; }
        #statusMessage.error { background-color: #f8d7da; color: #721c24; border-color: #f5c6cb; }
        #logs, #botStats {
            background-color: #e9e9e9;
            padding: 10px;
            border-radius: 4px;
            height: 300px;
            overflow-y: scroll;
            white-space: pre-wrap; /* Đảm bảo ngắt dòng được giữ nguyên */
            word-wrap: break-word; /* Ngắt các từ dài */
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.85em;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .stat-box {
            background-color: #e0e0e0;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
        }
        .stat-box .label { font-size: 0.9em; color: #555; }
        .stat-box .value { font-size: 1.2em; font-weight: bold; color: #007bff; }
        .open-position-item {
            background-color: #e0e0e0;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
        }
        .open-position-item strong { color: #0056b3; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Binance Futures Bot Control - {{THIS_BOT_PM2_NAME}}</h1>

        <div class="section">
            <h2>Cấu hình API Keys & Tham số Bot</h2>
            <label for="apiKey">API Key:</label>
            <input type="password" id="apiKey" placeholder="Nhập API Key của bạn">

            <label for="secretKey">Secret Key:</label>
            <input type="password" id="secretKey" placeholder="Nhập Secret Key của bạn">

            <label for="targetSymbol">Đồng Coin (ví dụ: ETHUSDT):</label>
            <input type="text" id="targetSymbol" value="ETHUSDT">

            <label for="initialAmount">Số vốn ban đầu mỗi lệnh (USDT):</label>
            <input type="number" id="initialAmount" value="1" step="0.01" min="0.01">

            <input type="checkbox" id="applyDoubleStrategy">
            <label for="applyDoubleStrategy" style="display: inline;">Áp dụng chiến lược x2 vốn khi thua</label>
            <br><br>
            <button onclick="saveConfiguration()">Lưu Cấu hình</button>
            <div id="configMessage" class="status-message"></div>
        </div>

        <div class="section">
            <h2>Điều khiển Bot</h2>
            <button onclick="startBot()">Khởi động Bot</button>
            <button onclick="stopBot()">Dừng Bot</button>
            <div id="statusMessage">Đang tải trạng thái...</div>
        </div>

        <div class="section">
            <h2>Thống kê Bot</h2>
            <div class="stats-grid">
                <div class="stat-box">
                    <div class="label">Tổng Lời</div>
                    <div class="value" id="totalProfit">0.00</div>
                </div>
                <div class="stat-box">
                    <div class="label">Tổng Lỗ</div>
                    <div class="value" id="totalLoss">0.00</div>
                </div>
                <div class="stat-box">
                    <div class="label">PNL Ròng</div>
                    <div class="value" id="netPNL">0.00</div>
                </div>
            </div>
            <h3>Vị thế Đang Mở ({{TARGET_COIN_SYMBOL}})</h3>
            <div id="currentOpenPositions">Không có vị thế mở.</div>
        </div>

        <div class="section">
            <h2>Logs</h2>
            <button onclick="refreshLogs()">Refresh Logs</button>
            <pre id="logs"></pre>
        </div>
    </div>

    <script>
        const THIS_BOT_PM2_NAME = "{{THIS_BOT_PM2_NAME}}"; // Biến này sẽ được thay thế bởi Node.js server khi gửi HTML
        const TARGET_COIN_SYMBOL_JS = "{{TARGET_COIN_SYMBOL}}"; // Biến này cũng sẽ được thay thế

        document.title = `Binance Futures Bot Control - ${THIS_BOT_PM2_NAME}`; // Cập nhật tiêu đề trang
        // Cập nhật các element placeholder với giá trị từ biến môi trường
        document.querySelector('h1').textContent = `Binance Futures Bot Control - ${THIS_BOT_PM2_NAME}`;
        document.querySelector('h3').textContent = `Vị thế Đang Mở (${TARGET_COIN_SYMBOL_JS})`;


        // Hàm hiển thị thông báo
        function showMessage(elementId, message, isSuccess) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `status-message ${isSuccess ? 'success' : 'error'}`;
            setTimeout(() => {
                element.textContent = '';
                element.className = 'status-message';
            }, 5000);
        }

        // Hàm lưu cấu hình
        async function saveConfiguration() {
            const apiKey = document.getElementById('apiKey').value;
            const secretKey = document.getElementById('secretKey').value;
            const targetSymbol = document.getElementById('targetSymbol').value;
            const initialAmount = parseFloat(document.getElementById('initialAmount').value);
            const applyDoubleStrategy = document.getElementById('applyDoubleStrategy').checked;

            // Kiểm tra cơ bản
            if (!apiKey || !secretKey || !targetSymbol || isNaN(initialAmount) || initialAmount <= 0) {
                showMessage('configMessage', 'Vui lòng điền đầy đủ và chính xác các thông tin cấu hình.', false);
                return;
            }

            const payload = {
                apiKey: apiKey,
                secretKey: secretKey,
                coinConfigs: [
                    {
                        symbol: targetSymbol,
                        initialAmount: initialAmount,
                        applyDoubleStrategy: applyDoubleStrategy
                    }
                ]
            };

            try {
                const response = await fetch('/api/configure', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                if (result.success) {
                    showMessage('configMessage', result.message, true);
                } else {
                    showMessage('configMessage', 'Lỗi: ' + result.message, false);
                }
            } catch (error) {
                console.error('Lỗi khi gửi cấu hình:', error);
                showMessage('configMessage', 'Lỗi kết nối đến server: ' + error.message, false);
            }
        }

        async function startBot() {
            try {
                const response = await fetch('/start_bot_logic');
                const message = await response.text();
                showMessage('statusMessage', message, response.ok);
                updateStatus(); // Cập nhật trạng thái sau khi gửi lệnh
            } catch (error) {
                console.error('Lỗi khi khởi động bot:', error);
                showMessage('statusMessage', 'Lỗi kết nối đến server: ' + error.message, false);
            }
        }

        async function stopBot() {
            try {
                const response = await fetch('/stop_bot_logic');
                const message = await response.text();
                showMessage('statusMessage', message, response.ok);
                updateStatus(); // Cập nhật trạng thái sau khi gửi lệnh
            } catch (error) {
                console.error('Lỗi khi dừng bot:', error);
                showMessage('statusMessage', 'Lỗi kết nối đến server: ' + error.message, false);
            }
        }

        async function updateStatus() {
            try {
                const response = await fetch('/api/status');
                const text = await response.text();
                const statusDiv = document.getElementById('statusMessage');
                statusDiv.textContent = text;
                if (text.includes('DANG CHAY')) {
                    statusDiv.className = 'status-message success';
                } else if (text.includes('DA DUNG') || text.includes('ERRORED')) {
                    statusDiv.className = 'status-message error';
                } else {
                    statusDiv.className = 'status-message';
                }
            } catch (error) {
                console.error('Lỗi khi cập nhật trạng thái:', error);
                document.getElementById('statusMessage').textContent = 'Lỗi: Không thể lấy trạng thái bot.';
                document.getElementById('statusMessage').className = 'status-message error';
            }
        }

        async function refreshLogs() {
            try {
                const response = await fetch('/api/logs');
                const logs = await response.text();
                document.getElementById('logs').textContent = logs;
                document.getElementById('logs').scrollTop = document.getElementById('logs').scrollHeight; // Cuộn xuống dưới cùng
            } catch (error) {
                console.error('Lỗi khi tải logs:', error);
                document.getElementById('logs').textContent = 'Lỗi: Không thể tải logs.';
            }
        }

        async function updateBotStats() {
            try {
                const response = await fetch('/api/bot_stats');
                const data = await response.json();

                if (data.success) {
                    document.getElementById('totalProfit').textContent = data.data.totalProfit.toFixed(2);
                    document.getElementById('totalLoss').textContent = data.data.totalLoss.toFixed(2);
                    document.getElementById('netPNL').textContent = data.data.netPNL.toFixed(2);

                    const openPositionsDiv = document.getElementById('currentOpenPositions');
                    openPositionsDiv.innerHTML = ''; // Xóa nội dung trước đó

                    if (data.data.currentOpenPositions && data.data.currentOpenPositions.length > 0) {
                        data.data.currentOpenPositions.forEach(pos => {
                            const pnl = pos.unrealizedPnl.toFixed(2);
                            const pnlColor = pnl >= 0 ? 'green' : 'red';
                            const item = `
                                <div class="open-position-item">
                                    <strong>Symbol:</strong> ${pos.symbol}<br>
                                    <strong>Side:</strong> ${pos.side}<br>
                                    <strong>Quantity:</strong> ${pos.quantity.toFixed(pos.pricePrecision || 4)}<br>
                                    <strong>Entry Price:</strong> ${pos.entryPrice.toFixed(pos.pricePrecision || 4)}<br>
                                    <strong>Current Price:</strong> ${pos.currentPrice.toFixed(pos.pricePrecision || 4)}<br>
                                    <strong>Unrealized PNL:</strong> <span style="color: ${pnlColor};">${pnl} USDT</span>
                                </div>
                            `;
                            openPositionsDiv.insertAdjacentHTML('beforeend', item);
                        });
                    } else {
                        openPositionsDiv.textContent = 'Không có vị thế mở.';
                    }
                } else {
                    console.error('Lỗi khi lấy thống kê bot:', data.message);
                    document.getElementById('currentOpenPositions').textContent = 'Lỗi: Không thể tải thống kê vị thế.';
                }
            } catch (error) {
                console.error('Lỗi khi tải thống kê bot:', error);
                document.getElementById('currentOpenPositions').textContent = 'Lỗi: Không thể tải thống kê vị thế.';
            }
        }

        // Tải ban đầu và cập nhật định kỳ
        document.addEventListener('DOMContentLoaded', () => {
            updateStatus();
            refreshLogs();
            updateBotStats();
            setInterval(updateStatus, 5000); // Cập nhật trạng thái mỗi 5 giây
            setInterval(refreshLogs, 10000); // Cập nhật logs mỗi 10 giây
            setInterval(updateBotStats, 3000); // Cập nhật thống kê bot mỗi 3 giây
        });
    </script>
</body>
</html>
