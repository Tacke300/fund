<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LUFFY PIRATE BOT V.05 - FINAL BATTLE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Bangers&family=JetBrains+Mono&display=swap');
        body { 
            background: #050505; color: #eee; font-family: 'Inter', sans-serif;
            background-image: linear-gradient(rgba(0,0,0,0.93), rgba(0,0,0,0.93)), url('https://images.alphacoders.com/605/605592.png');
            background-size: cover; background-attachment: fixed; height: 100vh; overflow: hidden; display: flex; flex-direction: column;
        }
        .luffy-font { font-family: 'Bangers', cursive; letter-spacing: 1.5px; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        .card { background: rgba(20, 20, 25, 0.9); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px; padding: 10px; }
        input, select { background: #000 !important; border: 1px solid #444 !important; color: #fff; border-radius: 4px; padding: 3px 6px; font-size: 12px; outline: none; width: 100%; }
        input:focus { border-color: #ef4444 !important; }
        .log-entry { font-size: 10px; border-left: 3px solid #444; padding-left: 8px; margin-bottom: 3px; line-height: 1.4; }
        .btn-start { background: #22c55e; border-bottom: 4px solid #14532d; transition: 0.2s; font-weight: 900; }
        .btn-stop { background: #ef4444; border-bottom: 4px solid #7f1d1d; animation: pulse 2s infinite; font-weight: 900; }
        .btn-emergency { background: #ea580c; border-bottom: 4px solid #7c2d12; font-weight: 900; transition: 0.2s; }
        .btn-emergency:hover { background: #f97316; }
        
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(0.98); } }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
    </style>
</head>
<body class="p-2 md:p-4">

    <header class="flex justify-between items-center mb-3 bg-black/60 p-3 rounded-xl border border-white/10 shadow-2xl">
        <div class="flex items-center gap-4">
            <img src="https://cdn.pixabay.com/photo/2023/07/22/09/04/luffy-8142966_1280.png" class="w-16 h-16 rounded-full border-2 border-red-500 shadow-[0_0_20px_rgba(239,68,68,0.5)] object-cover">
            <div>
                <h1 class="luffy-font text-3xl text-white">LUFFY <span class="text-red-500">PIRATE</span> <span class="text-[10px] bg-red-600 px-1 rounded ml-1 italic">V.05</span></h1>
                <div class="flex items-center gap-2">
                    <span id="botStatusText" class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">OFFLINE</span>
                    <span id="queueStatus" class="text-[9px] bg-blue-900/50 text-blue-400 px-2 rounded hidden">ƒêANG X·ª¨ L√ù L·ªÜNH...</span>
                </div>
            </div>
        </div>
        <div class="text-right">
            <p class="text-[9px] text-gray-500 font-bold uppercase tracking-widest tracking-tighter">Futures Balance</p>
            <p id="balance" class="text-4xl font-black text-yellow-400 mono tracking-tighter">$0.00</p>
        </div>
    </header>

    <div class="grid grid-cols-1 md:grid-cols-8 gap-3 mb-3">
        <div class="card flex flex-col justify-center">
            <label class="text-[9px] text-gray-400 font-bold uppercase mb-1">V·ªën ($/L·ªánh)</label>
            <input type="number" id="invValue" value="1.5">
        </div>

        <div class="card flex flex-col justify-center">
            <label class="text-[9px] text-gray-400 font-bold uppercase mb-1">Max L·ªánh</label>
            <input type="number" id="maxPositions" value="10">
        </div>

        <div class="card flex flex-col justify-center col-span-1 md:col-span-2">
            <label class="text-[9px] text-gray-400 font-bold uppercase mb-1">D·ª´ng L·ªó TK (SL)</label>
            <div class="flex gap-1">
                <input type="number" id="accountSL" class="w-2/3" value="30">
                <select id="slUnit" class="w-1/3 text-[10px]">
                    <option value="percent">%</option>
                    <option value="dollar">$</option>
                </select>
            </div>
            <label class="flex items-center gap-1 mt-1 cursor-pointer">
                <input type="checkbox" id="useTrailingSL" class="w-3 h-3">
                <span class="text-[9px] text-blue-400 font-black uppercase">Trailing SL (V·ªën C·ªông D·ªìn)</span>
            </label>
        </div>

        <div class="card flex flex-col justify-center">
            <label class="text-[9px] text-gray-400 font-bold uppercase mb-1">Min Vol (%)</label>
            <input type="number" id="minVol" value="5.0">
        </div>

        <div class="card flex items-center justify-around">
            <div class="text-center border-r border-white/10 pr-2 w-full">
                <p class="text-[9px] text-gray-500 uppercase">Winrate</p>
                <p id="winRate" class="text-xl font-black text-green-400 luffy-font">0%</p>
            </div>
            <div class="text-center pl-2 w-full">
                <p class="text-[9px] text-gray-500 uppercase">T·ªïng PnL</p>
                <p id="totalPnL" class="text-xl font-black text-white mono">$0.00</p>
            </div>
        </div>

        <div class="flex flex-col gap-2">
            <button id="runBtn" onclick="handleToggle()" class="h-full btn-start rounded-lg text-[10px] uppercase text-white shadow-lg">üö¢ XU·∫§T QU√ÇN</button>
        </div>

        <div class="flex flex-col gap-2">
            <button onclick="handleEmergencyStop()" class="btn-emergency h-1/2 rounded-lg text-[9px] uppercase text-white shadow-lg">üíÄ D·ª™NG L·ªÜNH</button>
            <button onclick="handleUpdate()" class="bg-blue-600 h-1/2 hover:bg-blue-500 font-black rounded-lg text-[9px] uppercase text-white border-b-2 border-blue-900 transition-all">‚öôÔ∏è L∆ØU C·∫§U H√åNH</button>
        </div>
    </div>

    <div class="flex-grow grid grid-cols-1 md:grid-cols-12 gap-3 overflow-hidden">
        <div class="md:col-span-3 flex flex-col gap-3 overflow-hidden">
            <div class="card flex-grow flex flex-col overflow-hidden border-t-2 border-blue-500">
                <p class="text-[10px] font-black text-blue-400 uppercase mb-2">Nh·∫≠t k√Ω Pirate</p>
                <div id="botLogs" class="flex-grow overflow-y-auto pr-1 mono"></div>
            </div>
            <div class="card h-[140px] border-t-2 border-yellow-500 overflow-hidden">
                <p class="text-[10px] font-black text-yellow-500 uppercase mb-1">Radar C∆° H·ªôi</p>
                <div id="radarList" class="space-y-1 overflow-y-auto h-full pr-1"></div>
            </div>
        </div>

        <div class="md:col-span-9 flex flex-col gap-3 overflow-hidden">
            <div class="card flex-[2] overflow-hidden p-0 border-t-2 border-red-500">
                <div class="p-2 bg-black/40 flex justify-between items-center border-b border-white/5">
                    <span class="luffy-font text-lg text-red-500">CHI·∫æN TR∆Ø·ªúNG LIVE</span>
                    <span id="posCount" class="text-[10px] font-black bg-red-600 px-3 py-1 rounded-full italic shadow-lg">0 L·ªÜNH</span>
                </div>
                <div class="flex-grow overflow-y-auto">
                    <table class="w-full text-left text-[11px] mono">
                        <thead class="sticky top-0 bg-black/95 text-gray-500 uppercase border-b border-white/10">
                            <tr>
                                <th class="p-3">C·∫∑p Ti·ªÅn</th>
                                <th class="p-3">V·ªã th·∫ø/Lev</th>
                                <th class="p-3">Entry/Mark Price</th>
                                <th class="p-3 text-right">PnL % (USD)</th>
                            </tr>
                        </thead>
                        <tbody id="positionTable" class="divide-y divide-white/5"></tbody>
                    </table>
                </div>
            </div>

            <div class="card flex-[1.5] flex flex-col border-t-2 border-green-500">
                <p class="text-[10px] font-black text-green-500 uppercase mb-1 italic">Bi·ªÉu ƒë·ªì tƒÉng tr∆∞·ªüng PnL</p>
                <div class="flex-grow relative">
                    <canvas id="pnlChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        let isRunning = false;
        let pnlChart;
        let pnlData = [];
        let pnlLabels = [];
        let lastLogTime = "";

        window.onload = function() {
            const saved = localStorage.getItem('luffy_v5_cfg');
            if(saved) {
                const cfg = JSON.parse(saved);
                document.getElementById('invValue').value = cfg.invValue || 1.5;
                document.getElementById('maxPositions').value = cfg.maxPositions || 10;
                document.getElementById('accountSL').value = cfg.accountSL || 30;
                document.getElementById('slUnit').value = cfg.slUnit || 'percent';
                document.getElementById('minVol').value = cfg.minVol || 5.0;
                document.getElementById('useTrailingSL').checked = cfg.useTrailingSL || false;
            }
            initChart();
        };

        function initChart() {
            const ctx = document.getElementById('pnlChart').getContext('2d');
            pnlChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: pnlLabels,
                    datasets: [{
                        label: 'PnL ($)',
                        data: pnlData,
                        borderColor: '#22c55e',
                        borderWidth: 2,
                        pointRadius: 0,
                        tension: 0.4,
                        fill: true,
                        backgroundColor: 'rgba(34, 197, 94, 0.05)'
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { grid: { color: 'rgba(255,255,255,0.03)' }, ticks: { color: '#555', font: { size: 9 } } },
                        x: { display: false }
                    }
                }
            });
        }

        async function sync() {
            try {
                const res = await fetch('/api/status');
                const data = await res.json();
                
                isRunning = data.botSettings.isRunning;
                document.getElementById('balance').innerText = `$${data.status.currentBalance.toFixed(2)}`;
                
                // Hi·ªÉn th·ªã tr·∫°ng th√°i h√†ng ƒë·ª£i (Processing)
                const queueLabel = document.getElementById('queueStatus');
                if(data.status.isProcessing) {
                    queueLabel.classList.remove('hidden');
                } else {
                    queueLabel.classList.add('hidden');
                }

                // C·∫≠p nh·∫≠t V·ªã th·∫ø
                document.getElementById('posCount').innerText = `${data.activePositions.length} L·ªÜNH`;
                document.getElementById('positionTable').innerHTML = data.activePositions.map(p => `
                    <tr class="hover:bg-white/5 transition">
                        <td class="p-3 font-bold text-white">${p.symbol}</td>
                        <td class="p-3"><span class="${p.side === 'LONG' ? 'text-green-400' : 'text-red-400'} font-black">${p.side}</span> <span class="text-gray-500 text-[9px]">${p.leverage}x</span></td>
                        <td class="p-3 text-[10px] text-gray-400">${p.entryPrice}<br><span class="text-white">${p.markPrice}</span></td>
                        <td class="p-3 text-right font-black ${p.pnlValue >= 0 ? 'text-green-400' : 'text-red-400'}">${p.pnlPercent}%<br><span class="text-[9px] text-gray-500">$${p.pnlValue.toFixed(2)}</span></td>
                    </tr>
                `).join('');

                // PnL & Winrate
                let totalPnLNow = data.activePositions.reduce((a, b) => a + b.pnlValue, 0);
                document.getElementById('totalPnL').innerText = (totalPnLNow >= 0 ? '+' : '') + `$${totalPnLNow.toFixed(2)}`;
                document.getElementById('totalPnL').className = `text-xl font-black mono ${totalPnLNow >= 0 ? 'text-green-400' : 'text-red-400'}`;
                
                let winCount = data.history.filter(h => h.pnl > 0).length;
                document.getElementById('winRate').innerText = data.history.length > 0 ? Math.round((winCount/data.history.length)*100) + "%" : "0%";

                if (isRunning) {
                    pnlData.push(totalPnLNow.toFixed(2));
                    pnlLabels.push('');
                    if (pnlData.length > 50) { pnlData.shift(); pnlLabels.shift(); }
                    pnlChart.update();
                }

                // Nh·∫≠t k√Ω (Logs)
                if (data.status.botLogs.length > 0) {
                    const latest = data.status.botLogs[0];
                    if (latest.time !== lastLogTime) {
                        const div = document.createElement('div');
                        div.className = `log-entry border-${latest.type === 'error' ? 'red' : 'green'}-500`;
                        div.innerHTML = `<span class="opacity-40 text-[9px]">[${latest.time}]</span> ${latest.msg}`;
                        const box = document.getElementById('botLogs');
                        box.prepend(div);
                        if (box.children.length > 30) box.lastChild.remove();
                        lastLogTime = latest.time;
                    }
                }
                updateButtonUI();
            } catch (e) {}
        }

        function updateButtonUI() {
            const btn = document.getElementById('runBtn');
            const txt = document.getElementById('botStatusText');
            btn.innerText = isRunning ? "üõë D·ª™NG CHI·∫æN" : "üö¢ XU·∫§T QU√ÇN";
            btn.className = isRunning ? "btn-stop rounded-lg text-[10px] uppercase text-white shadow-lg" : "btn-start rounded-lg text-[10px] uppercase text-white shadow-lg";
            txt.innerText = isRunning ? "ƒêANG TRUY QU√âT..." : "OFFLINE";
            txt.className = isRunning ? "text-[10px] font-bold text-green-500 uppercase tracking-widest animate-pulse" : "text-[10px] font-bold text-gray-500 uppercase tracking-widest";
        }

        async function handleUpdate() {
            const cfg = {
                invValue: parseFloat(document.getElementById('invValue').value),
                maxPositions: parseInt(document.getElementById('maxPositions').value),
                accountSL: parseFloat(document.getElementById('accountSL').value),
                slUnit: document.getElementById('slUnit').value,
                minVol: parseFloat(document.getElementById('minVol').value),
                useTrailingSL: document.getElementById('useTrailingSL').checked
            };
            localStorage.setItem('luffy_v5_cfg', JSON.stringify(cfg));
            await fetch('/api/settings', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(cfg) });
            addLocalLog("C·∫•u h√¨nh h·∫°m ƒë·ªôi ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t!");
        }

        async function handleToggle() {
            await handleUpdate();
            await fetch('/api/settings', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ isRunning: !isRunning }) });
        }

        async function handleEmergencyStop() {
            if(confirm("THUY·ªÄN TR∆Ø·ªûNG: Ng√†i c√≥ mu·ªën ƒê√ìNG T·∫§T C·∫¢ l·ªánh v√† D·ª™NG BOT kh√¥ng?")) {
                await fetch('/api/stop-all', { method: 'POST' });
                addLocalLog("L·ªánh r√∫t qu√¢n kh·∫©n c·∫•p ƒë√£ ph√°t ƒëi!");
            }
        }

        function addLocalLog(msg) {
            const box = document.getElementById('botLogs');
            box.insertAdjacentHTML('afterbegin', `<div class="log-entry border-blue-500 text-blue-400 font-bold"><span class="opacity-40 text-[9px]">[${new Date().toLocaleTimeString()}]</span> ${msg}</div>`);
        }

        setInterval(sync, 2000);
    </script>
</body>
</html>
