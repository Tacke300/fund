<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LUFFY PIRATE BOT - B·∫¢N S·ª¨A 01</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Bangers&family=JetBrains+Mono:wght@400;700&display=swap');
        body {
            background: #050505; color: #eee; font-family: 'Inter', sans-serif;
            background-image: linear-gradient(rgba(0,0,0,0.9), rgba(0,0,0,0.9)), url('https://images.alphacoders.com/605/605592.png');
            background-size: cover; background-attachment: fixed; height: 100vh; overflow: hidden; display: flex; flex-direction: column;
        }
        .luffy-font { font-family: 'Bangers', cursive; letter-spacing: 1.5px; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        .card { background: rgba(20, 20, 25, 0.9); backdrop-filter: blur(15px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px; padding: 10px; }
        
        /* Grid 6 √¥ ngang Web / 6 d·ªçc Mobile */
        .grid-6 { display: grid; grid-template-columns: repeat(1, 1fr); gap: 10px; }
        @media (min-width: 1024px) { .grid-6 { grid-template-columns: repeat(6, 1fr); } }

        /* Log Colors & Animation */
        .log-entry { border-left: 3px solid #444; padding-left: 8px; margin-bottom: 4px; font-size: 11px; }
        .log-success { border-color: #22c55e; color: #4ade80; }
        .log-error { border-color: #ef4444; color: #f87171; }
        .log-info { border-color: #3b82f6; color: #60a5fa; }
        .log-warn { border-color: #eab308; color: #facc15; }

        #runBtn { transition: all 0.3s; font-weight: 900; cursor: pointer; border-radius: 10px; }
        .btn-start { background: #22c55e; border-bottom: 4px solid #14532d; }
        .btn-stop { background: #ef4444; border-bottom: 4px solid #7f1d1d; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        ::-webkit-scrollbar { width: 3px; }
        ::-webkit-scrollbar-thumb { background: #444; }
    </style>
</head>
<body class="p-2 md:p-4">

    <header class="flex justify-between items-center mb-4 bg-black/60 p-3 rounded-xl border border-white/10">
        <div class="flex items-center gap-3">
            <img src="https://i.ibb.co/vYm0Fm6/luffy-gear-5.png" class="w-12 h-12 rounded-lg border-2 border-yellow-500 object-cover">
            <div>
                <h1 class="luffy-font text-2xl text-white">LUFFY <span class="text-red-500">PIRATE</span> <span class="text-xs bg-red-600 px-1 rounded ml-1">V.01</span></h1>
                <p id="botStatusText" class="text-[10px] font-bold text-gray-500 uppercase italic">K·∫æT N·ªêI H·ªÜ TH·ªêNG...</p>
            </div>
        </div>
        <div class="text-right">
            <p class="text-[9px] text-gray-400 font-bold uppercase">S·ªë d∆∞ Futures</p>
            <p id="balance" class="text-2xl font-black text-yellow-400 mono tracking-tighter">$0.00</p>
        </div>
    </header>

    <div class="grid-6 mb-4">
        <div class="card flex flex-col justify-center">
            <label class="text-[9px] text-gray-500 font-bold uppercase mb-1">V·ªën & Lo·∫°i</label>
            <div class="flex gap-1">
                <input type="number" id="invValue" class="w-2/3 bg-black border border-white/10 p-1 rounded text-xs text-white mono" value="1.5">
                <select id="invType" class="w-1/3 bg-black border border-white/10 p-1 rounded text-[10px] text-yellow-500 font-bold">
                    <option value="fixed">$</option>
                    <option value="percent">%</option>
                </select>
            </div>
        </div>

        <div class="card flex flex-col justify-center">
            <label class="text-[9px] text-gray-500 font-bold uppercase mb-1">ƒêK Bi·∫øn ƒë·ªông (%)</label>
            <input type="number" id="minVol" class="w-full bg-black border border-white/10 p-1 rounded text-xs text-red-500 font-bold mono" value="5.0">
        </div>

        <div class="card flex flex-col justify-center">
            <label class="text-[9px] text-gray-500 font-bold uppercase mb-1">Max L·ªánh / SL TK (%)</label>
            <div class="flex gap-1">
                <input type="number" id="maxPositions" class="w-1/2 bg-black border border-white/10 p-1 rounded text-xs text-white mono" value="10">
                <input type="number" id="accountSL" class="w-1/2 bg-black border border-white/10 p-1 rounded text-xs text-orange-500 mono" value="30">
            </div>
        </div>

        <div class="card flex flex-col items-center justify-center">
            <p class="text-[9px] text-gray-400 uppercase">Winrate</p>
            <p id="winRate" class="luffy-font text-3xl text-green-400">0%</p>
        </div>

        <div class="card flex items-center justify-center">
            <button id="runBtn" onclick="handleToggle()" class="btn-start w-full py-3 text-white text-xs uppercase shadow-lg">üö¢ START</button>
        </div>

        <div class="card flex items-center justify-center">
            <button onclick="handleUpdate()" class="w-full py-3 bg-blue-600 hover:bg-blue-500 text-white text-[10px] font-black uppercase rounded-lg">C·∫¨P NH·∫¨T</button>
        </div>
    </div>

    <div class="flex-grow grid grid-cols-1 md:grid-cols-12 gap-4 min-h-0 overflow-hidden">
        
        <div class="md:col-span-4 flex flex-col gap-4 overflow-hidden">
            <div class="card flex-grow flex flex-col overflow-hidden border-t-2 border-blue-500">
                <h3 class="text-[10px] font-black text-blue-400 uppercase mb-2 italic">H·ªá th·ªëng Logs (Ch·∫∑n Spam)</h3>
                <div id="botLogs" class="flex-grow overflow-y-auto mono pr-1"></div>
            </div>
            <div class="card h-[150px] flex flex-col border-t-2 border-yellow-500">
                <h3 class="text-[10px] font-black text-yellow-500 uppercase mb-1 italic">Radar SƒÉn Coin (>= <span id="volShow">5</span>%)</h3>
                <div id="radarList" class="flex-grow overflow-y-auto space-y-1"></div>
            </div>
        </div>

        <div class="md:col-span-8 card flex flex-col overflow-hidden border-t-2 border-red-500 p-0">
            <div class="p-3 border-b border-white/5 flex justify-between bg-white/5 items-center">
                <span class="luffy-font text-lg text-white">H·∫†M ƒê·ªòI ƒêANG CHI·∫æN ƒê·∫§U</span>
                <span id="posCount" class="text-[10px] font-bold text-yellow-500 bg-yellow-500/10 px-2 py-1 rounded">0 L·ªÜNH</span>
            </div>
            <div class="flex-grow overflow-y-auto">
                <table class="w-full text-left text-[11px] mono">
                    <thead class="bg-black/80 sticky top-0 text-gray-500 uppercase">
                        <tr>
                            <th class="p-3">C·∫∑p ti·ªÅn</th>
                            <th class="p-3">V·ªã th·∫ø/Lev</th>
                            <th class="p-3">Entry/Mark</th>
                            <th class="p-3">PnL%</th>
                        </tr>
                    </thead>
                    <tbody id="positionTable" class="divide-y divide-white/5"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        /** * JAVASCRIPT B·∫¢N S·ª¨A BOT 01 
         */
        let isRunning = false;
        let lastErrorMsg = "";
        let errorRepeatCount = 0;
        const logs = document.getElementById('botLogs');

        function pushLog(msg, type = 'info') {
            // Ch·∫∑n spam log l·ªói gi·ªëng h·ªát nhau
            if (msg === lastErrorMsg && type === 'error') {
                errorRepeatCount++;
                logs.firstChild.innerHTML = `<span class="opacity-50">[${new Date().toLocaleTimeString()}]</span> ${msg} (x${errorRepeatCount})`;
                return;
            }
            lastErrorMsg = (type === 'error') ? msg : "";
            errorRepeatCount = 1;

            const time = new Date().toLocaleTimeString();
            const div = document.createElement('div');
            div.className = `log-entry log-${type}`;
            div.innerHTML = `<span class="opacity-50">[${time}]</span> ${msg}`;
            logs.prepend(div);
            if(logs.children.length > 40) logs.lastChild.remove();
        }

        function setUI(state) {
            isRunning = state;
            const btn = document.getElementById('runBtn');
            const statusText = document.getElementById('botStatusText');
            if(isRunning) {
                btn.innerText = "üõë STOP BOT";
                btn.className = "btn-stop w-full py-3 text-white text-xs uppercase";
                statusText.innerText = "BOT ƒêANG TRUY QU√âT T√çN HI·ªÜU...";
                statusText.className = "text-[10px] font-bold text-green-500 uppercase italic";
            } else {
                btn.innerText = "üö¢ START BOT";
                btn.className = "btn-start w-full py-3 text-white text-xs uppercase";
                statusText.innerText = "H·ªÜ TH·ªêNG ƒêANG T·∫†M D·ª™NG";
                statusText.className = "text-[10px] font-bold text-gray-500 uppercase italic";
            }
        }

        async function sync() {
            try {
                const res = await fetch('/api/status');
                const data = await res.json();

                // C·∫≠p nh·∫≠t Tr·∫°ng th√°i & N√∫t
                if(data.botSettings.isRunning !== isRunning) setUI(data.botSettings.isRunning);
                
                // C·∫≠p nh·∫≠t S·ªë d∆∞ & Winrate
                document.getElementById('balance').innerText = `$${(data.status.currentBalance || 0).toFixed(2)}`;
                document.getElementById('volShow').innerText = data.botSettings.minVol;
                
                let win = 0;
                data.history.forEach(h => { if(parseFloat(h.pnl) > 0) win++; });
                document.getElementById('winRate').innerText = data.history.length > 0 ? Math.round((win/data.history.length)*100) + "%" : "0%";

                // C·∫≠p nh·∫≠t B·∫£ng l·ªánh
                document.getElementById('posCount').innerText = `${data.activePositions.length} L·ªÜNH`;
                document.getElementById('positionTable').innerHTML = data.activePositions.map(p => `
                    <tr>
                        <td class="p-3 font-bold text-white">${p.symbol}</td>
                        <td class="p-3"><span class="${p.side === 'LONG' ? 'text-green-400' : 'text-red-400'}">${p.side}</span> <span class="text-gray-500 text-[9px]">${p.leverage}x</span></td>
                        <td class="p-3 text-[10px]">$${p.entryPrice}<br><span class="text-white">$${p.markPrice}</span></td>
                        <td class="p-3 text-right font-bold ${parseFloat(p.pnl) >= 0 ? 'text-green-400' : 'text-red-400'}">${p.pnlPercent}%</td>
                    </tr>
                `).join('');

                // C·∫≠p nh·∫≠t Radar Coin Ti·ªÅm NƒÉng
                if (data.candidatesList) {
                    document.getElementById('radarList').innerHTML = data.candidatesList.map(c => `
                        <div class="flex justify-between items-center bg-white/5 p-1 rounded text-[10px]">
                            <span class="font-bold text-gray-300">${c.symbol}</span>
                            <span class="${c.changePercent > 0 ? 'text-green-400' : 'text-red-400'} font-bold">${c.changePercent}%</span>
                        </div>
                    `).join('');
                }

                // ƒê∆∞a log t·ª´ server v·ªÅ web (n·∫øu c√≥)
                if (data.status.botLogs && data.status.botLogs.length > 0) {
                    const latest = data.status.botLogs[0];
                    if (latest.msg !== lastErrorMsg) pushLog(latest.msg, latest.type);
                }

            } catch (e) {
                pushLog("L·ªói k·∫øt n·ªëi Server Bot (C·ªïng 9001)!", "error");
            }
        }

        async function handleToggle() {
            const target = !isRunning;
            setUI(target);
            try {
                await fetch('/api/settings', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ isRunning: target })
                });
                pushLog(target ? "G·ª≠i l·ªánh: GI∆Ø∆†NG BU·ªíM!" : "G·ª≠i l·ªánh: H·∫† BU·ªíM!", "warn");
            } catch (e) { pushLog("Kh√¥ng th·ªÉ g·ª≠i l·ªánh ƒëi·ªÅu khi·ªÉn!", "error"); }
        }

        async function handleUpdate() {
            const body = {
                invValue: parseFloat(document.getElementById('invValue').value),
                invType: document.getElementById('invType').value,
                minVol: parseFloat(document.getElementById('minVol').value),
                maxPositions: parseInt(document.getElementById('maxPositions').value),
                accountSL: parseFloat(document.getElementById('accountSL').value)
            };
            try {
                const res = await fetch('/api/settings', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(body)
                });
                if(res.ok) {
                    pushLog("C·∫≠p nh·∫≠t th√¥ng s·ªë th√†nh c√¥ng!", "success");
                    alert("ƒê√£ √°p d·ª•ng c·∫•u h√¨nh m·ªõi!");
                }
            } catch (e) { pushLog("L·ªói c·∫≠p nh·∫≠t c·∫•u h√¨nh!", "error"); }
        }

        // Ch·∫°y l·∫ßn ƒë·∫ßu & L·∫∑p l·∫°i m·ªói 2 gi√¢y
        pushLog("B·∫¢N S·ª¨A BOT 01 - S·∫¥N S√ÄNG", "success");
        sync();
        setInterval(sync, 2000);
    </script>
</body>
</html>
