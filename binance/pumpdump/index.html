<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LUFFY PIRATE KING BOT - FULL LOGS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Bangers&family=JetBrains+Mono:wght@400;700&display=swap');
        body {
            background: #050505; color: #eee; font-family: 'Inter', sans-serif;
            background-image: linear-gradient(rgba(0,0,0,0.9), rgba(0,0,0,0.9)), url('https://images.alphacoders.com/605/605592.png');
            background-size: cover; background-attachment: fixed; height: 100vh; overflow: hidden; display: flex; flex-direction: column;
        }
        .luffy-font { font-family: 'Bangers', cursive; letter-spacing: 1.5px; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        .card { background: rgba(20, 20, 25, 0.9); backdrop-filter: blur(15px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px; padding: 12px; }
        
        /* Grid 6 √¥ ngang cho Web, 6 √¥ d·ªçc cho Mobile */
        .grid-main { display: grid; grid-template-columns: repeat(1, 1fr); gap: 10px; }
        @media (min-width: 1024px) { .grid-main { grid-template-columns: repeat(6, 1fr); } }

        /* Log Styling */
        #botLogs::-webkit-scrollbar { width: 3px; }
        .log-entry { border-left: 2px solid #444; padding-left: 8px; margin-bottom: 4px; font-size: 11px; animation: slideIn 0.2s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }
        
        .log-success { border-color: #22c55e; color: #4ade80; } /* Th√†nh c√¥ng */
        .log-error { border-color: #ef4444; color: #f87171; }   /* L·ªói */
        .log-info { border-color: #3b82f6; color: #60a5fa; }    /* Th√¥ng tin */
        .log-warn { border-color: #eab308; color: #facc15; }    /* C·∫£nh b√°o */

        #runBtn { transition: all 0.3s; font-weight: 900; cursor: pointer; }
        .btn-green { background: #22c55e; border-bottom: 4px solid #14532d; }
        .btn-red { background: #ef4444; border-bottom: 4px solid #7f1d1d; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.8; } }
    </style>
</head>
<body class="p-2 md:p-4">

    <header class="flex justify-between items-center mb-4 bg-black/60 p-3 rounded-xl border border-white/10">
        <div class="flex items-center gap-3">
            <img src="https://i.ibb.co/vYm0Fm6/luffy-gear-5.png" class="w-12 h-12 rounded-lg border-2 border-yellow-500 object-cover">
            <div>
                <h1 class="luffy-font text-2xl text-white">LUFFY <span class="text-red-500">PIRATE</span></h1>
                <p id="botStatusText" class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">ƒêang t·∫£i d·ªØ li·ªáu...</p>
            </div>
        </div>
        <div class="text-right">
            <p class="text-[10px] text-gray-400 font-bold uppercase">S·ªë d∆∞ v√≠</p>
            <p id="balance" class="text-2xl font-black text-yellow-400 mono">$0.00</p>
        </div>
    </header>

    <div class="grid-main mb-4">
        <div class="card flex flex-col justify-center">
            <label class="text-[9px] text-gray-500 font-bold uppercase mb-1">V·ªën m·ªói l·ªánh</label>
            <div class="flex gap-1">
                <input type="number" id="invValue" class="w-2/3 bg-black border border-white/10 p-1 rounded text-xs text-white" value="1.5">
                <select id="invType" class="w-1/3 bg-black border border-white/10 p-1 rounded text-[10px] text-yellow-500 font-bold">
                    <option value="fixed">$</option>
                    <option value="percent">%</option>
                </select>
            </div>
        </div>

        <div class="card flex flex-col justify-center">
            <label class="text-[9px] text-gray-500 font-bold uppercase mb-1">Max h·∫°m ƒë·ªôi</label>
            <input type="number" id="maxPositions" class="w-full bg-black border border-white/10 p-1 rounded text-xs text-white" value="10">
        </div>

        <div class="card flex flex-col justify-center">
            <label class="text-[9px] text-gray-500 font-bold uppercase mb-1">SL T√†i kho·∫£n (%)</label>
            <input type="number" id="accountSL" class="w-full bg-black border border-white/10 p-1 rounded text-xs text-white" value="30">
        </div>

        <div class="card flex flex-col items-center justify-center">
            <p class="text-[9px] text-gray-400 uppercase">T·ª∑ l·ªá th·∫Øng</p>
            <p id="winRate" class="luffy-font text-3xl text-green-400">0%</p>
        </div>

        <div class="card flex items-center justify-center">
            <button id="runBtn" onclick="handleToggle()" class="btn-green w-full py-3 text-white text-xs uppercase rounded-lg">
                üö¢ START
            </button>
        </div>

        <div class="card flex items-center justify-center">
            <button onclick="handleUpdate()" class="w-full py-3 bg-blue-600 hover:bg-blue-500 text-white text-[10px] font-black uppercase rounded-lg shadow-lg">
                C·∫¨P NH·∫¨T
            </button>
        </div>
    </div>

    <div class="flex-grow grid grid-cols-1 md:grid-cols-12 gap-4 min-h-0 overflow-hidden">
        
        <div class="md:col-span-4 card flex flex-col overflow-hidden border-t-2 border-blue-500">
            <div class="flex justify-between items-center mb-2">
                <h3 class="text-[10px] font-black text-blue-400 uppercase italic">H·ªá th·ªëng Logs</h3>
                <button onclick="document.getElementById('botLogs').innerHTML=''" class="text-[8px] text-gray-600 hover:text-white">X√ìA LOG</button>
            </div>
            <div id="botLogs" class="flex-grow overflow-y-auto mono space-y-1">
                </div>
        </div>

        <div class="md:col-span-8 card flex flex-col overflow-hidden border-t-2 border-red-500 p-0">
            <div class="p-3 border-b border-white/5 flex justify-between bg-white/5">
                <span class="luffy-font text-lg text-white">L·ªÜNH ƒêANG ƒê√ÅNH</span>
                <span id="posCount" class="text-[10px] font-bold text-yellow-500 uppercase">0 L·ªánh</span>
            </div>
            <div class="flex-grow overflow-y-auto">
                <table class="w-full text-left text-[11px] mono">
                    <thead class="bg-black/80 sticky top-0 text-gray-500 uppercase">
                        <tr>
                            <th class="p-3">C·∫∑p ti·ªÅn</th>
                            <th class="p-3">V·ªã th·∫ø/Lev</th>
                            <th class="p-3">Gi√° Entry/Hi·ªán t·∫°i</th>
                            <th class="p-3">TP/SL</th>
                            <th class="p-3 text-right">PnL%</th>
                        </tr>
                    </thead>
                    <tbody id="positionTable" class="divide-y divide-white/5"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        /** * JAVASCRIPT LOGIC - THUY·ªÄN TR∆Ø·ªûNG KI·ªÇM TRA T·∫†I ƒê√ÇY
         */
        let isRunning = false;
        const btn = document.getElementById('runBtn');
        const logs = document.getElementById('botLogs');

        // 1. H√†m Log: B√°o c√°o m·ªçi h√†nh ƒë·ªông th√†nh c√¥ng hay ch∆∞a
        function pushLog(msg, type = 'info') {
            const time = new Date().toLocaleTimeString();
            const div = document.createElement('div');
            div.className = `log-entry log-${type}`;
            div.innerHTML = `<span class="opacity-50">[${time}]</span> ${msg}`;
            logs.prepend(div);
            // Gi·ªØ l·∫°i 50 log g·∫ßn nh·∫•t
            if(logs.children.length > 50) logs.lastChild.remove();
        }

        // 2. C·∫≠p nh·∫≠t giao di·ªán n√∫t b·∫•m ngay l·∫≠p t·ª©c
        function setBtnState(state) {
            isRunning = state;
            if(isRunning) {
                btn.innerText = "üõë STOP BOT";
                btn.className = "btn-red w-full py-3 text-white text-xs uppercase rounded-lg";
                document.getElementById('botStatusText').innerText = "BOT ƒêANG TRUY QU√âT T√çN HI·ªÜU...";
                document.getElementById('botStatusText').className = "text-[10px] font-bold text-green-500 uppercase tracking-widest";
            } else {
                btn.innerText = "üö¢ START BOT";
                btn.className = "btn-green w-full py-3 text-white text-xs uppercase rounded-lg";
                document.getElementById('botStatusText').innerText = "H·ªá th·ªëng ƒëang t·∫°m d·ª´ng";
                document.getElementById('botStatusText').className = "text-[10px] font-bold text-gray-500 uppercase tracking-widest";
            }
        }

        // 3. ƒê·ªìng b·ªô d·ªØ li·ªáu t·ª´ Server
        async function syncData() {
            try {
                const res = await fetch('/api/status');
                if(!res.ok) throw new Error("Kh√¥ng th·ªÉ k·∫øt n·ªëi Server");
                const data = await res.json();

                // Ki·ªÉm tra tr·∫°ng th√°i ch·∫°y
                if(data.botSettings.isRunning !== isRunning) {
                    setBtnState(data.botSettings.isRunning);
                    pushLog(`ƒê·ªìng b·ªô tr·∫°ng th√°i: Bot ƒëang ${isRunning ? 'CH·∫†Y' : 'D·ª™NG'}`, "info");
                }

                // C·∫≠p nh·∫≠t s·ªë d∆∞
                const bal = data.status.currentBalance || 0;
                document.getElementById('balance').innerText = `$${bal.toFixed(2)}`;
                
                // C·∫≠p nh·∫≠t Winrate
                let win = 0;
                data.history.forEach(h => { if(parseFloat(h.pnl) > 0) win++; });
                const wr = data.history.length > 0 ? Math.round((win/data.history.length)*100) : 0;
                document.getElementById('winRate').innerText = wr + "%";

                // C·∫≠p nh·∫≠t B·∫£ng l·ªánh (Max Lev, Entry, TP, SL)
                document.getElementById('posCount').innerText = `${data.activePositions.length} L·ªánh`;
                document.getElementById('positionTable').innerHTML = data.activePositions.map(p => `
                    <tr class="hover:bg-white/5 transition">
                        <td class="p-3 font-bold text-white">${p.symbol}</td>
                        <td class="p-3">
                            <span class="${p.side === 'LONG' ? 'text-green-400' : 'text-red-400'} font-black">${p.side}</span>
                            <span class="text-gray-500 ml-1">MAXx</span>
                        </td>
                        <td class="p-3">
                            <span class="text-gray-400">$${p.entryPrice || '0'}</span><br>
                            <span class="text-white">$${p.markPrice || '0'}</span>
                        </td>
                        <td class="p-3 text-[9px]">
                            <span class="text-green-500">TP: ${p.tp || '--'}</span><br>
                            <span class="text-red-500">SL: ${p.sl || '--'}</span>
                        </td>
                        <td class="p-3 text-right font-black ${parseFloat(p.pnl) >= 0 ? 'text-green-400' : 'text-red-400'}">
                            ${p.pnlPercent}%
                        </td>
                    </tr>
                `).join('');

            } catch (err) {
                pushLog("L·ªói: Kh√¥ng l·∫•y ƒë∆∞·ª£c d·ªØ li·ªáu t·ª´ Server!", "error");
            }
        }

        // 4. X·ª≠ l√Ω b·∫•m START/STOP
        async function handleToggle() {
            const target = !isRunning;
            setBtnState(target); // ƒê·ªïi UI ngay cho m∆∞·ª£t
            
            try {
                pushLog(`ƒêang g·ª≠i y√™u c·∫ßu ${target ? 'START' : 'STOP'} t·ªõi server...`, "info");
                const res = await fetch('/api/settings', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ isRunning: target })
                });
                
                if(res.ok) {
                    pushLog(`${target ? 'START' : 'STOP'} th√†nh c√¥ng!`, "success");
                } else {
                    throw new Error();
                }
            } catch (e) {
                pushLog(`L·ªói: Kh√¥ng th·ªÉ th·ª±c hi·ªán l·ªánh ${target ? 'START' : 'STOP'}`, "error");
                setBtnState(!target); // Tr·∫£ l·∫°i tr·∫°ng th√°i c≈© n·∫øu l·ªói
            }
        }

        // 5. X·ª≠ l√Ω b·∫•m C·∫¨P NH·∫¨T (L∆∞u c√†i ƒë·∫∑t)
        async function handleUpdate() {
            const body = {
                invValue: parseFloat(document.getElementById('invValue').value),
                invType: document.getElementById('invType').value,
                maxPositions: parseInt(document.getElementById('maxPositions').value),
                accountSL: parseFloat(document.getElementById('accountSL').value)
            };

            pushLog("ƒêang g·ª≠i c·∫•u h√¨nh m·ªõi cho h·∫°m ƒë·ªôi...", "info");
            
            try {
                const res = await fetch('/api/settings', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(body)
                });
                
                if(res.ok) {
                    pushLog("C·∫≠p nh·∫≠t c·∫•u h√¨nh TH√ÄNH C√îNG!", "success");
                    alert("‚úÖ H·∫°m ƒë·ªôi ƒë√£ nh·∫≠n l·ªánh m·ªõi!");
                } else {
                    throw new Error();
                }
            } catch (e) {
                pushLog("L·ªói: C·∫≠p nh·∫≠t c·∫•u h√¨nh TH·∫§T B·∫†I!", "error");
                alert("‚ùå L·ªói server!");
            }
        }

        // Kh·ªüi ƒë·ªông
        pushLog("H·ªá th·ªëng Pirate Bot v3.5 ƒë√£ s·∫µn s√†ng.", "success");
        pushLog("ƒêang k·∫øt n·ªëi API Binance...", "info");
        syncData();
        setInterval(syncData, 2000); // C·∫≠p nh·∫≠t m·ªói 2 gi√¢y
    </script>
</body>
</html>
