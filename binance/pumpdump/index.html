<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LUFFY PIRATE BOT V.04</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Bangers&family=JetBrains+Mono&display=swap');
        body { 
            background: #050505; color: #eee; font-family: 'Inter', sans-serif;
            background-image: linear-gradient(rgba(0,0,0,0.92), rgba(0,0,0,0.92)), url('https://images.alphacoders.com/605/605592.png');
            background-size: cover; background-attachment: fixed; height: 100vh; overflow: hidden; display: flex; flex-direction: column;
        }
        .luffy-font { font-family: 'Bangers', cursive; letter-spacing: 1.5px; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        .card { background: rgba(20, 20, 25, 0.9); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px; padding: 10px; }
        input, select { background: #000 !important; border: 1px solid #444 !important; color: #fff; border-radius: 4px; padding: 3px 6px; font-size: 12px; outline: none; }
        input:focus { border-color: #ef4444 !important; }
        .log-entry { font-size: 10px; border-left: 3px solid #444; padding-left: 8px; margin-bottom: 3px; line-height: 1.4; }
        .btn-start { background: #22c55e; border-bottom: 4px solid #14532d; transition: 0.2s; font-weight: 900; }
        .btn-stop { background: #ef4444; border-bottom: 4px solid #7f1d1d; animation: pulse 2s infinite; font-weight: 900; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(0.98); } }
    </style>
</head>
<body class="p-2 md:p-4">

    <header class="flex justify-between items-center mb-3 bg-black/60 p-3 rounded-xl border border-white/10">
        <div class="flex items-center gap-3">
            <img src="https://i.ibb.co/vYm0Fm6/luffy-gear-5.png" onerror="this.src='https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/25.png'" class="w-14 h-14 rounded-full border-2 border-yellow-500 shadow-[0_0_15px_rgba(234,179,8,0.4)]">
            <div>
                <h1 class="luffy-font text-3xl text-white">LUFFY <span class="text-red-500">PIRATE</span> <span class="text-[10px] bg-red-600 px-1 rounded ml-1">V.04</span></h1>
                <p id="botStatusText" class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">OFFLINE</p>
            </div>
        </div>
        <div class="text-right">
            <p class="text-[9px] text-gray-500 font-bold uppercase tracking-widest">T√†i s·∫£n hi·ªán t·∫°i</p>
            <p id="balance" class="text-3xl font-black text-yellow-400 mono tracking-tighter">$0.00</p>
        </div>
    </header>

    <div class="grid grid-cols-1 md:grid-cols-6 gap-3 mb-3">
        <div class="card flex flex-col justify-center">
            <label class="text-[9px] text-gray-400 font-bold uppercase mb-1">V·ªën ($/L·ªánh)</label>
            <input type="number" id="invValue" value="1.5">
        </div>

        <div class="card flex flex-col justify-center">
            <label class="text-[9px] text-gray-400 font-bold uppercase mb-1">D·ª´ng L·ªó TK (SL)</label>
            <div class="flex gap-1">
                <input type="number" id="accountSL" class="w-2/3" value="30">
                <select id="slUnit" class="w-1/3">
                    <option value="percent">%</option>
                    <option value="dollar">$</option>
                </select>
            </div>
            <label class="flex items-center gap-1 mt-1 cursor-pointer">
                <input type="checkbox" id="useTrailingSL" class="w-3 h-3">
                <span class="text-[9px] text-blue-400 font-black uppercase">Trailing (B√°m ƒëu√¥i)</span>
            </label>
        </div>

        <div class="card flex flex-col justify-center">
            <label class="text-[9px] text-gray-400 font-bold uppercase mb-1">Min Bi·∫øn ƒê·ªông (%)</label>
            <input type="number" id="minVol" value="5.0">
        </div>

        <div class="card flex items-center justify-around">
            <div class="text-center">
                <p class="text-[9px] text-gray-500 uppercase">Winrate</p>
                <p id="winRate" class="text-xl font-black text-green-400 luffy-font">0%</p>
            </div>
            <div class="text-center border-l border-white/10 pl-3">
                <p class="text-[9px] text-gray-500 uppercase">T·ªïng PnL</p>
                <p id="totalPnL" class="text-xl font-black text-white mono">$0.00</p>
            </div>
        </div>

        <button id="runBtn" onclick="handleToggle()" class="btn-start rounded-lg text-xs uppercase text-white shadow-lg">üö¢ XU·∫§T QU√ÇN</button>
        <button onclick="handleUpdate()" class="bg-blue-600 hover:bg-blue-500 font-black rounded-lg text-xs uppercase text-white border-b-4 border-blue-900 transition">‚öôÔ∏è L∆ØU C·∫§U H√åNH</button>
    </div>

    <div class="flex-grow grid grid-cols-1 md:grid-cols-12 gap-3 overflow-hidden">
        <div class="md:col-span-3 flex flex-col gap-3 overflow-hidden">
            <div class="card flex-grow flex flex-col overflow-hidden border-t-2 border-blue-500">
                <p class="text-[10px] font-black text-blue-400 uppercase mb-2">Nh·∫≠t k√Ω</p>
                <div id="botLogs" class="flex-grow overflow-y-auto pr-1 mono"></div>
            </div>
            <div class="card h-[140px] border-t-2 border-yellow-500 overflow-hidden">
                <p class="text-[10px] font-black text-yellow-500 uppercase mb-1">Radar C∆° H·ªôi</p>
                <div id="radarList" class="space-y-1 overflow-y-auto h-full"></div>
            </div>
        </div>

        <div class="md:col-span-9 flex flex-col gap-3 overflow-hidden">
            <div class="card flex-[2] overflow-hidden p-0 border-t-2 border-red-500">
                <div class="p-2 bg-black/40 flex justify-between items-center border-b border-white/5">
                    <span class="luffy-font text-red-500">CHI·∫æN TR∆Ø·ªúNG LIVE</span>
                    <span id="posCount" class="text-[10px] font-black bg-red-600 px-2 rounded italic">0 L·ªÜNH</span>
                </div>
                <div class="flex-grow overflow-y-auto">
                    <table class="w-full text-left text-[11px] mono">
                        <thead class="sticky top-0 bg-black/90 text-gray-500 uppercase border-b border-white/10">
                            <tr>
                                <th class="p-3">Symbol</th>
                                <th class="p-3">L·ªánh/Lev</th>
                                <th class="p-3">Gi√° V√†o/Hi·ªán t·∫°i</th>
                                <th class="p-3 text-right">PnL % ($)</th>
                            </tr>
                        </thead>
                        <tbody id="positionTable" class="divide-y divide-white/5"></tbody>
                    </table>
                </div>
            </div>

            <div class="card flex-[1.5] flex flex-col border-t-2 border-green-500">
                <p class="text-[10px] font-black text-green-500 uppercase mb-1">Bi·ªÉu ƒë·ªì tƒÉng tr∆∞·ªüng PnL</p>
                <div class="flex-grow relative">
                    <canvas id="pnlChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        let isRunning = false;
        let pnlChart;
        let pnlData = [];
        let pnlLabels = [];
        let lastLogTime = "";

        // 1. LOCALSTORAGE: F5 KH√îNG M·∫§T C·∫§U H√åNH
        window.onload = function() {
            const saved = localStorage.getItem('luffy_v4_cfg');
            if(saved) {
                const cfg = JSON.parse(saved);
                document.getElementById('invValue').value = cfg.invValue || 1.5;
                document.getElementById('accountSL').value = cfg.accountSL || 30;
                document.getElementById('slUnit').value = cfg.slUnit || 'percent';
                document.getElementById('minVol').value = cfg.minVol || 5.0;
                document.getElementById('useTrailingSL').checked = cfg.useTrailingSL || false;
            }
            initChart();
        };

        function initChart() {
            const ctx = document.getElementById('pnlChart').getContext('2d');
            pnlChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: pnlLabels,
                    datasets: [{
                        label: 'PnL ($)',
                        data: pnlData,
                        borderColor: '#22c55e',
                        borderWidth: 2,
                        pointRadius: 0,
                        tension: 0.4,
                        fill: true,
                        backgroundColor: 'rgba(34, 197, 94, 0.05)'
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#666', font: { size: 9 } } },
                        x: { display: false }
                    }
                }
            });
        }

        async function sync() {
            try {
                const res = await fetch('/api/status');
                const data = await res.json();
                
                isRunning = data.botSettings.isRunning;
                document.getElementById('balance').innerText = `$${data.status.currentBalance.toFixed(2)}`;
                
                // C·∫≠p nh·∫≠t v·ªã th·∫ø
                document.getElementById('posCount').innerText = `${data.activePositions.length} L·ªÜNH`;
                document.getElementById('positionTable').innerHTML = data.activePositions.map(p => `
                    <tr class="hover:bg-white/5 transition">
                        <td class="p-3 font-bold text-white">${p.symbol}</td>
                        <td class="p-3"><span class="${p.side === 'LONG' ? 'text-green-400' : 'text-red-400'} font-black">${p.side}</span> <span class="text-gray-500 text-[9px]">${p.leverage}x</span></td>
                        <td class="p-3 text-[10px] text-gray-400">${p.entryPrice}<br><span class="text-white">${p.markPrice}</span></td>
                        <td class="p-3 text-right font-black ${p.pnlValue >= 0 ? 'text-green-400' : 'text-red-400'}">${p.pnlPercent}%<br><span class="text-[9px] text-gray-500">$${p.pnlValue.toFixed(2)}</span></td>
                    </tr>
                `).join('');

                // Radar
                document.getElementById('radarList').innerHTML = data.status.candidatesList.map(c => `
                    <div class="flex justify-between items-center bg-white/5 p-1 px-2 rounded border-l-2 ${c.changePercent > 0 ? 'border-green-500' : 'border-red-500'}">
                        <span class="text-[10px] font-bold">${c.symbol}</span>
                        <span class="text-[10px] font-bold ${c.changePercent > 0 ? 'text-green-400' : 'text-red-400'}">${c.changePercent.toFixed(2)}%</span>
                    </div>
                `).join('');

                // Bi·ªÉu ƒë·ªì & T·ªïng PnL
                let totalPnLNow = data.activePositions.reduce((a, b) => a + b.pnlValue, 0);
                document.getElementById('totalPnL').innerText = (totalPnLNow >= 0 ? '+' : '') + `$${totalPnLNow.toFixed(2)}`;
                document.getElementById('totalPnL').className = `text-xl font-black mono ${totalPnLNow >= 0 ? 'text-green-400' : 'text-red-400'}`;

                if (isRunning) {
                    pnlData.push(totalPnLNow.toFixed(2));
                    pnlLabels.push('');
                    if (pnlData.length > 60) { pnlData.shift(); pnlLabels.shift(); }
                    pnlChart.update();
                }

                // Logs (Ch·ªëng spam)
                if (data.status.botLogs.length > 0) {
                    const latest = data.status.botLogs[0];
                    if (latest.time !== lastLogTime) {
                        const div = document.createElement('div');
                        div.className = `log-entry border-${latest.type === 'error' ? 'red' : 'green'}-500`;
                        div.innerHTML = `<span class="opacity-40">[${latest.time}]</span> ${latest.msg}`;
                        const logBox = document.getElementById('botLogs');
                        logBox.prepend(div);
                        if (logBox.children.length > 25) logBox.lastChild.remove();
                        lastLogTime = latest.time;
                    }
                }
                updateButtonUI();
            } catch (e) {}
        }

        function updateButtonUI() {
            const btn = document.getElementById('runBtn');
            const txt = document.getElementById('botStatusText');
            btn.innerText = isRunning ? "üõë D·ª™NG CHI·∫æN" : "üö¢ XU·∫§T QU√ÇN";
            btn.className = isRunning ? "btn-stop rounded-lg text-xs uppercase text-white shadow-lg" : "btn-start rounded-lg text-xs uppercase text-white shadow-lg";
            txt.innerText = isRunning ? "ƒêANG TRUY QU√âT..." : "OFFLINE";
            txt.className = isRunning ? "text-[10px] font-bold text-green-500 uppercase tracking-widest animate-pulse" : "text-[10px] font-bold text-gray-500 uppercase tracking-widest";
        }

        async function handleUpdate() {
            const cfg = {
                invValue: parseFloat(document.getElementById('invValue').value),
                accountSL: parseFloat(document.getElementById('accountSL').value),
                slUnit: document.getElementById('slUnit').value,
                minVol: parseFloat(document.getElementById('minVol').value),
                useTrailingSL: document.getElementById('useTrailingSL').checked
            };
            localStorage.setItem('luffy_v4_cfg', JSON.stringify(cfg));
            await fetch('/api/settings', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(cfg) });
        }

        async function handleToggle() {
            await handleUpdate();
            await fetch('/api/settings', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ isRunning: !isRunning }) });
        }

        setInterval(sync, 2000);
    </script>
</body>
</html>
