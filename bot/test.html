<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Lấy Leverage Binance Futures</title>
</head>
<body>
  <h2>Lấy leverage tất cả cặp USDT (Binance Futures)</h2>
  <button onclick="getLeverage()">Lấy Leverage</button>
  <pre id="result">...</pre>

  <script>
    const apiKey = 'cZ1Y2O0kggVEggEaPvhFcYQHS5b1EsT2OWZb8zdY9C0jGqNROvXRZHTJjnQ7OG4Q';     // <-- THAY THẾ
    const apiSecret = 'oU6pZFHgEvbpD9NmFXp5ZVnYFMQ7EIkBiz88qTzvmC3SpT9nEf4fcDf0pEnFzoTc'; // <-- THAY THẾ
    const baseUrl = 'https://fapi.binance.com';

    async function getServerTime(baseUrl) {
      const res = await fetch(`${baseUrl}/fapi/v1/time`);
      const data = await res.json();
      return data.serverTime;
    }

    async function hmacSHA256(secret, message) {
      const enc = new TextEncoder();
      const key = await crypto.subtle.importKey(
        "raw", enc.encode(secret),
        { name: "HMAC", hash: "SHA-256" },
        false, ["sign"]
      );
      const sig = await crypto.subtle.sign("HMAC", key, enc.encode(message));
      return Array.from(new Uint8Array(sig)).map(b => b.toString(16).padStart(2, '0')).join('');
    }

    function buildQueryString(params) {
      return Object.entries(params)
        .sort()
        .map(([k, v]) => `${k}=${encodeURIComponent(v)}`)
        .join('&');
    }

    async function binanceSignedRequest(endpoint, baseUrl, params = {}) {
      const timestamp = await getServerTime(baseUrl) - 500;
      const queryObj = { ...params, timestamp };
      const query = buildQueryString(queryObj);
      const signature = await hmacSHA256(apiSecret, query);
      const url = `${baseUrl}${endpoint}?${query}&signature=${signature}`;

      const res = await fetch(url, {
        headers: { 'X-MBX-APIKEY': apiKey }
      });

      const text = await res.text();
      if (!res.ok) throw new Error(`Lỗi Binance: ${res.status} ${text}`);
      return JSON.parse(text);
    }

    async function getAllSymbolsUSDT() {
      const res = await fetch(`${baseUrl}/fapi/v1/exchangeInfo`);
      const data = await res.json();
      return data.symbols
        .filter(s => s.contractType === 'PERPETUAL' && s.quoteAsset === 'USDT')
        .map(s => s.symbol);
    }

    async function getLeverage() {
      const symbols = await getAllSymbolsUSDT();
      const result = [];

      for (const symbol of symbols) {
        try {
          const data = await binanceSignedRequest('/fapi/v1/leverageBracket', baseUrl, { symbol });
          const brackets = data[0].brackets || [];

          const maxLev = brackets.map(b => ({
            symbol,
            maxNotional: b.notionalCap,
            maxLeverage: b.initialLeverage
          }));

          result.push(...maxLev);
        } catch (e) {
          console.warn(`Lỗi lấy leverage ${symbol}: ${e.message}`);
        }

        // Binance rate limit: tránh bị chặn, delay 50ms mỗi request
        await new Promise(r => setTimeout(r, 50));
      }

      document.getElementById('result').innerText = JSON.stringify(result, null, 2);
    }
  </script>
</body>
</html>
