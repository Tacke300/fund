<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Binance Signed Request Test</title>
</head>
<body>
  <button onclick="testSigned()">Gửi yêu cầu signed</button>
  <pre id="result"></pre>

  <script>
    const apiKey = 'YOUR_API_KEY';
    const apiSecret = 'YOUR_API_SECRET';
    const baseUrl = 'https://api.binance.com';

    // Lấy thời gian server
    async function getServerTime(baseUrl) {
      const res = await fetch(`${baseUrl}/api/v3/time`);
      const data = await res.json();
      return data.serverTime;
    }

    // Tính HMAC SHA256 từ text + secret (WebCrypto API)
    async function hmacSHA256(secret, message) {
      const enc = new TextEncoder();
      const key = await crypto.subtle.importKey(
        "raw", enc.encode(secret), { name: "HMAC", hash: "SHA-256" }, false, ["sign"]
      );
      const signature = await crypto.subtle.sign("HMAC", key, enc.encode(message));
      return Array.from(new Uint8Array(signature)).map(b => b.toString(16).padStart(2, '0')).join('');
    }

    // Tạo query string an toàn, đúng thứ tự
    function buildQueryString(params) {
      return Object.entries(params)
        .sort()  // đảm bảo đúng thứ tự ký
        .map(([key, val]) => `${key}=${encodeURIComponent(val)}`)
        .join('&');
    }

    // Hàm gửi request signed
    async function binanceSignedRequest(apiKey, apiSecret, endpoint, baseUrl, extraParams = {}) {
      const timestamp = await getServerTime(baseUrl) - 500; // buffer chống lệch thời gian
      const queryObj = { ...extraParams, timestamp };
      const query = buildQueryString(queryObj);
      const signature = await hmacSHA256(apiSecret, query);
      const url = `${baseUrl}${endpoint}?${query}&signature=${signature}`;

      const res = await fetch(url, {
        headers: { 'X-MBX-APIKEY': apiKey }
      });

      const text = await res.text();
      if (!res.ok) throw new Error(`Lỗi Binance API: ${res.status} ${text}`);
      return JSON.parse(text);
    }

    // Gọi thử hàm
    async function testSigned() {
      try {
        const data = await binanceSignedRequest(
          apiKey,
          apiSecret,
          '/api/v3/account',
          baseUrl,
          {}
        );
        document.getElementById('result').innerText = JSON.stringify(data, null, 2);
      } catch (err) {
        document.getElementById('result').innerText = err.toString();
      }
    }
  </script>
</body>
</html>
